<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();
</script>








<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="编程,Spring," />





  <link rel="alternate" href="/atom.xml" title="Hui Yang's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/author.ico?v=5.1.0" />






<meta name="description" content="IoC容器和AOP是Spring的kernel(核心) IOC依赖控制反转：把控制权从具体业务对象手中转交到平台或框架中；依赖注入方式：接口注入、setter注入、构造器注入；在Spring IoC设计中，setter注入、构造器注入是最主要的注入方式；">
<meta name="keywords" content="编程,Spring">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring源码解读">
<meta property="og:url" content="http://yoursite.com/2017/10/10/Spring源码解读/index.html">
<meta property="og:site_name" content="Hui Yang&#39;s Blog">
<meta property="og:description" content="IoC容器和AOP是Spring的kernel(核心) IOC依赖控制反转：把控制权从具体业务对象手中转交到平台或框架中；依赖注入方式：接口注入、setter注入、构造器注入；在Spring IoC设计中，setter注入、构造器注入是最主要的注入方式；">
<meta property="og:image" content="http://yoursite.com/uploads/spring7.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/spring8.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/spring9.jpg">
<meta property="og:updated_time" content="2017-10-10T00:04:17.160Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring源码解读">
<meta name="twitter:description" content="IoC容器和AOP是Spring的kernel(核心) IOC依赖控制反转：把控制权从具体业务对象手中转交到平台或框架中；依赖注入方式：接口注入、setter注入、构造器注入；在Spring IoC设计中，setter注入、构造器注入是最主要的注入方式；">
<meta name="twitter:image" content="http://yoursite.com/uploads/spring7.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/10/10/Spring源码解读/"/>





  <title>Spring源码解读 | Hui Yang's Blog</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>
	<a href="https://github.com/hdyang12"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hui Yang's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/10/10/Spring源码解读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="杨辉">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/author.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui Yang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Spring源码解读</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-10T07:44:25+08:00">
                2017-10-10
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blog/" itemprop="url" rel="index">
                    <span itemprop="name">blog</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a class="cloud-tie-join-count" href="/2017/10/10/Spring源码解读/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count join-count" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2017/10/10/Spring源码解读/" class="leancloud_visitors" data-flag-title="Spring源码解读">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  10,556 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  55 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>IoC容器和AOP是Spring的kernel(核心)</p>
<h1 id="IOC"><a href="#IOC" class="headerlink" title="IOC"></a>IOC</h1><p><strong>依赖控制反转</strong>：把控制权从具体业务对象手中转交到平台或框架中；<br><strong>依赖注入方式</strong>：接口注入、setter注入、构造器注入；在Spring IoC设计中，setter注入、构造器注入是最主要的注入方式；<br>    <img src="/uploads/spring7.jpg" alt=""><br><a id="more"></a><br><strong>使用IoC容器步骤</strong>：</p>
<ol>
<li>创建IoC配置文件的抽象资源，这个抽象资源包含了BeanDefinition的定义信息。</li>
<li>创建一个BeanFactory，这里使用DefaultListableBeanFactory。</li>
<li>创建一个载入BeanDefinition的读取器，这里使用XmlBeanDefinitionReader来载入XML文件形式的BeanDefinition，通过一个回调配置给BeanFactory。</li>
<li>从定义好的资源位置读入配置信息，具体的解析过程由XmlBeanDefinitionReader来完成。完成整个载入和注册Bean定义之后，需要的IoC容器就建立起来了。这个时候就可以直接使用Ioc容器了。</li>
</ol>
<p><strong>IoC容器的启动</strong>：BeanDefinition的Resource<strong>定位</strong>、<strong>载入</strong>和<strong>注册</strong>。<br>IoC容器启动的过程中一般不包含Bean依赖注入的实现，在IoC的设计中Bean定义的载入和依赖注入是两个独立的过程。依赖注入一般发生在应用第一次通过getBean向容器索取Bean的时候。但是如果我们对某个Bean设置了lazyinit属性，那么这个Bean的依赖注入在IoC容器初始化时就预先完成了，不需要等到第一次使用getBean才触发。</p>
<p>通过以下代码作为入口来解析Spring源码：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">springTest</span> <span class="params">()</span> </span>&#123;</div><div class="line">		XmlBeanFactory bf = <span class="keyword">new</span> XmlBeanFactory(<span class="keyword">new</span> ClassPathResource(<span class="string">"beanFactory.xml"</span>));</div><div class="line">		SpringTest bean  = (SpringTest)bf.getBean(<span class="string">"springTest"</span>);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><p>ClassPathResource的创建<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> <span class="type">ClassPathResource</span>(<span class="string">"beanFactory.xml"</span>)</div><div class="line"></div><div class="line"><span class="built_in">this</span>(path, (ClassLoader) <span class="literal">null</span>);<span class="comment">//使用默认的classLoader</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> ClassPathResource(<span class="keyword">String</span> path, ClassLoader classLoader) &#123;</div><div class="line">           Assert.notNull(path, <span class="string">"Path must not be null"</span>);</div><div class="line">           <span class="keyword">String</span> pathToUse = StringUtils.cleanPath(path);</div><div class="line">           <span class="keyword">if</span> (pathToUse.startsWith(<span class="string">"/"</span>)) &#123;</div><div class="line">                pathToUse = pathToUse.substring(<span class="number">1</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="built_in">this</span>.path = pathToUse;</div><div class="line">           <span class="built_in">this</span>.classLoader = (classLoader != <span class="literal">null</span> ? classLoader : <span class="type">ClassUtils</span>.getDefaultClassLoader());</div><div class="line">     &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> XmlBeanFactory(<span class="keyword">new</span> ClassPathResource(<span class="string">"beanFactory.xml"</span>));</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">XmlBeanFactory</span><span class="params">(Resource resource)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">           <span class="keyword">this</span>(resource, <span class="keyword">null</span>);</div><div class="line">     &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">XmlBeanFactory</span><span class="params">(Resource resource, BeanFactory parentBeanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</div><div class="line">           <span class="keyword">super</span>(parentBeanFactory);<span class="comment">//goto DefaultListableBeanFactory</span></div><div class="line">           <span class="keyword">this</span>.reader.loadBeanDefinitions(resource);<span class="comment">//这个是核心，资源加载的真正实现</span></div><div class="line">     &#125;</div></pre></td></tr></table></figure>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//DefaultListableBeanFactory</span></div><div class="line"><span class="keyword">public</span> DefaultListableBeanFactory(BeanFactory parentBeanFactory) &#123;</div><div class="line">           <span class="keyword">super</span>(parentBeanFactory);<span class="comment">//goto AbstractAutowireCapableBeanFactory</span></div><div class="line">     &#125;</div><div class="line"></div><div class="line"><span class="comment">//AbstractAutowireCapableBeanFactory</span></div><div class="line"><span class="keyword">public</span> AbstractAutowireCapableBeanFactory(BeanFactory parentBeanFactory) &#123;</div><div class="line">           <span class="keyword">this</span>();<span class="comment">//这个也比较重要 goto AbstractAutowireCapableBeanFactory</span></div><div class="line">           setParentBeanFactory(parentBeanFactory);</div><div class="line">     &#125;</div><div class="line"></div><div class="line"><span class="comment">//AbstractAutowireCapableBeanFactory</span></div><div class="line"><span class="keyword">public</span> AbstractAutowireCapableBeanFactory() &#123;</div><div class="line">           <span class="keyword">super</span>();</div><div class="line">           <span class="comment">//忽略给定接口的自动装配功能</span></div><div class="line">           ignoreDependencyInterface(BeanNameAware.<span class="keyword">class</span>);</div><div class="line">           ignoreDependencyInterface(BeanFactoryAware.<span class="keyword">class</span>);</div><div class="line">           ignoreDependencyInterface(BeanClassLoaderAware.<span class="keyword">class</span>);</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
<p>当A中有属性B，那么当Spring在获取A的Bean的时候，如果B还没有初始化，那么Spring会自动初始化B，这也是Spring提供的一个重要特性。但是，某些情况下，B不会被初始化，其中一种情况就是B实现了BeanNameAware接口(自动装配时，忽略给定的依赖接口)。</p>
<p><strong>加载Bean</strong><br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//private final XmlBeanDefinitionReader reader = new XmlBeanDefinitionReader(this);</span></div><div class="line"><span class="keyword">this</span>.reader.loadBeanDefinitions(resource);  <span class="comment">//核心，资源加载的真正实现</span></div></pre></td></tr></table></figure></p>
<p>这句代码是整个资源加载的切入点：过程<br>1.封装资源文件    //new EncodedResource(resource)<br>2.获取输入流：从Resource中获取对应的InputStream并构造InputSource<br>3.通过构造的InputSource实例和Resource实例继续调用函数doLoadBeanDefinitions。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//XmlBeanDefinitionReader</span></div><div class="line">@<span class="function">Override</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span>(<span class="params">Resource resource</span>) throws BeanDefinitionStoreException &#123;</div><div class="line">     <span class="keyword">return</span> loadBeanDefinitions(<span class="keyword">new</span> EncodedResource(resource));  <span class="comment">//EncodedResource对资源文件的编码进行处理</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//XmlBeanDefinitionReader</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">loadBeanDefinitions</span>(<span class="params">EncodedResource encodedResource</span>) throws BeanDefinitionStoreException </span>&#123;</div><div class="line">       Assert.notNull(encodedResource, <span class="string">"EncodedResource must not be null"</span>);</div><div class="line">       <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</div><div class="line">            logger.info(<span class="string">"Loading XML bean definitions from "</span> + encodedResource.getResource());</div><div class="line">       &#125;</div><div class="line">       Set&lt;EncodedResource&gt; currentResources = <span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.<span class="keyword">get</span>();</div><div class="line">       <span class="keyword">if</span> (currentResources == <span class="literal">null</span>) &#123;</div><div class="line">            currentResources = <span class="keyword">new</span> HashSet&lt;EncodedResource&gt;(<span class="number">4</span>);</div><div class="line">            <span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.<span class="keyword">set</span>(currentResources);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (!currentResources.<span class="keyword">add</span>(encodedResource)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</div><div class="line">                       <span class="string">"Detected cyclic loading of "</span> + encodedResource + <span class="string">" - check your import definitions!"</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">            InputStream inputStream = encodedResource.getResource().getInputStream();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                 InputSource inputSource = <span class="keyword">new</span> InputSource(inputStream);</div><div class="line">                 <span class="keyword">if</span> (encodedResource.getEncoding() != <span class="literal">null</span>) &#123;</div><div class="line">                      inputSource.setEncoding(encodedResource.getEncoding());</div><div class="line">                 &#125;</div><div class="line">                 <span class="comment">//核心,从这儿继续往下看</span></div><div class="line">                 <span class="keyword">return</span> doLoadBeanDefinitions(inputSource, encodedResource.getResource());</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">finally</span> &#123;</div><div class="line">                 inputStream.close();</div><div class="line">            &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</div><div class="line">                       <span class="string">"IOException parsing XML document from "</span> + encodedResource.getResource(), ex);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">finally</span> &#123;</div><div class="line">            currentResources.<span class="keyword">remove</span>(encodedResource);</div><div class="line">            <span class="keyword">if</span> (currentResources.isEmpty()) &#123;</div><div class="line">                 <span class="keyword">this</span>.resourcesCurrentlyBeingLoaded.<span class="keyword">remove</span>();</div><div class="line">            &#125;</div><div class="line">       &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//XmlBeanDefinitionReader</span></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">int</span> <span class="title">doLoadBeanDefinitions</span><span class="params">(InputSource inputSource, Resource resource)</span></span></div><div class="line">                <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">//加载XML文件并得到对应的Document</span></div><div class="line">                Document doc = doLoadDocument(inputSource, resource); </div><div class="line">                <span class="comment">//根据返回的Document注册Bean信息</span></div><div class="line">                <span class="function"><span class="keyword">return</span> <span class="title">registerBeanDefinitions</span><span class="params">(doc, resource)</span></span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</div><div class="line">                <span class="keyword">throw</span> ex;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">catch</span> (SAXParseException ex) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> XmlBeanDefinitionStoreException(resource.getDescription(),</div><div class="line">                           <span class="string">"Line "</span> + ex.getLineNumber() + <span class="string">" in XML document from "</span> + resource + <span class="string">" is invalid"</span>, ex);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">catch</span> (SAXException ex) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> XmlBeanDefinitionStoreException(resource.getDescription(),</div><div class="line">                           <span class="string">"XML document from "</span> + resource + <span class="string">" is invalid"</span>, ex);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">catch</span> (ParserConfigurationException ex) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(resource.getDescription(),</div><div class="line">                           <span class="string">"Parser configuration exception parsing XML from "</span> + resource, ex);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(resource.getDescription(),</div><div class="line">                           <span class="string">"IOException parsing XML document from "</span> + resource, ex);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(resource.getDescription(),</div><div class="line">                           <span class="string">"Unexpected exception parsing XML document from "</span> + resource, ex);</div><div class="line">           &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line"><span class="comment">//XmlBeanDefinitionReader</span></div><div class="line"><span class="keyword">protected</span> <span class="function">Document <span class="title">doLoadDocument</span><span class="params">(InputSource inputSource, Resource resource)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">this</span>.documentLoader.loadDocument(inputSource, getEntityResolver(), <span class="keyword">this</span>.errorHandler,</div><div class="line">                     getValidationModeForResource(resource), isNamespaceAware());</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
<p>上述代码只做了3件事，支撑着Spring容器部分<strong>基础实现</strong>：<br>1.获取对XML文件的验证模式：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">getValidationModeForResource</span><span class="params">(resource)</span></span></div></pre></td></tr></table></figure></p>
<p>2.加载XML文件并得到对应的Document<br><figure class="highlight plain"><figcaption><span>doc = doLoadDocument(inputSource, resource);```</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">3.根据返回的Document注册Bean信息</div></pre></td></tr></table></figure></p>
<p>return registerBeanDefinitions(doc, resource);<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line">```</div><div class="line"><span class="comment">//对XML文件的验证</span></div><div class="line"><span class="comment">//XmlBeanDefinitionReader</span></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">int</span> <span class="title">getValidationModeForResource</span><span class="params">(Resource resource)</span> </span>&#123;</div><div class="line">      <span class="keyword">int</span> validationModeToUse = getValidationMode();</div><div class="line">      <span class="comment">//如果手动指定了验证模式,则使用指定的验证模式</span></div><div class="line">      <span class="keyword">if</span> (validationModeToUse != VALIDATION_AUTO) &#123;</div><div class="line">           <span class="keyword">return</span> validationModeToUse;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">//如果未指定则使用自动检测</span></div><div class="line">      <span class="keyword">int</span> detectedMode = detectValidationMode(resource);</div><div class="line">      <span class="keyword">if</span> (detectedMode != VALIDATION_AUTO) &#123;</div><div class="line">           <span class="keyword">return</span> detectedMode;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// Hmm, we didn't get a clear indication... Let's assume XSD,</span></div><div class="line">      <span class="comment">// since apparently no DTD declaration has been found up until</span></div><div class="line">      <span class="comment">// detection stopped (before finding the document's root tag).</span></div><div class="line">      <span class="keyword">return</span> VALIDATION_XSD;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//XmlBeanDefinitionReader</span></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">int</span> <span class="title">detectValidationMode</span><span class="params">(Resource resource)</span> </span>&#123;</div><div class="line">           <span class="keyword">if</span> (resource.isOpen()) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</div><div class="line">                           <span class="string">"Passed-in Resource ["</span> + resource + <span class="string">"] contains an open stream: "</span> +</div><div class="line">                           <span class="string">"cannot determine validation mode automatically. Either pass in a Resource "</span> +</div><div class="line">                           <span class="string">"that is able to create fresh streams, or explicitly specify the validationMode "</span> +</div><div class="line">                           <span class="string">"on your XmlBeanDefinitionReader instance."</span>);</div><div class="line">           &#125;</div><div class="line">           InputStream inputStream;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">                inputStream = resource.getInputStream();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</div><div class="line">                           <span class="string">"Unable to determine validation mode for ["</span> + resource + <span class="string">"]: cannot open InputStream. "</span> +</div><div class="line">                           <span class="string">"Did you attempt to load directly from a SAX InputSource without specifying the "</span> +</div><div class="line">                           <span class="string">"validationMode on your XmlBeanDefinitionReader instance?"</span>, ex);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.validationModeDetector.detectValidationMode(inputStream);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">catch</span> (IOException ex) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(<span class="string">"Unable to determine validation mode for ["</span> +</div><div class="line">                           resource + <span class="string">"]: an error occurred whilst reading from the InputStream."</span>, ex);</div><div class="line">           &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line"><span class="comment">//XmlValidationModeDetector</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">int</span> <span class="title">detectValidationMode</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">           <span class="comment">// Peek into the file to look for DOCTYPE.</span></div><div class="line">           BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(inputStream));</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">boolean</span> isDtdValidated = <span class="keyword">false</span>;</div><div class="line">                String content;</div><div class="line">                <span class="keyword">while</span> ((content = reader.readLine()) != <span class="keyword">null</span>) &#123;</div><div class="line">                     content = consumeCommentTokens(content);</div><div class="line">                     <span class="comment">//如果读取的行是空或注释则略过</span></div><div class="line">                     <span class="keyword">if</span> (<span class="keyword">this</span>.inComment || !StringUtils.hasText(content)) &#123;</div><div class="line">                           <span class="keyword">continue</span>;</div><div class="line">                     &#125;</div><div class="line">                     <span class="keyword">if</span> (hasDoctype(content)) &#123;</div><div class="line">                           isDtdValidated = <span class="keyword">true</span>;</div><div class="line">                           <span class="keyword">break</span>;</div><div class="line">                     &#125;</div><div class="line">                     <span class="keyword">if</span> (hasOpeningTag(content)) &#123;</div><div class="line">                           <span class="comment">// End of meaningful data...</span></div><div class="line">                           <span class="keyword">break</span>;</div><div class="line">                     &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> (isDtdValidated ? VALIDATION_DTD : VALIDATION_XSD);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">catch</span> (CharConversionException ex) &#123;</div><div class="line">                <span class="comment">// Choked on some character encoding...</span></div><div class="line">                <span class="comment">// Leave the decision up to the caller.</span></div><div class="line">                <span class="keyword">return</span> VALIDATION_AUTO;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">finally</span> &#123;</div><div class="line">                reader.close();</div><div class="line">           &#125;</div><div class="line">     &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//加载XML文件并得到对应的Document</span></div><div class="line"><span class="comment">//DefaultDocumentLoader</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="function">Document <span class="title">loadDocument</span><span class="params">(InputSource inputSource, EntityResolver entityResolver,</span></span></div><div class="line">           ErrorHandler errorHandler, <span class="keyword">int</span> validationMode, <span class="keyword">boolean</span> namespaceAware) <span class="keyword">throws</span> Exception &#123;</div><div class="line">      DocumentBuilderFactory factory = createDocumentBuilderFactory(validationMode, namespaceAware);</div><div class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">           logger.debug(<span class="string">"Using JAXP provider ["</span> + factory.getClass().getName() + <span class="string">"]"</span>);</div><div class="line">      &#125;</div><div class="line">      DocumentBuilder builder = createDocumentBuilder(factory, entityResolver, errorHandler);</div><div class="line">      <span class="function"><span class="keyword">return</span> builder.<span class="title">parse</span><span class="params">(inputSource)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//根据返回的Document注册Bean信息</span></div><div class="line"><span class="comment">//XmlBeanDefinitionReader</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">registerBeanDefinitions</span>(<span class="params">Document doc, Resource resource</span>) throws BeanDefinitionStoreException </span>&#123;</div><div class="line">      <span class="comment">//使用BeanDefinitionDocumentReader实例化BeanDefinitionDocumentReader</span></div><div class="line">      BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader();</div><div class="line">      <span class="keyword">int</span> countBefore = getRegistry().getBeanDefinitionCount();</div><div class="line">      <span class="comment">//加载及注册bean</span></div><div class="line">      documentReader.registerBeanDefinitions(doc, createReaderContext(resource));</div><div class="line">      <span class="comment">//记录本次加载的BeanDefinition个数</span></div><div class="line">      <span class="keyword">return</span> getRegistry().getBeanDefinitionCount() - countBefore;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//DefaultBeanDefinitionDocumentReader</span></div><div class="line">@<span class="function">Override</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span>(<span class="params">Document doc, XmlReaderContext readerContext</span>) &#123;</div><div class="line">      <span class="keyword">this</span>.readerContext = readerContext;</div><div class="line">      logger.debug(<span class="string">"Loading bean definitions"</span>);</div><div class="line">      Element root = doc.getDocumentElement();</div><div class="line">      <span class="comment">//核心逻辑的底部</span></div><div class="line">      doRegisterBeanDefinitions(root);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//DefaultBeanDefinitionDocumentReader</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegisterBeanDefinitions</span>(<span class="params">Element root</span>) </span>&#123;</div><div class="line">      <span class="comment">// Any nested &lt;beans&gt; elements will cause recursion in this method. In</span></div><div class="line">      <span class="comment">// order to propagate and preserve &lt;beans&gt; default-* attributes correctly,</span></div><div class="line">      <span class="comment">// keep track of the current (parent) delegate, which may be null. Create</span></div><div class="line">      <span class="comment">// the new (child) delegate with a reference to the parent for fallback purposes,</span></div><div class="line">      <span class="comment">// then ultimately reset this.delegate back to its original (parent) reference.</span></div><div class="line">      <span class="comment">// this behavior emulates a stack of delegates without actually necessitating one.</span></div><div class="line">      BeanDefinitionParserDelegate parent = <span class="keyword">this</span>.<span class="keyword">delegate</span>;</div><div class="line">      <span class="keyword">this</span>.<span class="keyword">delegate</span> = createDelegate(getReaderContext(), root, parent);</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.<span class="keyword">delegate</span>.isDefaultNamespace(root)) &#123;</div><div class="line">           String profileSpec = root.getAttribute(PROFILE_ATTRIBUTE);</div><div class="line">           <span class="keyword">if</span> (StringUtils.hasText(profileSpec)) &#123;</div><div class="line">                String[] specifiedProfiles = StringUtils.tokenizeToStringArray(</div><div class="line">                           profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</div><div class="line">                <span class="keyword">if</span> (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123;</div><div class="line">                      <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</div><div class="line">                           logger.info(<span class="string">"Skipped XML bean definition file due to specified profiles ["</span> + profileSpec +</div><div class="line">                                      <span class="string">"] not matching: "</span> + getReaderContext().getResource());</div><div class="line">                      &#125;</div><div class="line">                      <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">      &#125;</div><div class="line">      preProcessXml(root);</div><div class="line">      <span class="comment">//解析并注册BeanDefinitions</span></div><div class="line">      parseBeanDefinitions(root, <span class="keyword">this</span>.<span class="keyword">delegate</span>);</div><div class="line">      postProcessXml(root);</div><div class="line">      <span class="keyword">this</span>.<span class="keyword">delegate</span> = parent;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//DefaultBeanDefinitionDocumentReader</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parseBeanDefinitions</span>(<span class="params">Element root, BeanDefinitionParserDelegate <span class="keyword">delegate</span></span>) </span>&#123;</div><div class="line">		<span class="keyword">if</span> (<span class="keyword">delegate</span>.isDefaultNamespace(root)) &#123;<span class="comment">//默认标签</span></div><div class="line">			NodeList nl = root.getChildNodes();</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</div><div class="line">				Node node = nl.item(i);</div><div class="line">				<span class="keyword">if</span> (node instanceof Element) &#123;</div><div class="line">					Element ele = (Element) node;</div><div class="line">					<span class="keyword">if</span> (<span class="keyword">delegate</span>.isDefaultNamespace(ele)) &#123;</div><div class="line">					    <span class="comment">//默认标签的核心</span></div><div class="line">						parseDefaultElement(ele, <span class="keyword">delegate</span>);</div><div class="line">					&#125;</div><div class="line">					<span class="keyword">else</span> &#123;</div><div class="line">						<span class="keyword">delegate</span>.parseCustomElement(ele);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;<span class="comment">//自定义标签</span></div><div class="line">			<span class="keyword">delegate</span>.parseCustomElement(root);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line"><span class="comment">//DefaultBeanDefinitionDocumentReader</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseDefaultElement</span>(<span class="params">Element ele, BeanDefinitionParserDelegate <span class="keyword">delegate</span></span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">delegate</span>.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;</div><div class="line">        importBeanDefinitionResource(ele);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">delegate</span>.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;</div><div class="line">        processAliasRegistration(ele);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">delegate</span>.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;<span class="comment">//Bean标签的解析及注册;只讲这块的代码</span></div><div class="line">        processBeanDefinition(ele, <span class="keyword">delegate</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">delegate</span>.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;</div><div class="line">        <span class="comment">// recurse</span></div><div class="line">        doRegisterBeanDefinitions(ele);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//DefaultBeanDefinitionDocumentReader</span></div><div class="line"><span class="comment">//Bean标签的解析及注册：对Bean标签的解析最为复杂也最为重要</span></div><div class="line">     <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processBeanDefinition</span>(<span class="params">Element ele, BeanDefinitionParserDelegate <span class="keyword">delegate</span></span>) </span>&#123;</div><div class="line">           <span class="comment">//元素解析,class、name、id等</span></div><div class="line">           BeanDefinitionHolder bdHolder = <span class="keyword">delegate</span>.parseBeanDefinitionElement(ele);</div><div class="line">           <span class="keyword">if</span> (bdHolder != <span class="literal">null</span>) &#123;</div><div class="line">                <span class="comment">//对自定义标签解析</span></div><div class="line">                bdHolder = <span class="keyword">delegate</span>.decorateBeanDefinitionIfRequired(ele, bdHolder);</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                     <span class="comment">// Register the final decorated instance.</span></div><div class="line">                    <span class="comment">//对解析后的 bdHolder进行注册</span></div><div class="line">                    BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</div><div class="line">                     getReaderContext().error(<span class="string">"Failed to register bean definition with name '"</span> +</div><div class="line">                                bdHolder.getBeanName() + <span class="string">"'"</span>, ele, ex);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// Send registration event.</span></div><div class="line">                <span class="comment">//发出响应事件</span></div><div class="line">                getReaderContext().fireComponentRegistered(<span class="keyword">new</span> BeanComponentDefinition(bdHolder));</div><div class="line">           &#125;</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
<p><strong>过程</strong>：</p>
<ol>
<li>首先委托<code>BeanDefinitionParserDelegate</code>类的<code>parseBeanDefinitionElement</code>方法进行元素解析，返回<code>BeanDefinitionHolder</code>类型的实例<code>bdHolder</code>，经过这个方法后，<code>bdHolder</code>实例已经包含我们配置文件中配置的各种属性了，例如<code>class</code>、<code>name</code>、<code>id</code>之类的属性。</li>
<li>当返回的<code>bdHolder</code>不为空的情况下若存在默认标签的子节点下再有自定义属性，还需要再次对自定义标签进行解析。</li>
<li>解析完成后，需要对解析后的 <code>bdHolder</code>进行注册，同样注册操作委托给了<code>BeanDefinitionReaderUtils</code>的<code>registerBeanDefinition</code>方法。</li>
<li>最后发出响应事件，通知相关的监听器，这个<code>bean</code>已经加载完成了：<code>fireComponentRegistered</code>。</li>
</ol>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">//<span class="keyword">BeanDefinitionParserDelegate</span></div><div class="line"><span class="symbol">public</span> <span class="keyword">BeanDefinitionHolder </span>parseBeanDefinitionElement(Element ele) &#123;</div><div class="line">           return parseBeanDefinitionElement(ele, null)<span class="comment">;</span></div><div class="line">     &#125;</div><div class="line"></div><div class="line">//<span class="keyword">BeanDefinitionParserDelegate</span></div><div class="line"><span class="symbol">public</span> <span class="keyword">BeanDefinitionHolder </span>parseBeanDefinitionElement(Element ele, <span class="keyword">BeanDefinition </span>containingBean) &#123;</div><div class="line">           //解析id属性</div><div class="line">           <span class="keyword">String </span>id = ele.getAttribute(ID_ATTRIBUTE)<span class="comment">;</span></div><div class="line">           //解析name属性</div><div class="line">           <span class="keyword">String </span>nameAttr = ele.getAttribute(NAME_ATTRIBUTE)<span class="comment">;</span></div><div class="line">           //分割name属性</div><div class="line">           List&lt;<span class="keyword">String&gt; </span>aliases = new ArrayList&lt;<span class="keyword">String&gt;();</span></div><div class="line">           <span class="meta">if</span> (<span class="keyword">StringUtils.hasLength(nameAttr)) </span>&#123;</div><div class="line">                <span class="keyword">String[] </span>nameArr = <span class="keyword">StringUtils.tokenizeToStringArray(nameAttr, </span><span class="keyword">MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span></div><div class="line">                aliases.<span class="keyword">addAll(Arrays.asList(nameArr));</span></div><div class="line">           &#125;</div><div class="line">           <span class="keyword">String </span><span class="keyword">beanName </span>= id<span class="comment">;</span></div><div class="line">           <span class="meta">if</span> (!<span class="keyword">StringUtils.hasText(beanName) </span>&amp;&amp; !aliases.isEmpty()) &#123;</div><div class="line">                <span class="keyword">beanName </span>= aliases.remove(<span class="number">0</span>)<span class="comment">;</span></div><div class="line">                <span class="meta">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">                     logger.debug(<span class="string">"No XML 'id' specified - using '"</span> + <span class="keyword">beanName </span>+</div><div class="line">                                <span class="string">"' as bean name and "</span> + aliases + <span class="string">" as aliases"</span>)<span class="comment">;</span></div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="meta">if</span> (containingBean == null) &#123;</div><div class="line">                checkNameUniqueness(<span class="keyword">beanName, </span>aliases, ele)<span class="comment">;</span></div><div class="line">           &#125;</div><div class="line">           //解析默认元素，下面贴出这块代码</div><div class="line">           AbstractBeanDefinition <span class="keyword">beanDefinition </span>= parseBeanDefinitionElement(ele, <span class="keyword">beanName, </span>containingBean)<span class="comment">;</span></div><div class="line">           <span class="meta">if</span> (<span class="keyword">beanDefinition </span>!= null) &#123;</div><div class="line">                <span class="meta">if</span> (!<span class="keyword">StringUtils.hasText(beanName)) </span>&#123;</div><div class="line">                     try &#123;</div><div class="line">                           //如果不存在<span class="keyword">BeanName，那么根据Spring中提供的命名规则为当前Bean生成对应的beanName</span></div><div class="line">                           <span class="meta">if</span> (containingBean != null) &#123;</div><div class="line">                                <span class="keyword">beanName </span>= <span class="keyword">BeanDefinitionReaderUtils.generateBeanName(</span></div><div class="line">                                           <span class="keyword">beanDefinition, </span>this.readerContext.getRegistry(), true)<span class="comment">;</span></div><div class="line">                           &#125;</div><div class="line">                           <span class="meta">else</span> &#123;</div><div class="line">                                <span class="keyword">beanName </span>= this.readerContext.generateBeanName(<span class="keyword">beanDefinition);</span></div><div class="line">                                // Register an <span class="meta">alias</span> for the plain <span class="keyword">bean </span>class name, <span class="meta">if</span> still possible,</div><div class="line">                                // <span class="meta">if</span> the generator returned the class name plus a suffix.</div><div class="line">                                // This is expected for Spring <span class="number">1</span>.<span class="number">2</span>/<span class="number">2</span>.<span class="number">0</span> <span class="keyword">backwards </span>compatibility.</div><div class="line">                                <span class="keyword">String </span><span class="keyword">beanClassName </span>= <span class="keyword">beanDefinition.getBeanClassName();</span></div><div class="line">                                <span class="meta">if</span> (<span class="keyword">beanClassName </span>!= null &amp;&amp;</div><div class="line">                                          <span class="keyword">beanName.startsWith(beanClassName) </span>&amp;&amp; <span class="keyword">beanName.length() </span>&gt; <span class="keyword">beanClassName.length() </span>&amp;&amp;</div><div class="line">                                          !this.readerContext.getRegistry().<span class="keyword">isBeanNameInUse(beanClassName)) </span>&#123;</div><div class="line">                                     aliases.<span class="keyword">add(beanClassName);</span></div><div class="line">                                &#125;</div><div class="line">                           &#125;</div><div class="line">                           <span class="meta">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">                                logger.debug(<span class="string">"Neither XML 'id' nor 'name' specified - "</span> +</div><div class="line">                                           <span class="string">"using generated bean name ["</span> + <span class="keyword">beanName </span>+ <span class="string">"]"</span>)<span class="comment">;</span></div><div class="line">                           &#125;</div><div class="line">                     &#125;</div><div class="line">                     catch (Exception ex) &#123;</div><div class="line">                           error(ex.getMessage(), ele)<span class="comment">;</span></div><div class="line">                           return null<span class="comment">;</span></div><div class="line">                     &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">String[] </span>aliasesArray = <span class="keyword">StringUtils.toStringArray(aliases);</span></div><div class="line">                return new <span class="keyword">BeanDefinitionHolder(beanDefinition, </span><span class="keyword">beanName, </span>aliasesArray)<span class="comment">;</span></div><div class="line">           &#125;</div><div class="line">           return null<span class="comment">;</span></div><div class="line">     &#125;</div></pre></td></tr></table></figure>
<ol>
<li>提取元素中的id以及name属性。</li>
<li>进一步解析其他所有属性并统一封装至GenericBeanDefinition类型的实例中。</li>
<li>如果检测到bean没有beanName，那么使用默认规则为此bean生成beanName。</li>
<li>将获取到的信息封装到BeanDefinitionHolder实例中。<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//BeanDefinitionParserDelegate</span></div><div class="line"><span class="keyword">public</span> <span class="function">AbstractBeanDefinition <span class="title">parseBeanDefinitionElement</span><span class="params">(</span></span></div><div class="line">                Element ele, String beanName, BeanDefinition containingBean) &#123;</div><div class="line">           <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> BeanEntry(beanName));</div><div class="line">           String className = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">if</span> (ele.hasAttribute(CLASS_ATTRIBUTE)) &#123;</div><div class="line">                className = ele.getAttribute(CLASS_ATTRIBUTE).trim();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">                String parent = <span class="keyword">null</span>;</div><div class="line">                <span class="comment">//如果有parent属性，就拿到parent属性</span></div><div class="line">                <span class="keyword">if</span> (ele.hasAttribute(PARENT_ATTRIBUTE)) &#123;</div><div class="line">                     parent = ele.getAttribute(PARENT_ATTRIBUTE);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//创建用于承载属性的AbstractBeanDefinition类型的GenericBeanDefinition</span></div><div class="line">                AbstractBeanDefinition bd = createBeanDefinition(className, parent);</div><div class="line"></div><div class="line">                <span class="comment">//对element所有元素属性进行解析</span></div><div class="line">                parseBeanDefinitionAttributes(ele, beanName, containingBean, bd);</div><div class="line">                bd.setDescription(DomUtils.getChildElementValueByTagName(ele, DESCRIPTION_ELEMENT));</div><div class="line"></div><div class="line">                <span class="comment">//解析元数据</span></div><div class="line">                parseMetaElements(ele, bd);</div><div class="line">                <span class="comment">//解析lookup-method属性</span></div><div class="line">                parseLookupOverrideSubElements(ele, bd.getMethodOverrides());</div><div class="line">                <span class="comment">//replaced-method属性</span></div><div class="line">                parseReplacedMethodSubElements(ele, bd.getMethodOverrides());</div><div class="line"></div><div class="line">                <span class="comment">//解析构造函数参数</span></div><div class="line">                parseConstructorArgElements(ele, bd);</div><div class="line">                <span class="comment">//解析property子元素</span></div><div class="line">                parsePropertyElements(ele, bd);</div><div class="line">                <span class="comment">//解析qualifier子元素</span></div><div class="line">                parseQualifierElements(ele, bd);</div><div class="line">                bd.setResource(<span class="keyword">this</span>.readerContext.getResource());</div><div class="line">                bd.setSource(extractSource(ele));</div><div class="line">                <span class="keyword">return</span> bd;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</div><div class="line">                <span class="keyword">error</span>(<span class="string">"Bean class ["</span> + className + <span class="string">"] not found"</span>, ele, ex);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">catch</span> (NoClassDefFoundError err) &#123;</div><div class="line">                <span class="keyword">error</span>(<span class="string">"Class that bean class ["</span> + className + <span class="string">"] depends on not found"</span>, ele, err);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">                <span class="keyword">error</span>(<span class="string">"Unexpected failure during bean definition parsing"</span>, ele, ex);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">finally</span> &#123;</div><div class="line">                <span class="keyword">this</span>.parseState.pop();</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>Spring通过BeanDefinition将配置文件中的<bean>配置信息转换为容器的内部表示，并将这些BeanDefinition注册到BeanDefinitionRegistry中。Spring容器的BeanDefinitionRegistry就像是Spring配置信息的内存数据库，主要以map的形式保存，后续操作直接从BeanDefinitionRegistry读取配置信息。<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line">//<span class="keyword">BeanDefinitionParserDelegate</span></div><div class="line">//对element所有元素属性进行解析</div><div class="line"><span class="symbol">public</span> AbstractBeanDefinition parseBeanDefinitionAttributes(Element ele, <span class="keyword">String </span><span class="keyword">beanName,</span></div><div class="line">                <span class="keyword">BeanDefinition </span>containingBean, AbstractBeanDefinition <span class="keyword">bd) </span>&#123;</div><div class="line">           <span class="meta">if</span> (ele.hasAttribute(SINGLETON_ATTRIBUTE)) &#123;</div><div class="line">                error(<span class="string">"Old 1.x 'singleton' attribute in use - upgrade to 'scope' declaration"</span>, ele)<span class="comment">;</span></div><div class="line">           &#125;</div><div class="line">           <span class="meta">else</span> <span class="meta">if</span> (ele.hasAttribute(SCOPE_ATTRIBUTE)) &#123;</div><div class="line">                <span class="keyword">bd.setScope(ele.getAttribute(SCOPE_ATTRIBUTE));</span></div><div class="line">           &#125;</div><div class="line">           <span class="meta">else</span> <span class="meta">if</span> (containingBean != null) &#123;</div><div class="line">                // Take default from containing <span class="keyword">bean </span>in case of an inner <span class="keyword">bean </span>definition.</div><div class="line">                <span class="keyword">bd.setScope(containingBean.getScope());</span></div><div class="line">           &#125;</div><div class="line">           <span class="meta">if</span> (ele.hasAttribute(ABSTRACT_ATTRIBUTE)) &#123;</div><div class="line">                <span class="keyword">bd.setAbstract(TRUE_VALUE.equals(ele.getAttribute(ABSTRACT_ATTRIBUTE)));</span></div><div class="line">           &#125;</div><div class="line">           <span class="keyword">String </span>lazyInit = ele.getAttribute(LAZY_INIT_ATTRIBUTE)<span class="comment">;</span></div><div class="line">           <span class="meta">if</span> (DEFAULT_VALUE.equals(lazyInit)) &#123;</div><div class="line">                lazyInit = this.defaults.getLazyInit()<span class="comment">;</span></div><div class="line">           &#125;</div><div class="line">           <span class="keyword">bd.setLazyInit(TRUE_VALUE.equals(lazyInit));</span></div><div class="line">           <span class="keyword">String </span>autowire = ele.getAttribute(AUTOWIRE_ATTRIBUTE)<span class="comment">;</span></div><div class="line">           <span class="keyword">bd.setAutowireMode(getAutowireMode(autowire));</span></div><div class="line">           <span class="keyword">String </span>dependencyCheck = ele.getAttribute(DEPENDENCY_CHECK_ATTRIBUTE)<span class="comment">;</span></div><div class="line">          <span class="keyword">bd.setDependencyCheck(getDependencyCheck(dependencyCheck));</span></div><div class="line">           <span class="meta">if</span> (ele.hasAttribute(DEPENDS_ON_ATTRIBUTE)) &#123;</div><div class="line">                <span class="keyword">String </span>dependsOn = ele.getAttribute(DEPENDS_ON_ATTRIBUTE)<span class="comment">;</span></div><div class="line">                <span class="keyword">bd.setDependsOn(StringUtils.tokenizeToStringArray(dependsOn, </span><span class="keyword">MULTI_VALUE_ATTRIBUTE_DELIMITERS));</span></div><div class="line">           &#125;</div><div class="line">           <span class="keyword">String </span>autowireCandidate = ele.getAttribute(AUTOWIRE_CANDIDATE_ATTRIBUTE)<span class="comment">;</span></div><div class="line">           <span class="meta">if</span> (<span class="string">""</span>.equals(autowireCandidate) <span class="title">||</span> DEFAULT_VALUE.equals(autowireCandidate)) &#123;</div><div class="line">                <span class="keyword">String </span>candidatePattern = this.defaults.getAutowireCandidates()<span class="comment">;</span></div><div class="line">                <span class="meta">if</span> (candidatePattern != null) &#123;</div><div class="line">                     <span class="keyword">String[] </span>patterns = <span class="keyword">StringUtils.commaDelimitedListToStringArray(candidatePattern);</span></div><div class="line">                     <span class="keyword">bd.setAutowireCandidate(PatternMatchUtils.simpleMatch(patterns, </span><span class="keyword">beanName));</span></div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="meta">else</span> &#123;</div><div class="line">                <span class="keyword">bd.setAutowireCandidate(TRUE_VALUE.equals(autowireCandidate));</span></div><div class="line">           &#125;</div><div class="line">           <span class="meta">if</span> (ele.hasAttribute(PRIMARY_ATTRIBUTE)) &#123;</div><div class="line">                <span class="keyword">bd.setPrimary(TRUE_VALUE.equals(ele.getAttribute(PRIMARY_ATTRIBUTE)));</span></div><div class="line">           &#125;</div><div class="line">           <span class="meta">if</span> (ele.hasAttribute(INIT_METHOD_ATTRIBUTE)) &#123;</div><div class="line">                <span class="keyword">String </span>initMethodName = ele.getAttribute(INIT_METHOD_ATTRIBUTE)<span class="comment">;</span></div><div class="line">                <span class="meta">if</span> (!<span class="string">""</span>.equals(initMethodName)) &#123;</div><div class="line">                     <span class="keyword">bd.setInitMethodName(initMethodName);</span></div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="meta">else</span> &#123;</div><div class="line">                <span class="meta">if</span> (this.defaults.getInitMethod() != null) &#123;</div><div class="line">                     <span class="keyword">bd.setInitMethodName(this.defaults.getInitMethod());</span></div><div class="line">                     <span class="keyword">bd.setEnforceInitMethod(false);</span></div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="meta">if</span> (ele.hasAttribute(DESTROY_METHOD_ATTRIBUTE)) &#123;</div><div class="line">                <span class="keyword">String </span>destroyMethodName = ele.getAttribute(DESTROY_METHOD_ATTRIBUTE)<span class="comment">;</span></div><div class="line">                <span class="keyword">bd.setDestroyMethodName(destroyMethodName);</span></div><div class="line">           &#125;</div><div class="line">           <span class="meta">else</span> &#123;</div><div class="line">                <span class="meta">if</span> (this.defaults.getDestroyMethod() != null) &#123;</div><div class="line">                     <span class="keyword">bd.setDestroyMethodName(this.defaults.getDestroyMethod());</span></div><div class="line">                     <span class="keyword">bd.setEnforceDestroyMethod(false);</span></div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="meta">if</span> (ele.hasAttribute(FACTORY_METHOD_ATTRIBUTE)) &#123;</div><div class="line">                <span class="keyword">bd.setFactoryMethodName(ele.getAttribute(FACTORY_METHOD_ATTRIBUTE));</span></div><div class="line">           &#125;</div><div class="line">           <span class="meta">if</span> (ele.hasAttribute(FACTORY_BEAN_ATTRIBUTE)) &#123;</div><div class="line">                <span class="keyword">bd.setFactoryBeanName(ele.getAttribute(FACTORY_BEAN_ATTRIBUTE));</span></div><div class="line">           &#125;</div><div class="line">           return <span class="keyword">bd;</span></div><div class="line">     &#125;</div></pre></td></tr></table></figure></bean></p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//BeanDefinitionParserDelegate</span></div><div class="line"><span class="comment">//对构造函数的解析</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">parseConstructorArgElements</span><span class="params">(Element beanEle, BeanDefinition bd)</span> </span>&#123;</div><div class="line">           NodeList nl = beanEle.getChildNodes();</div><div class="line">           <span class="comment">//这里有个遍历，对每个构造器参数都解析并放到bd 中</span></div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</div><div class="line">                Node node = nl.item(i);</div><div class="line">                <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, CONSTRUCTOR_ARG_ELEMENT)) &#123;</div><div class="line">                     parseConstructorArgElement((Element) node, bd);</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line"><span class="comment">//BeanDefinitionParserDelegate</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">parseConstructorArgElement</span><span class="params">(Element ele, BeanDefinition bd)</span> </span>&#123;</div><div class="line">           <span class="comment">//提取index属性</span></div><div class="line">           String indexAttr = ele.getAttribute(INDEX_ATTRIBUTE);</div><div class="line">           <span class="comment">//提取type属性</span></div><div class="line">           String typeAttr = ele.getAttribute(TYPE_ATTRIBUTE);</div><div class="line">           <span class="comment">//提取name属性</span></div><div class="line">           String nameAttr = ele.getAttribute(NAME_ATTRIBUTE);</div><div class="line">           <span class="keyword">if</span> (StringUtils.hasLength(indexAttr)) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                     <span class="keyword">int</span> index = Integer.parseInt(indexAttr);</div><div class="line">                     <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</div><div class="line">                           <span class="keyword">error</span>(<span class="string">"'index' cannot be lower than 0"</span>, ele);</div><div class="line">                     &#125;</div><div class="line">                     <span class="keyword">else</span> &#123;</div><div class="line">                           <span class="keyword">try</span> &#123;</div><div class="line">                                <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> ConstructorArgumentEntry(index));</div><div class="line">                                <span class="comment">//对构造函数中子元素的解析</span></div><div class="line">                                Object value = parsePropertyValue(ele, bd, <span class="keyword">null</span>);</div><div class="line">                                ConstructorArgumentValues.ValueHolder valueHolder = <span class="keyword">new</span> ConstructorArgumentValues.ValueHolder(value);</div><div class="line">                                <span class="keyword">if</span> (StringUtils.hasLength(typeAttr)) &#123;</div><div class="line">                                     valueHolder.setType(typeAttr);</div><div class="line">                                &#125;</div><div class="line">                                <span class="keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;</div><div class="line">                                     valueHolder.setName(nameAttr);</div><div class="line">                                &#125;</div><div class="line">                                valueHolder.setSource(extractSource(ele));</div><div class="line">                                <span class="keyword">if</span> (bd.getConstructorArgumentValues().hasIndexedArgumentValue(index)) &#123;</div><div class="line">                                     <span class="keyword">error</span>(<span class="string">"Ambiguous constructor-arg entries for index "</span> + index, ele);</div><div class="line">                                &#125;</div><div class="line">                                <span class="keyword">else</span> &#123;</div><div class="line">                                     bd.getConstructorArgumentValues().addIndexedArgumentValue(index, valueHolder);</div><div class="line">                                &#125;</div><div class="line">                           &#125;</div><div class="line">                           <span class="keyword">finally</span> &#123;</div><div class="line">                                <span class="keyword">this</span>.parseState.pop();</div><div class="line">                           &#125;</div><div class="line">                     &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">catch</span> (NumberFormatException ex) &#123;</div><div class="line">                     <span class="keyword">error</span>(<span class="string">"Attribute 'index' of tag 'constructor-arg' must be an integer"</span>, ele);</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                     <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> ConstructorArgumentEntry());</div><div class="line">                     Object value = parsePropertyValue(ele, bd, <span class="keyword">null</span>);</div><div class="line">                     ConstructorArgumentValues.ValueHolder valueHolder = <span class="keyword">new</span> ConstructorArgumentValues.ValueHolder(value);</div><div class="line">                     <span class="keyword">if</span> (StringUtils.hasLength(typeAttr)) &#123;</div><div class="line">                           valueHolder.setType(typeAttr);</div><div class="line">                     &#125;</div><div class="line">                     <span class="keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;</div><div class="line">                           valueHolder.setName(nameAttr);</div><div class="line">                     &#125;</div><div class="line">                     valueHolder.setSource(extractSource(ele));</div><div class="line">                     bd.getConstructorArgumentValues().addGenericArgumentValue(valueHolder);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">finally</span> &#123;</div><div class="line">                     <span class="keyword">this</span>.parseState.pop();</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">     &#125;</div><div class="line"></div><div class="line"><span class="comment">//BeanDefinitionParserDelegate</span></div><div class="line"><span class="comment">//对构造函数中子元素的解析：</span></div><div class="line">     <span class="keyword">public</span> <span class="function">Object <span class="title">parsePropertyValue</span><span class="params">(Element ele, BeanDefinition bd, String propertyName)</span> </span>&#123;</div><div class="line">           String elementName = (propertyName != <span class="keyword">null</span>) ?</div><div class="line">                                <span class="string">"&lt;property&gt; element for property '"</span> + propertyName + <span class="string">"'"</span> :</div><div class="line">                                <span class="string">"&lt;constructor-arg&gt; element"</span>;</div><div class="line">           <span class="comment">// Should only have one child element: ref, value, list, etc.</span></div><div class="line">           NodeList nl = ele.getChildNodes();</div><div class="line">           Element subElement = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</div><div class="line">                Node node = nl.item(i);</div><div class="line">                <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element &amp;&amp; !nodeNameEquals(node, DESCRIPTION_ELEMENT) &amp;&amp;</div><div class="line">                           !nodeNameEquals(node, META_ELEMENT)) &#123;</div><div class="line">                     <span class="comment">// Child element is what we're looking for.</span></div><div class="line">                     <span class="comment">// 一个属性只能对应一种类型:ref、value、list等</span></div><div class="line">                     <span class="keyword">if</span> (subElement != <span class="keyword">null</span>) &#123;</div><div class="line">                           <span class="keyword">error</span>(elementName + <span class="string">" must not contain more than one sub-element"</span>, ele);</div><div class="line">                     &#125;</div><div class="line">                     <span class="keyword">else</span> &#123;</div><div class="line">                           subElement = (Element) node;</div><div class="line">                     &#125;</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">boolean</span> hasRefAttribute = ele.hasAttribute(REF_ATTRIBUTE);</div><div class="line">           <span class="keyword">boolean</span> hasValueAttribute = ele.hasAttribute(VALUE_ATTRIBUTE);</div><div class="line">           <span class="keyword">if</span> ((hasRefAttribute &amp;&amp; hasValueAttribute) ||</div><div class="line">                     ((hasRefAttribute || hasValueAttribute) &amp;&amp; subElement != <span class="keyword">null</span>)) &#123;</div><div class="line">                <span class="keyword">error</span>(elementName +</div><div class="line">                           <span class="string">" is only allowed to contain either 'ref' attribute OR 'value' attribute OR sub-element"</span>, ele);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (hasRefAttribute) &#123;</div><div class="line">                String refName = ele.getAttribute(REF_ATTRIBUTE);</div><div class="line">                <span class="keyword">if</span> (!StringUtils.hasText(refName)) &#123;</div><div class="line">                     <span class="keyword">error</span>(elementName + <span class="string">" contains empty 'ref' attribute"</span>, ele);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//ref属性的处理</span></div><div class="line">                RuntimeBeanReference ref = <span class="keyword">new</span> RuntimeBeanReference(refName);</div><div class="line">                ref.setSource(extractSource(ele));</div><div class="line">                <span class="keyword">return</span> ref;</div><div class="line">           &#125;</div><div class="line">           <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(hasValueAttribute)</span> </span>&#123;</div><div class="line">                <span class="comment">//value属性的处理</span></div><div class="line">                TypedStringValue valueHolder = <span class="keyword">new</span> TypedStringValue(ele.getAttribute(VALUE_ATTRIBUTE));</div><div class="line">                valueHolder.setSource(extractSource(ele));</div><div class="line">                <span class="keyword">return</span> valueHolder;</div><div class="line">           &#125;</div><div class="line">           <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(subElement != <span class="keyword">null</span>)</span> </span>&#123;</div><div class="line">                <span class="comment">//子元素的处理(比如map)</span></div><div class="line">                <span class="function"><span class="keyword">return</span> <span class="title">parsePropertySubElement</span><span class="params">(subElement, bd)</span></span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Neither child element nor "ref" or "value" attribute found.</span></div><div class="line">                <span class="comment">//即没有ref又没有value也没有子元素</span></div><div class="line">                <span class="keyword">error</span>(elementName + <span class="string">" must specify a ref or value"</span>, ele);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">           &#125;</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
<p>ref:<br><figure class="highlight delphi"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="function"><span class="keyword">constructor</span>-<span class="title">arg</span> <span class="title">ref</span>="<span class="title">a</span>" &gt;</span></div></pre></td></tr></table></figure></p>
<p>value:<br><figure class="highlight delphi"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="function"><span class="keyword">constructor</span>-<span class="title">arg</span> <span class="title">value</span>="<span class="title">a</span>" &gt;</span></div></pre></td></tr></table></figure></p>
<p>子元素：<br><figure class="highlight delphi"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;<span class="function"><span class="keyword">constructor</span>-<span class="title">arg</span> &gt;</span></div><div class="line">     &lt;<span class="title">map</span>&gt;</div><div class="line">          &lt;<span class="title">entry</span> <span class="title">key</span>="<span class="title">key</span>" <span class="title">value</span>="<span class="title">value</span>" /&gt;</div><div class="line">     &lt;/<span class="title">map</span>&gt;</div><div class="line">&lt;/<span class="title">constructor</span>-<span class="title">arg</span> &gt;</div></pre></td></tr></table></figure></p>
<p>子元素的处理(比如map)具体实现：实现了所有可支持子类的分类处理<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//BeanDefinitionParserDelegate</span></div><div class="line"><span class="keyword">public</span> <span class="function">Object <span class="title">parsePropertySubElement</span><span class="params">(Element ele, BeanDefinition bd)</span> </span>&#123;</div><div class="line">           <span class="function"><span class="keyword">return</span> <span class="title">parsePropertySubElement</span><span class="params">(ele, bd, <span class="keyword">null</span>)</span></span>;</div><div class="line">     &#125;</div><div class="line">     </div><div class="line"><span class="comment">//BeanDefinitionParserDelegate</span></div><div class="line"><span class="keyword">public</span> <span class="function">Object <span class="title">parsePropertySubElement</span><span class="params">(Element ele, BeanDefinition bd, String defaultValueType)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!isDefaultNamespace(ele)) &#123;</div><div class="line">                <span class="function"><span class="keyword">return</span> <span class="title">parseNestedCustomElement</span><span class="params">(ele, bd)</span></span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</div><div class="line">                BeanDefinitionHolder nestedBd = parseBeanDefinitionElement(ele, bd);</div><div class="line">                <span class="keyword">if</span> (nestedBd != <span class="keyword">null</span>) &#123;</div><div class="line">                     nestedBd = decorateBeanDefinitionIfRequired(ele, nestedBd, bd);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> nestedBd;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, REF_ELEMENT)) &#123;</div><div class="line">                <span class="comment">// A generic reference to any name of any bean.</span></div><div class="line">                String refName = ele.getAttribute(BEAN_REF_ATTRIBUTE);</div><div class="line">                <span class="keyword">boolean</span> toParent = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">if</span> (!StringUtils.hasLength(refName)) &#123;</div><div class="line">                     <span class="comment">// A reference to the id of another bean in the same XML file.</span></div><div class="line">                     refName = ele.getAttribute(LOCAL_REF_ATTRIBUTE);</div><div class="line">                     <span class="keyword">if</span> (!StringUtils.hasLength(refName)) &#123;</div><div class="line">                           <span class="comment">// A reference to the id of another bean in a parent context.</span></div><div class="line">                           refName = ele.getAttribute(PARENT_REF_ATTRIBUTE);</div><div class="line">                           toParent = <span class="keyword">true</span>;</div><div class="line">                           <span class="keyword">if</span> (!StringUtils.hasLength(refName)) &#123;</div><div class="line">                                <span class="keyword">error</span>(<span class="string">"'bean', 'local' or 'parent' is required for &lt;ref&gt; element"</span>, ele);</div><div class="line">                                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                           &#125;</div><div class="line">                     &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (!StringUtils.hasText(refName)) &#123;</div><div class="line">                     <span class="keyword">error</span>(<span class="string">"&lt;ref&gt; element contains empty target attribute"</span>, ele);</div><div class="line">                     <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">                RuntimeBeanReference ref = <span class="keyword">new</span> RuntimeBeanReference(refName, toParent);</div><div class="line">                ref.setSource(extractSource(ele));</div><div class="line">                <span class="keyword">return</span> ref;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, IDREF_ELEMENT)) &#123;</div><div class="line">                <span class="function"><span class="keyword">return</span> <span class="title">parseIdRefElement</span><span class="params">(ele)</span></span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, VALUE_ELEMENT)) &#123;</div><div class="line">                <span class="function"><span class="keyword">return</span> <span class="title">parseValueElement</span><span class="params">(ele, defaultValueType)</span></span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, NULL_ELEMENT)) &#123;</div><div class="line">                <span class="comment">// It's a distinguished null value. Let's wrap it in a TypedStringValue</span></div><div class="line">                <span class="comment">// object in order to preserve the source location.</span></div><div class="line">                TypedStringValue nullHolder = <span class="keyword">new</span> TypedStringValue(<span class="keyword">null</span>);</div><div class="line">                nullHolder.setSource(extractSource(ele));</div><div class="line">                <span class="keyword">return</span> nullHolder;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, ARRAY_ELEMENT)) &#123;</div><div class="line">                <span class="function"><span class="keyword">return</span> <span class="title">parseArrayElement</span><span class="params">(ele, bd)</span></span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, LIST_ELEMENT)) &#123;</div><div class="line">                <span class="function"><span class="keyword">return</span> <span class="title">parseListElement</span><span class="params">(ele, bd)</span></span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, SET_ELEMENT)) &#123;</div><div class="line">                <span class="function"><span class="keyword">return</span> <span class="title">parseSetElement</span><span class="params">(ele, bd)</span></span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, MAP_ELEMENT)) &#123;</div><div class="line">                <span class="function"><span class="keyword">return</span> <span class="title">parseMapElement</span><span class="params">(ele, bd)</span></span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (nodeNameEquals(ele, PROPS_ELEMENT)) &#123;</div><div class="line">                <span class="function"><span class="keyword">return</span> <span class="title">parsePropsElement</span><span class="params">(ele)</span></span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">error</span>(<span class="string">"Unknown property sub-element: ["</span> + ele.getNodeName() + <span class="string">"]"</span>, ele);</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">           &#125;</div><div class="line">     &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//BeanDefinitionParserDelegate</span></div><div class="line"><span class="comment">//对属性的解析</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parsePropertyElements</span><span class="params">(Element beanEle, BeanDefinition bd)</span> </span>&#123;</div><div class="line">           NodeList nl = beanEle.getChildNodes();</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</div><div class="line">                Node node = nl.item(i);</div><div class="line">                <span class="keyword">if</span> (isCandidateElement(node) &amp;&amp; nodeNameEquals(node, PROPERTY_ELEMENT)) &#123;</div><div class="line">                    <span class="comment">//对属性的解析</span></div><div class="line">                     parsePropertyElement((Element) node, bd);</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=<span class="string">"test"</span> <span class="class"><span class="keyword">class</span></span>=<span class="string">"test.TestClass"</span>&gt;</div><div class="line">     <span class="xml"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"testStr"</span> <span class="attr">value</span>=<span class="string">"aaa"</span>/&gt;</span></span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//BeanDefinitionParserDelegate</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">parsePropertyElement</span><span class="params">(Element ele, BeanDefinition bd)</span> </span>&#123;</div><div class="line">           <span class="comment">//获取配置元素中name的值</span></div><div class="line">           String propertyName = ele.getAttribute(NAME_ATTRIBUTE);</div><div class="line">           <span class="keyword">if</span> (!StringUtils.hasLength(propertyName)) &#123;</div><div class="line">                <span class="keyword">error</span>(<span class="string">"Tag 'property' must have a 'name' attribute"</span>, ele);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">this</span>.parseState.push(<span class="keyword">new</span> PropertyEntry(propertyName));</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">//不允许多次对同一属性配置</span></div><div class="line">                <span class="keyword">if</span> (bd.getPropertyValues().contains(propertyName)) &#123;</div><div class="line">                     <span class="keyword">error</span>(<span class="string">"Multiple 'property' definitions for property '"</span> + propertyName + <span class="string">"'"</span>, ele);</div><div class="line">                     <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//和构造函数的解析用了同一个方法</span></div><div class="line">                Object val = parsePropertyValue(ele, bd, propertyName);</div><div class="line">                PropertyValue pv = <span class="keyword">new</span> PropertyValue(propertyName, val);</div><div class="line">                parseMetaElements(ele, pv);</div><div class="line">                pv.setSource(extractSource(ele));</div><div class="line">                bd.getPropertyValues().addPropertyValue(pv);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">finally</span> &#123;</div><div class="line">                <span class="keyword">this</span>.parseState.pop();</div><div class="line">           &#125;</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
<p><strong>至此我们完成了对XML文档到GenericBeanDefinition的转换。</strong></p>
<p>接下来看一下默认标签中自定义标签(这里的自定义类型是属性)的解析：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//BeanDefinitionParserDelegate</span></div><div class="line"><span class="keyword">public</span> <span class="function">BeanDefinitionHolder <span class="title">decorateBeanDefinitionIfRequired</span><span class="params">(Element ele, BeanDefinitionHolder definitionHolder)</span> </span>&#123;</div><div class="line">           <span class="function"><span class="keyword">return</span> <span class="title">decorateBeanDefinitionIfRequired</span><span class="params">(ele, definitionHolder, <span class="keyword">null</span>)</span></span>;</div><div class="line">     &#125;</div><div class="line"></div><div class="line"><span class="comment">//BeanDefinitionParserDelegate</span></div><div class="line"><span class="keyword">public</span> <span class="function">BeanDefinitionHolder <span class="title">decorateBeanDefinitionIfRequired</span><span class="params">(</span></span></div><div class="line">                Element ele, BeanDefinitionHolder definitionHolder, BeanDefinition containingBd) &#123;</div><div class="line">           BeanDefinitionHolder finalDefinition = definitionHolder;</div><div class="line">           <span class="comment">// Decorate based on custom attributes first.</span></div><div class="line">           <span class="comment">//遍历所有的属性，看看是否有适用于修饰的属性</span></div><div class="line">           NamedNodeMap attributes = ele.getAttributes();</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attributes.getLength(); i++) &#123;</div><div class="line">                Node node = attributes.item(i);</div><div class="line">                finalDefinition = decorateIfRequired(node, finalDefinition, containingBd);</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// Decorate based on custom nested elements.</span></div><div class="line">           <span class="comment">//遍历所有的子节点，看看是否有适用于修饰的子元素</span></div><div class="line">           NodeList children = ele.getChildNodes();</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.getLength(); i++) &#123;</div><div class="line">                Node node = children.item(i);</div><div class="line">                <span class="keyword">if</span> (node.getNodeType() == Node.ELEMENT_NODE) &#123;</div><div class="line">                     finalDefinition = decorateIfRequired(node, finalDefinition, containingBd);</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> finalDefinition;</div><div class="line">     &#125;</div><div class="line"></div><div class="line"><span class="comment">//BeanDefinitionParserDelegate</span></div><div class="line"><span class="keyword">public</span> <span class="function">BeanDefinitionHolder <span class="title">decorateIfRequired</span><span class="params">(</span></span></div><div class="line">                Node node, BeanDefinitionHolder originalDef, BeanDefinition containingBd) &#123;</div><div class="line"></div><div class="line">                         <span class="comment">//获取自定义标签的命名空间</span></div><div class="line">           String namespaceUri = getNamespaceURI(node);</div><div class="line">           <span class="comment">//对于非默认标签进行修饰</span></div><div class="line">           <span class="keyword">if</span> (!isDefaultNamespace(namespaceUri)) &#123;</div><div class="line">                <span class="comment">//根据命名空间找到对应的处理器</span></div><div class="line">                NamespaceHandler <span class="keyword">handler</span> = <span class="keyword">this</span>.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri);</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">handler</span> != <span class="keyword">null</span>) &#123;</div><div class="line">                     <span class="keyword">return</span> <span class="keyword">handler</span>.decorate(node, originalDef, <span class="keyword">new</span> ParserContext(<span class="keyword">this</span>.readerContext, <span class="keyword">this</span>, containingBd));</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (namespaceUri != <span class="keyword">null</span> &amp;&amp; namespaceUri.startsWith(<span class="string">"http://www.springframework.org/"</span>)) &#123;</div><div class="line">                     <span class="keyword">error</span>(<span class="string">"Unable to locate Spring NamespaceHandler for XML schema namespace ["</span> + namespaceUri + <span class="string">"]"</span>, node);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                     <span class="comment">// A custom namespace, not to be handled by Spring - maybe "xml:...".</span></div><div class="line">                     <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">                           logger.debug(<span class="string">"No Spring NamespaceHandler found for XML schema namespace ["</span> + namespaceUri + <span class="string">"]"</span>);</div><div class="line">                     &#125;</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> originalDef;</div><div class="line">     &#125;</div></pre></td></tr></table></figure></p>
<h2 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h2><p><strong>自此，对xml的解析和修饰已经完成，接下来就是注册了：</strong><br>入口：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//DefaultBeanDefinitionDocumentReader</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseDefaultElement</span>(<span class="params">Element ele, BeanDefinitionParserDelegate <span class="keyword">delegate</span></span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">delegate</span>.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;</div><div class="line">        importBeanDefinitionResource(ele);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">delegate</span>.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;</div><div class="line">        processAliasRegistration(ele);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">delegate</span>.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;<span class="comment">//Bean标签的解析及注册;只讲这块的代码</span></div><div class="line">        processBeanDefinition(ele, <span class="keyword">delegate</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">delegate</span>.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;</div><div class="line">        <span class="comment">// recurse</span></div><div class="line">        doRegisterBeanDefinitions(ele);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//DefaultBeanDefinitionDocumentReader</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processBeanDefinition</span>(<span class="params">Element ele, BeanDefinitionParserDelegate <span class="keyword">delegate</span></span>) </span>&#123;</div><div class="line">		BeanDefinitionHolder bdHolder = <span class="keyword">delegate</span>.parseBeanDefinitionElement(ele);</div><div class="line">		<span class="keyword">if</span> (bdHolder != <span class="literal">null</span>) &#123;</div><div class="line">			bdHolder = <span class="keyword">delegate</span>.decorateBeanDefinitionIfRequired(ele, bdHolder);</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="comment">// Register the final decorated instance.</span></div><div class="line">				<span class="comment">//注册</span></div><div class="line">				BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</div><div class="line">				getReaderContext().error(<span class="string">"Failed to register bean definition with name '"</span> +</div><div class="line">						bdHolder.getBeanName() + <span class="string">"'"</span>, ele, ex);</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// Send registration event.</span></div><div class="line">			getReaderContext().fireComponentRegistered(<span class="keyword">new</span> BeanComponentDefinition(bdHolder));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line"><span class="comment">//BeanDefinitionReaderUtils</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span>(<span class="params"></span></span></div><div class="line">                BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</div><div class="line">                throws BeanDefinitionStoreException &#123;</div><div class="line">           <span class="comment">// Register bean definition under primary name.</span></div><div class="line">           <span class="comment">//使用beanName做唯一标识注册</span></div><div class="line">           String beanName = definitionHolder.getBeanName();</div><div class="line">           registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition());</div><div class="line">           <span class="comment">// Register aliases for bean name, if any.</span></div><div class="line">           <span class="comment">//注册所有的别名,下面会列出代码</span></div><div class="line">           String[] aliases = definitionHolder.getAliases();</div><div class="line">           <span class="keyword">if</span> (aliases != <span class="literal">null</span>) &#123;</div><div class="line">                <span class="keyword">for</span> (String <span class="keyword">alias</span> : aliases) &#123;</div><div class="line">                     registry.registerAlias(beanName, <span class="keyword">alias</span>);</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">     &#125;</div></pre></td></tr></table></figure></p>
<p>解析的beanDefinition都会被注册到beanDefinitionRegistry类型的实例registry中，对beanDefinition的注册分为了2部分，beanName的注册和别名的注册。<br>通过beanName注册beanDefinition：将beanDefinition直接放入到map中，以beanName为key。<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//DefaultListableBeanFactory</span></div><div class="line"><span class="meta">@Override</span></div><div class="line">     <span class="keyword">public</span> void registerBeanDefinition(String beanName, BeanDefinition beanDefinition)</div><div class="line">                throws BeanDefinitionStoreException &#123;</div><div class="line">           Assert.hasText(beanName, <span class="string">"Bean name must not be empty"</span>);</div><div class="line">           Assert.notNull(beanDefinition, <span class="string">"BeanDefinition must not be null"</span>);</div><div class="line">           <span class="keyword">if</span> (beanDefinition instanceof AbstractBeanDefinition) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                     ((AbstractBeanDefinition) beanDefinition).validate();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</div><div class="line">                     <span class="keyword">throw</span> new BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName,</div><div class="line">                                <span class="string">"Validation of bean definition failed"</span>, ex);</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">           BeanDefinition oldBeanDefinition;</div><div class="line"></div><div class="line">                         <span class="comment">//this.beanDefinitionMap ： ConcurrentHashMap   线程安全的Map</span></div><div class="line">           oldBeanDefinition = <span class="keyword">this</span>.beanDefinitionMap.<span class="keyword">get</span>(beanName);</div><div class="line">           <span class="comment">//处理注册已经注册的beanName情况</span></div><div class="line">           <span class="keyword">if</span> (oldBeanDefinition != <span class="literal">null</span>) &#123;</div><div class="line">                <span class="comment">//如果对应的beanName已经注册且在配置中配置了bean不允许被覆盖，则抛出异常。</span></div><div class="line">                <span class="keyword">if</span> (!isAllowBeanDefinitionOverriding()) &#123;</div><div class="line">                     <span class="keyword">throw</span> new BeanDefinitionStoreException(beanDefinition.getResourceDescription(), beanName,</div><div class="line">                                <span class="string">"Cannot register bean definition ["</span> + beanDefinition + <span class="string">"] for bean '"</span> + beanName +</div><div class="line">                                <span class="string">"': There is already ["</span> + oldBeanDefinition + <span class="string">"] bound."</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (oldBeanDefinition.getRole() &lt; beanDefinition.getRole()) &#123;</div><div class="line">                     <span class="comment">// e.g. was ROLE_APPLICATION, now overriding with ROLE_SUPPORT or ROLE_INFRASTRUCTURE</span></div><div class="line">                     <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isWarnEnabled()) &#123;</div><div class="line">                           <span class="keyword">this</span>.logger.warn(<span class="string">"Overriding user-defined bean definition for bean '"</span> + beanName +</div><div class="line">                                     <span class="string">"' with a framework-generated bean definition: replacing ["</span> +</div><div class="line">                                     oldBeanDefinition + <span class="string">"] with ["</span> + beanDefinition + <span class="string">"]"</span>);</div><div class="line">                     &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (!beanDefinition.equals(oldBeanDefinition)) &#123;</div><div class="line">                     <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isInfoEnabled()) &#123;</div><div class="line">                           <span class="keyword">this</span>.logger.info(<span class="string">"Overriding bean definition for bean '"</span> + beanName +</div><div class="line">                                     <span class="string">"' with a different definition: replacing ["</span> + oldBeanDefinition +</div><div class="line">                                     <span class="string">"] with ["</span> + beanDefinition + <span class="string">"]"</span>);</div><div class="line">                     &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                     <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</div><div class="line">                           <span class="keyword">this</span>.logger.debug(<span class="string">"Overriding bean definition for bean '"</span> + beanName +</div><div class="line">                                     <span class="string">"' with an equivalent definition: replacing ["</span> + oldBeanDefinition +</div><div class="line">                                     <span class="string">"] with ["</span> + beanDefinition + <span class="string">"]"</span>);</div><div class="line">                     &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//注册beanDefinition</span></div><div class="line">                <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (hasBeanCreationStarted()) &#123;</div><div class="line">                     <span class="comment">// Cannot modify startup-time collection elements anymore (for stable iteration)</span></div><div class="line">                     <span class="comment">//会存在并发访问情况</span></div><div class="line">                     synchronized (<span class="keyword">this</span>.beanDefinitionMap) &#123;</div><div class="line">                           <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</div><div class="line">                           List&lt;String&gt; updatedDefinitions = new ArrayList&lt;String&gt;(<span class="keyword">this</span>.beanDefinitionNames.size() + <span class="number">1</span>);</div><div class="line">                          updatedDefinitions.addAll(<span class="keyword">this</span>.beanDefinitionNames);</div><div class="line">                           updatedDefinitions.add(beanName);</div><div class="line">                           <span class="keyword">this</span>.beanDefinitionNames = updatedDefinitions;</div><div class="line">                           <span class="keyword">if</span> (<span class="keyword">this</span>.manualSingletonNames.contains(beanName)) &#123;</div><div class="line">                                Set&lt;String&gt; updatedSingletons = new LinkedHashSet&lt;String&gt;(<span class="keyword">this</span>.manualSingletonNames);</div><div class="line">                                updatedSingletons.remove(beanName);</div><div class="line">                                <span class="keyword">this</span>.manualSingletonNames = updatedSingletons;</div><div class="line">                           &#125;</div><div class="line">                     &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                     <span class="comment">// Still in startup registration phase</span></div><div class="line">                     <span class="keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</div><div class="line">                     <span class="keyword">this</span>.beanDefinitionNames.add(beanName);</div><div class="line">                     <span class="keyword">this</span>.manualSingletonNames.remove(beanName);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">this</span>.frozenBeanDefinitionNames = <span class="literal">null</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (oldBeanDefinition != <span class="literal">null</span> || containsSingleton(beanName)) &#123;</div><div class="line">                <span class="comment">//重置所有beanName对应的缓存</span></div><div class="line">                resetBeanDefinition(beanName);</div><div class="line">           &#125;</div><div class="line">     &#125;</div></pre></td></tr></table></figure></p>
<p>对beanName的注册处理方式上，主要有以下几个步骤：</p>
<ol>
<li>对AbstractBeanDefinition 的校验。</li>
<li>加入map缓存。</li>
<li>清除解析之前留下的对应的beanName的缓存。</li>
</ol>
<p><strong>通过别名注册beanDefinition</strong><br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//SimpleAliasRegistry</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerAlias</span>(<span class="params">String name, String <span class="keyword">alias</span></span>) </span>&#123;</div><div class="line">           Assert.hasText(name, <span class="string">"'name' must not be empty"</span>);</div><div class="line">           Assert.hasText(<span class="keyword">alias</span>, <span class="string">"'alias' must not be empty"</span>);</div><div class="line">           <span class="comment">//如果alias与beanName相同的话不记录alias，并删除对应的alias。</span></div><div class="line">           <span class="keyword">if</span> (<span class="keyword">alias</span>.<span class="keyword">equals</span>(name)) &#123;</div><div class="line">                <span class="keyword">this</span>.aliasMap.<span class="keyword">remove</span>(<span class="keyword">alias</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> &#123;</div><div class="line">                String registeredName = <span class="keyword">this</span>.aliasMap.<span class="keyword">get</span>(<span class="keyword">alias</span>);</div><div class="line">                <span class="keyword">if</span> (registeredName != <span class="literal">null</span>) &#123;</div><div class="line">                     <span class="keyword">if</span> (registeredName.<span class="keyword">equals</span>(name)) &#123;</div><div class="line">                           <span class="comment">// An existing alias - no need to re-register</span></div><div class="line">                           <span class="keyword">return</span>;</div><div class="line">                     &#125;</div><div class="line">                     <span class="comment">//如果alias不允许被覆盖，就抛出异常。</span></div><div class="line">                     <span class="keyword">if</span> (!allowAliasOverriding()) &#123;</div><div class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot register alias '"</span> + <span class="keyword">alias</span> + <span class="string">"' for name '"</span> +</div><div class="line">                                     name + <span class="string">"': It is already registered for name '"</span> + registeredName + <span class="string">"'."</span>);</div><div class="line">                     &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//alias循环检查</span></div><div class="line">                checkForAliasCircle(name, <span class="keyword">alias</span>);</div><div class="line">                <span class="comment">//注册alias。</span></div><div class="line">                <span class="keyword">this</span>.aliasMap.put(<span class="keyword">alias</span>, name);</div><div class="line">           &#125;</div><div class="line">     &#125;</div><div class="line"><span class="comment">//SimpleAliasRegistry</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkForAliasCircle</span>(<span class="params">String name, String <span class="keyword">alias</span></span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (hasAlias(<span class="keyword">alias</span>, name)) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot register alias '"</span> + <span class="keyword">alias</span> +</div><div class="line">                    <span class="string">"' for name '"</span> + name + <span class="string">"': Circular reference - '"</span> +</div><div class="line">                    name + <span class="string">"' is a direct or indirect alias for '"</span> + <span class="keyword">alias</span> + <span class="string">"' already"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="bean的加载"><a href="#bean的加载" class="headerlink" title="bean的加载"></a>bean的加载</h2><p>启动spring容器的时候只完成了bean的解析及注册，只有在用到bean的时候才会开始bean的加载(比如通过注解得到对象或者getBean的时候)<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">springTest</span> <span class="params">()</span> </span>&#123;</div><div class="line">      XmlBeanFactory bf = <span class="keyword">new</span> XmlBeanFactory(<span class="keyword">new</span> ClassPathResource(<span class="string">"beanFactory.xml"</span>));</div><div class="line">      SpringTest bean  = (SpringTest)bf.getBean(<span class="string">"springTest"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//AbstractBeanFactory</span></div><div class="line">@Override</div><div class="line"><span class="keyword">public</span> <span class="keyword">Object</span> getBean(<span class="keyword">String</span> name) <span class="keyword">throws</span> BeansException &#123;</div><div class="line">      <span class="keyword">return</span> doGetBean(name, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//AbstractBeanFactory</span></div><div class="line">@SuppressWarnings(<span class="string">"unchecked"</span>)</div><div class="line"><span class="keyword">protected</span> &lt;T&gt; T doGetBean(</div><div class="line">           <span class="keyword">final</span> <span class="keyword">String</span> name, <span class="keyword">final</span> Class&lt;T&gt; requiredType, <span class="keyword">final</span> <span class="keyword">Object</span>[] args, <span class="built_in">boolean</span> typeCheckOnly)</div><div class="line">           <span class="keyword">throws</span> BeansException &#123;</div><div class="line"></div><div class="line">                    <span class="comment">//提取对应的beanName</span></div><div class="line">      <span class="keyword">final</span> <span class="keyword">String</span> beanName = transformedBeanName(name);</div><div class="line">      <span class="keyword">Object</span> bean;</div><div class="line">      <span class="comment">// Eagerly check singleton cache for manually registered singletons.</span></div><div class="line">      <span class="comment">//首先使用这段代码为了避免循环依赖；</span></div><div class="line">      <span class="keyword">Object</span> sharedInstance = getSingleton(beanName);</div><div class="line">      <span class="keyword">if</span> (sharedInstance != <span class="keyword">null</span> &amp;&amp; args == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">                <span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</div><div class="line">                      logger.debug(<span class="string">"Returning eagerly cached instance of singleton bean '"</span> + beanName +</div><div class="line">                                <span class="string">"' that is not fully initialized yet - a consequence of a circular reference"</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                      logger.debug(<span class="string">"Returning cached instance of singleton bean '"</span> + beanName + <span class="string">"'"</span>);</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="comment">//返回对应的实例</span></div><div class="line">           bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="keyword">null</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">// Fail if we're already creating this bean instance:</span></div><div class="line">           <span class="comment">// We're assumably within a circular reference.</span></div><div class="line">           <span class="comment">//只有在单例情况才会尝试解决循环依赖，原型模式情况下，如果存在A中有B的属性，B中有A的属性，那么当依赖注入的时候，就会产生当A还未创建完的时候，因为对于B的创建再次返回创建A，造成循环依赖，也就是下面的情况。</span></div><div class="line">           <span class="keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName);</div><div class="line">           &#125;</div><div class="line">           <span class="comment">// Check if bean definition exists in this factory.</span></div><div class="line">           BeanFactory parentBeanFactory = getParentBeanFactory();</div><div class="line">           <span class="keyword">if</span> (parentBeanFactory != <span class="keyword">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</div><div class="line">                <span class="comment">// Not found -&gt; check parent.</span></div><div class="line">                <span class="keyword">String</span> nameToLookup = originalBeanName(name);</div><div class="line">                <span class="keyword">if</span> (args != <span class="keyword">null</span>) &#123;</div><div class="line">                      <span class="comment">// Delegation to parent with explicit args.</span></div><div class="line">                      <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                      <span class="comment">// No args -&gt; delegate to standard getBean method.</span></div><div class="line">                      <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (!typeCheckOnly) &#123;</div><div class="line">                markBeanAsCreated(beanName);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">final</span> RootBeanDefinition mbd = getMergedLocalBeanDefinition(beanName);</div><div class="line">                checkMergedBeanDefinition(mbd, beanName, args);</div><div class="line">                <span class="comment">// Guarantee initialization of beans that the current bean depends on.</span></div><div class="line">                <span class="keyword">String</span>[] dependsOn = mbd.getDependsOn();</div><div class="line">                <span class="comment">//若存在依赖则需要递归实例化依赖的bean</span></div><div class="line">                <span class="keyword">if</span> (dependsOn != <span class="keyword">null</span>) &#123;</div><div class="line">                      <span class="keyword">for</span> (<span class="keyword">String</span> dep : dependsOn) &#123;</div><div class="line">                           <span class="keyword">if</span> (isDependent(beanName, dep)) &#123;</div><div class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</div><div class="line">                                           <span class="string">"Circular depends-on relationship between '"</span> + beanName + <span class="string">"' and '"</span> + dep + <span class="string">"'"</span>);</div><div class="line">                           &#125;</div><div class="line">                           registerDependentBean(dep, beanName);</div><div class="line">                           getBean(dep);</div><div class="line">                      &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// Create bean instance.</span></div><div class="line">                <span class="comment">//实例化依赖的bean后遍可以实例化mbd本身</span></div><div class="line">                <span class="comment">//singleton模式</span></div><div class="line">                <span class="keyword">if</span> (mbd.isSingleton()) &#123;</div><div class="line">                      <span class="comment">//下面会解释这个,bean获取过程(如何获取单例)</span></div><div class="line">                      sharedInstance = getSingleton(beanName, <span class="keyword">new</span> ObjectFactory&lt;<span class="keyword">Object</span>&gt;() &#123;</div><div class="line">                           @Override</div><div class="line">                           <span class="keyword">public</span> <span class="keyword">Object</span> getObject() <span class="keyword">throws</span> BeansException &#123;</div><div class="line">                                <span class="keyword">try</span> &#123;</div><div class="line">                                      <span class="keyword">return</span> createBean(beanName, mbd, args);</div><div class="line">                                &#125;</div><div class="line">                                <span class="keyword">catch</span> (BeansException ex) &#123;</div><div class="line">                                      <span class="comment">// Explicitly remove instance from singleton cache: It might have been put there</span></div><div class="line">                                      <span class="comment">// eagerly by the creation process, to allow for circular reference resolution.</span></div><div class="line">                                      <span class="comment">// Also remove any beans that received a temporary reference to the bean.</span></div><div class="line">                                     destroySingleton(beanName);</div><div class="line">                                      <span class="keyword">throw</span> ex;</div><div class="line">                                &#125;</div><div class="line">                           &#125;</div><div class="line">                      &#125;);</div><div class="line">                      bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</div><div class="line">                      <span class="comment">// It's a prototype -&gt; create a new instance.</span></div><div class="line">                      <span class="keyword">Object</span> prototypeInstance = <span class="keyword">null</span>;</div><div class="line">                      <span class="keyword">try</span> &#123;</div><div class="line">                           beforePrototypeCreation(beanName);</div><div class="line">                           <span class="comment">//创建bean,下面会讲到</span></div><div class="line">                           prototypeInstance = createBean(beanName, mbd, args);</div><div class="line">                      &#125;</div><div class="line">                      <span class="keyword">finally</span> &#123;</div><div class="line">                           afterPrototypeCreation(beanName);</div><div class="line">                      &#125;</div><div class="line">                      bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                      <span class="comment">//指定的scope上实例化bean</span></div><div class="line">                      <span class="keyword">String</span> scopeName = mbd.getScope();</div><div class="line">                      <span class="keyword">final</span> Scope scope = <span class="keyword">this</span>.scopes.<span class="built_in">get</span>(scopeName);</div><div class="line">                      <span class="keyword">if</span> (scope == <span class="keyword">null</span>) &#123;</div><div class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No Scope registered for scope name '"</span> + scopeName + <span class="string">"'"</span>);</div><div class="line">                      &#125;</div><div class="line">                      <span class="keyword">try</span> &#123;</div><div class="line">                           <span class="keyword">Object</span> scopedInstance = scope.<span class="built_in">get</span>(beanName, <span class="keyword">new</span> ObjectFactory&lt;<span class="keyword">Object</span>&gt;() &#123;</div><div class="line">                                @Override</div><div class="line">                                <span class="keyword">public</span> <span class="keyword">Object</span> getObject() <span class="keyword">throws</span> BeansException &#123;</div><div class="line">                                     beforePrototypeCreation(beanName);</div><div class="line">                                      <span class="keyword">try</span> &#123;</div><div class="line">                                           <span class="keyword">return</span> createBean(beanName, mbd, args);</div><div class="line">                                      &#125;</div><div class="line">                                      <span class="keyword">finally</span> &#123;</div><div class="line">                                           afterPrototypeCreation(beanName);</div><div class="line">                                      &#125;</div><div class="line">                                &#125;</div><div class="line">                           &#125;);</div><div class="line">                           <span class="comment">//bean的实例化</span></div><div class="line">                           bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</div><div class="line">                      &#125;</div><div class="line">                      <span class="keyword">catch</span> (IllegalStateException ex) &#123;</div><div class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(beanName,</div><div class="line">                                      <span class="string">"Scope '"</span> + scopeName + <span class="string">"' is not active for the current thread; consider "</span> +</div><div class="line">                                      <span class="string">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span>,</div><div class="line">                                      ex);</div><div class="line">                      &#125;</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">catch</span> (BeansException ex) &#123;</div><div class="line">                cleanupAfterBeanCreationFailure(beanName);</div><div class="line">                <span class="keyword">throw</span> ex;</div><div class="line">           &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// Check if required type matches the type of the actual bean instance.</span></div><div class="line">      <span class="keyword">if</span> (requiredType != <span class="keyword">null</span> &amp;&amp; bean != <span class="keyword">null</span> &amp;&amp; !requiredType.isAssignableFrom(bean.getClass())) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">return</span> getTypeConverter().convertIfNecessary(bean, requiredType);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">catch</span> (TypeMismatchException ex) &#123;</div><div class="line">                <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">                      logger.debug(<span class="string">"Failed to convert bean '"</span> + name + <span class="string">"' to required type '"</span> +</div><div class="line">                                ClassUtils.getQualifiedName(requiredType) + <span class="string">"'"</span>, ex);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.getClass());</div><div class="line">           &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> (T) bean;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>整个加载过程涉及步骤如下：</p>
<ol>
<li>转换对应beanName：<br>  取出factoryBean的修饰符：如果name=”&amp;&amp;aa”，会去掉&amp;使name=”aa”;<br>  取指定alias别名所表示的最终beanName；</li>
<li>尝试从缓存中获取单例<br>单例在Spring的同一个容器中只会被创建一次，后续再获取bean，就直接从单例缓存中获取了。这里只是尝试加载，如果加载不成功，就从singletonFactories中加载。因为在创建单例bean的时候会存在依赖注入的情况，而在创建依赖的时候为了避免循环依赖，在Spring中创建bean的原则是不等bean创建完成就会将创建bean的ObjectFactory提早曝光加入到缓存中，一旦下一个bean创建时需要依赖上一个bean则直接使用ObjectFactory。</li>
<li>bean的实例化(缓存中记录的只是最原始的bean状态，getObjectForBeanInstance )</li>
<li>原型模式的依赖检查(循环依赖)</li>
<li>检测parentBeanFactory</li>
<li>将存储XML配置文件的 GenericBeanDefinition 转换为RootBeanDefinition</li>
<li>寻找依赖：在Spring的加载顺序中，在初始化某一个bean的时候，首先会初始化这个bean所对应的依赖。</li>
<li>针对不同的scope进行bean的创建(最重要)</li>
<li>类型转换</li>
</ol>
<p>一般情况下，Spring通过反射机制利用bean的class属性指定实现类来实例化bean。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//DefaultSingletonBeanRegistry</span></div><div class="line"><span class="comment">//缓存中获取单例bean</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> Object getSingleton(String beanName) &#123;</div><div class="line">      <span class="keyword">return</span> getSingleton(beanName, <span class="literal">true</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//DefaultSingletonBeanRegistry</span></div><div class="line"><span class="keyword">protected</span> Object getSingleton(String beanName, boolean allowEarlyReference) &#123;</div><div class="line">      <span class="comment">//检查缓存中是否存在实例</span></div><div class="line">      Object singletonObject = <span class="keyword">this</span>.singletonObjects.<span class="keyword">get</span>(beanName);</div><div class="line">      <span class="keyword">if</span> (singletonObject == <span class="literal">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;</div><div class="line">           <span class="comment">//锁定全局变量并进行处理</span></div><div class="line">           synchronized (<span class="keyword">this</span>.singletonObjects) &#123;</div><div class="line">                singletonObject = <span class="keyword">this</span>.earlySingletonObjects.<span class="keyword">get</span>(beanName);</div><div class="line">                <span class="keyword">if</span> (singletonObject == <span class="literal">null</span> &amp;&amp; allowEarlyReference) &#123;</div><div class="line">                      ObjectFactory&lt;?&gt; singletonFactory = <span class="keyword">this</span>.singletonFactories.<span class="keyword">get</span>(beanName);</div><div class="line">                      <span class="keyword">if</span> (singletonFactory != <span class="literal">null</span>) &#123;</div><div class="line">                           singletonObject = singletonFactory.getObject();</div><div class="line">                           <span class="comment">//记录在缓存中,earlySingletonObjects和singletonFactories互斥</span></div><div class="line">                           <span class="keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);</div><div class="line">                           <span class="keyword">this</span>.singletonFactories.remove(beanName);</div><div class="line">                      &#125;</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> (singletonObject != NULL_OBJECT ? singletonObject : <span class="literal">null</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//DefaultSingletonBeanRegistry</span></div><div class="line"><span class="comment">//获取单例：如果缓存中没有，就要从头开始bean的获取过程</span></div><div class="line"><span class="keyword">public</span> Object getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123;</div><div class="line">      Assert.notNull(beanName, <span class="string">"'beanName' must not be null"</span>);</div><div class="line">      synchronized (<span class="keyword">this</span>.singletonObjects) &#123;</div><div class="line">           Object singletonObject = <span class="keyword">this</span>.singletonObjects.<span class="keyword">get</span>(beanName);</div><div class="line">           <span class="keyword">if</span> (singletonObject == <span class="literal">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.singletonsCurrentlyInDestruction) &#123;</div><div class="line">                      <span class="keyword">throw</span> new BeanCreationNotAllowedException(beanName,</div><div class="line">                                <span class="string">"Singleton bean creation not allowed while singletons of this factory are in destruction "</span> +</div><div class="line">                                <span class="string">"(Do not request a bean from a BeanFactory in a destroy method implementation!)"</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">                      logger.debug(<span class="string">"Creating shared instance of singleton bean '"</span> + beanName + <span class="string">"'"</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//记录加载状态，将当前正在要创建的bean记录在缓存中，可以对循环依赖进行检测</span></div><div class="line">                beforeSingletonCreation(beanName);</div><div class="line">                boolean newSingleton = <span class="literal">false</span>;</div><div class="line">                boolean recordSuppressedExceptions = (<span class="keyword">this</span>.suppressedExceptions == <span class="literal">null</span>);</div><div class="line">                <span class="keyword">if</span> (recordSuppressedExceptions) &#123;</div><div class="line">                      <span class="keyword">this</span>.suppressedExceptions = new LinkedHashSet&lt;Exception&gt;();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                      singletonObject = singletonFactory.getObject();</div><div class="line">                      newSingleton = <span class="literal">true</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">catch</span> (IllegalStateException ex) &#123;</div><div class="line">                      <span class="comment">// Has the singleton object implicitly appeared in the meantime -&gt;</span></div><div class="line">                      <span class="comment">// if yes, proceed with it since the exception indicates that state.</span></div><div class="line">                      singletonObject = <span class="keyword">this</span>.singletonObjects.<span class="keyword">get</span>(beanName);</div><div class="line">                      <span class="keyword">if</span> (singletonObject == <span class="literal">null</span>) &#123;</div><div class="line">                           <span class="keyword">throw</span> ex;</div><div class="line">                      &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">catch</span> (BeanCreationException ex) &#123;</div><div class="line">                      <span class="keyword">if</span> (recordSuppressedExceptions) &#123;</div><div class="line">                           <span class="keyword">for</span> (Exception suppressedException : <span class="keyword">this</span>.suppressedExceptions) &#123;</div><div class="line">                                ex.addRelatedCause(suppressedException);</div><div class="line">                           &#125;</div><div class="line">                      &#125;</div><div class="line">                      <span class="keyword">throw</span> ex;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">finally</span> &#123;</div><div class="line">                      <span class="keyword">if</span> (recordSuppressedExceptions) &#123;</div><div class="line">                           <span class="keyword">this</span>.suppressedExceptions = <span class="literal">null</span>;</div><div class="line">                      &#125;</div><div class="line">                      afterSingletonCreation(beanName);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (newSingleton) &#123;</div><div class="line">                      <span class="comment">//加入缓存</span></div><div class="line">                      addSingleton(beanName, singletonObject);</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> (singletonObject != NULL_OBJECT ? singletonObject : <span class="literal">null</span>);</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>singletonObjects</strong>：用于保存beanName和创建bean实例之间的关系，beanname–&gt; beaninstance<br><strong>singletonFactories</strong>：用于保存beanName和创建bean工厂之间的关系，beanname–&gt; ObjectFactory<br><strong>earlySingletonObjects</strong>：用于保存beanName和创建bean实例之间的关系，和singletonObjects不同的是，当一个单例bean被放到这里之后，当bean还在创建过程中，就可以被getBean获取到，其目的是为了检测循环引用。</p>
<p>bean的实例化(缓存中记录的只是最原始的bean状态，getObjectForBeanInstance )<br>AbstractBeanFactory.getObjectForBeanInstance<br>我们需要的是工厂bean中定义的factory-method方法中返回的bean而不是初始状态的bean，这个方法就是完成这个工作的。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//AbstractBeanFactory</span></div><div class="line"><span class="keyword">protected</span> <span class="type">Object</span> getObjectForBeanInstance(</div><div class="line">           <span class="type">Object</span> beanInstance, <span class="type">String</span> name, <span class="type">String</span> beanName, <span class="type">RootBeanDefinition</span> mbd) &#123;</div><div class="line">      <span class="comment">// Don't let calling code try to dereference the factory if the bean isn't a factory.</span></div><div class="line">      <span class="comment">//如果指定的beanName是工厂相关(&amp;为前缀)且beanInstance 又不是FactoryBean 类型则验证不通过</span></div><div class="line">      <span class="keyword">if</span> (<span class="type">BeanFactoryUtils</span>.isFactoryDereference(name) &amp;&amp; !(beanInstance instanceof <span class="type">FactoryBean</span>)) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">BeanIsNotAFactoryException</span>(transformedBeanName(name), beanInstance.getClass());</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// Now we have the bean instance, which may be a normal bean or a FactoryBean.</span></div><div class="line">      <span class="comment">// If it's a FactoryBean, we use it to create a bean instance, unless the</span></div><div class="line">      <span class="comment">// caller actually wants a reference to the factory.</span></div><div class="line">      <span class="keyword">if</span> (!(beanInstance instanceof <span class="type">FactoryBean</span>) || <span class="type">BeanFactoryUtils</span>.isFactoryDereference(name)) &#123;</div><div class="line">           <span class="keyword">return</span> beanInstance;</div><div class="line">      &#125;</div><div class="line">      <span class="type">Object</span> <span class="class"><span class="keyword">object</span> </span>= <span class="literal">null</span>;</div><div class="line">      <span class="keyword">if</span> (mbd == <span class="literal">null</span>) &#123;</div><div class="line">           <span class="class"><span class="keyword">object</span> </span>= getCachedObjectForFactoryBean(beanName);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (<span class="class"><span class="keyword">object</span> <span class="title">==</span> <span class="title">null</span>) </span>&#123;</div><div class="line">           <span class="comment">// Return bean instance from factory.</span></div><div class="line">           <span class="comment">//明确知道beanInstance 是FactoryBean类型</span></div><div class="line">           <span class="type">FactoryBean</span>&lt;?&gt; factory = (<span class="type">FactoryBean</span>&lt;?&gt;) beanInstance;</div><div class="line">           <span class="comment">// Caches object obtained from FactoryBean if it is a singleton.</span></div><div class="line">           <span class="keyword">if</span> (mbd == <span class="literal">null</span> &amp;&amp; containsBeanDefinition(beanName)) &#123;</div><div class="line">                mbd = getMergedLocalBeanDefinition(beanName);</div><div class="line">           &#125;</div><div class="line">           boolean synthetic = (mbd != <span class="literal">null</span> &amp;&amp; mbd.isSynthetic());</div><div class="line">           <span class="comment">//核心代码</span></div><div class="line">           <span class="class"><span class="keyword">object</span> </span>= getObjectFromFactoryBean(factory, beanName, !synthetic);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="class"><span class="keyword">object</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//FactoryBeanRegistrySupport</span></div><div class="line"><span class="keyword">protected</span> <span class="type">Object</span> getObjectFromFactoryBean(<span class="type">FactoryBean</span>&lt;?&gt; factory, <span class="type">String</span> beanName, boolean shouldPostProcess) &#123;</div><div class="line">      <span class="keyword">if</span> (factory.isSingleton() &amp;&amp; containsSingleton(beanName)) &#123;</div><div class="line">           synchronized (getSingletonMutex()) &#123;</div><div class="line">                <span class="type">Object</span> <span class="class"><span class="keyword">object</span> </span>= <span class="keyword">this</span>.factoryBeanObjectCache.get(beanName);</div><div class="line">                <span class="keyword">if</span> (<span class="class"><span class="keyword">object</span> <span class="title">==</span> <span class="title">null</span>) </span>&#123;</div><div class="line">                      <span class="class"><span class="keyword">object</span> </span>= doGetObjectFromFactoryBean(factory, beanName);</div><div class="line">                      <span class="comment">// Only post-process and store if not put there already during getObject() call above</span></div><div class="line">                      <span class="comment">// (e.g. because of circular reference processing triggered by custom getBean calls)</span></div><div class="line">                      <span class="type">Object</span> alreadyThere = <span class="keyword">this</span>.factoryBeanObjectCache.get(beanName);</div><div class="line">                      <span class="keyword">if</span> (alreadyThere != <span class="literal">null</span>) &#123;</div><div class="line">                           <span class="class"><span class="keyword">object</span> </span>= alreadyThere;</div><div class="line">                      &#125;</div><div class="line">                      <span class="keyword">else</span> &#123;</div><div class="line">                           <span class="keyword">if</span> (<span class="class"><span class="keyword">object</span> <span class="title">!=</span> <span class="title">null</span> <span class="title">&amp;&amp;</span> <span class="title">shouldPostProcess</span>) </span>&#123;</div><div class="line">                                <span class="keyword">try</span> &#123;</div><div class="line">                                      <span class="comment">//调用ObjectFactory的后处理器</span></div><div class="line">                                      <span class="class"><span class="keyword">object</span> </span>= postProcessObjectFromFactoryBean(<span class="class"><span class="keyword">object</span>, <span class="title">beanName</span>)</span>;</div><div class="line">                                &#125;</div><div class="line">                                <span class="keyword">catch</span> (<span class="type">Throwable</span> ex) &#123;</div><div class="line">                                      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">BeanCreationException</span>(beanName,</div><div class="line">                                                <span class="string">"Post-processing of FactoryBean's singleton object failed"</span>, ex);</div><div class="line">                                &#125;</div><div class="line">                           &#125;</div><div class="line">                           <span class="keyword">this</span>.factoryBeanObjectCache.put(beanName, (<span class="class"><span class="keyword">object</span> <span class="title">!=</span> <span class="title">null</span> <span class="title">?</span> <span class="title">object</span> </span>: <span class="type">NULL_OBJECT</span>));</div><div class="line">                      &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> (<span class="class"><span class="keyword">object</span> <span class="title">!=</span> <span class="title">NULL_OBJECT</span> <span class="title">?</span> <span class="title">object</span> </span>: <span class="literal">null</span>);</div><div class="line">           &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">//核心代码</span></div><div class="line">           <span class="type">Object</span> <span class="class"><span class="keyword">object</span> </span>= doGetObjectFromFactoryBean(factory, beanName);</div><div class="line">           <span class="keyword">if</span> (<span class="class"><span class="keyword">object</span> <span class="title">!=</span> <span class="title">null</span> <span class="title">&amp;&amp;</span> <span class="title">shouldPostProcess</span>) </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                      <span class="class"><span class="keyword">object</span> </span>= postProcessObjectFromFactoryBean(<span class="class"><span class="keyword">object</span>, <span class="title">beanName</span>)</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">catch</span> (<span class="type">Throwable</span> ex) &#123;</div><div class="line">                      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">BeanCreationException</span>(beanName, <span class="string">"Post-processing of FactoryBean's object failed"</span>, ex);</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> <span class="class"><span class="keyword">object</span></span>;</div><div class="line">      &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//FactoryBeanRegistrySupport</span></div><div class="line"><span class="keyword">private</span> <span class="type">Object</span> doGetObjectFromFactoryBean(<span class="keyword">final</span> <span class="type">FactoryBean</span>&lt;?&gt; factory, <span class="keyword">final</span> <span class="type">String</span> beanName)</div><div class="line">		<span class="keyword">throws</span> <span class="type">BeanCreationException</span> &#123;</div><div class="line"></div><div class="line">	<span class="type">Object</span> <span class="class"><span class="keyword">object</span></span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">if</span> (<span class="type">System</span>.getSecurityManager() != <span class="literal">null</span>) &#123;</div><div class="line">			<span class="type">AccessControlContext</span> acc = getAccessControlContext();</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="class"><span class="keyword">object</span> </span>= <span class="type">AccessController</span>.doPrivileged(<span class="keyword">new</span> <span class="type">PrivilegedExceptionAction</span>&lt;<span class="type">Object</span>&gt;() &#123;</div><div class="line">					<span class="meta">@Override</span></div><div class="line">					public <span class="type">Object</span> run() <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</div><div class="line">							<span class="keyword">return</span> factory.getObject();</div><div class="line">						&#125;</div><div class="line">					&#125;, acc);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">catch</span> (<span class="type">PrivilegedActionException</span> pae) &#123;</div><div class="line">				<span class="keyword">throw</span> pae.getException();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			<span class="class"><span class="keyword">object</span> </span>= factory.getObject();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (<span class="type">FactoryBeanNotInitializedException</span> ex) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">BeanCurrentlyInCreationException</span>(beanName, ex.toString());</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (<span class="type">Throwable</span> ex) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">BeanCreationException</span>(beanName, <span class="string">"FactoryBean threw exception on object creation"</span>, ex);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Do not accept a null value for a FactoryBean that's not fully</span></div><div class="line">	<span class="comment">// initialized yet: Many FactoryBeans just return null then.</span></div><div class="line">	<span class="keyword">if</span> (<span class="class"><span class="keyword">object</span> <span class="title">==</span> <span class="title">null</span> <span class="title">&amp;&amp;</span> <span class="title">isSingletonCurrentlyInCreation</span>(<span class="params">beanName</span>)) </span>&#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">BeanCurrentlyInCreationException</span>(</div><div class="line">				beanName, <span class="string">"FactoryBean which is currently in creation returned null from getObject"</span>);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="class"><span class="keyword">object</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来要真正创建bean了：<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//AbstractAutowireCapableBeanFactory</span></div><div class="line">@Override</div><div class="line"><span class="keyword">protected</span> <span class="keyword">Object</span> createBean(<span class="keyword">String</span> beanName, RootBeanDefinition mbd, <span class="keyword">Object</span>[] args) <span class="keyword">throws</span> BeanCreationException &#123;</div><div class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">           logger.debug(<span class="string">"Creating instance of bean '"</span> + beanName + <span class="string">"'"</span>);</div><div class="line">      &#125;</div><div class="line">      RootBeanDefinition mbdToUse = mbd;</div><div class="line">      <span class="comment">// Make sure bean class is actually resolved at this point, and</span></div><div class="line">      <span class="comment">// clone the bean definition in case of a dynamically resolved Class</span></div><div class="line">      <span class="comment">// which cannot be stored in the shared merged bean definition.</span></div><div class="line">      <span class="comment">//锁定class,根据设置的class属性或者根据className来解析class</span></div><div class="line">      Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);</div><div class="line">      <span class="keyword">if</span> (resolvedClass != <span class="keyword">null</span> &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != <span class="keyword">null</span>) &#123;</div><div class="line">           mbdToUse = <span class="keyword">new</span> RootBeanDefinition(mbd);</div><div class="line">           mbdToUse.setBeanClass(resolvedClass);</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// Prepare method overrides.</span></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">//验证及准备覆盖的方法(lookup-method及replace-method配置功能的实现)</span></div><div class="line">           mbdToUse.prepareMethodOverrides();</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(mbdToUse.getResourceDescription(),</div><div class="line">                      beanName, <span class="string">"Validation of method overrides failed"</span>, ex);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span></div><div class="line">           <span class="keyword">Object</span> bean = resolveBeforeInstantiation(beanName, mbdToUse);</div><div class="line">           <span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> bean;</div><div class="line">           &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbdToUse.getResourceDescription(), beanName,</div><div class="line">                      <span class="string">"BeanPostProcessor before instantiation of bean failed"</span>, ex);</div><div class="line">      &#125;</div><div class="line">      <span class="comment">//真正创建bean的方法,下面会贴上代码</span></div><div class="line">      <span class="keyword">Object</span> beanInstance = doCreateBean(beanName, mbdToUse, args);</div><div class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">           logger.debug(<span class="string">"Finished creating instance of bean '"</span> + beanName + <span class="string">"'"</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> beanInstance;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>真正创建bean的方法在<strong>doCreateBean</strong> 里面，在创建之前再讲下循环依赖：<br>循环依赖和循环调用是不同的，循环调用是死循环，循环依赖是循环引用；两个或多个bean之间互相持有对方。<br>Spring容器的循环依赖包括构造器循环依赖(无法解决)和setter循环依赖。</p>
<p>构造器循环依赖：<br>A、B、C循环依赖时，<br>    <img src="/uploads/spring8.jpg" alt=""><br>setter循环依赖<br>setter循环依赖是通过Spring容器提前暴露刚完成构造器注入但未完成其他步骤的bean来完成，而且只能解决单例作用域的bean循环依赖，通过提前暴露一个单例工厂方法，从而使其他bean能引用到该bean。<br>prototype：对于prototype作用域bean，Spring容器无法完成依赖注入，因为Spring容器不进行缓存prototype作用域的bean，因此无法提前暴露一个创建中的bean。</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//AbstractAutowireCapableBeanFactory</span></div><div class="line"><span class="keyword">protected</span> <span class="keyword">Object</span> doCreateBean(<span class="keyword">final</span> <span class="keyword">String</span> beanName, <span class="keyword">final</span> RootBeanDefinition mbd, <span class="keyword">final</span> <span class="keyword">Object</span>[] args)</div><div class="line">           <span class="keyword">throws</span> BeanCreationException &#123;</div><div class="line">      <span class="comment">// Instantiate the bean.</span></div><div class="line">      BeanWrapper instanceWrapper = <span class="keyword">null</span>;</div><div class="line">      <span class="keyword">if</span> (mbd.isSingleton()) &#123;</div><div class="line">           instanceWrapper = <span class="keyword">this</span>.factoryBeanInstanceCache.remove(beanName);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (instanceWrapper == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="comment">//根据指定bean使用对应的策略创建新的实例，如：工厂方法，构造函数自动注入，简单初始化,下面会贴上代码</span></div><div class="line">           instanceWrapper = createBeanInstance(beanName, mbd, args);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">final</span> <span class="keyword">Object</span> bean = (instanceWrapper != <span class="keyword">null</span> ? instanceWrapper.getWrappedInstance() : <span class="keyword">null</span>);</div><div class="line">      Class&lt;?&gt; beanType = (instanceWrapper != <span class="keyword">null</span> ? instanceWrapper.getWrappedClass() : <span class="keyword">null</span>);</div><div class="line">      mbd.resolvedTargetType = beanType;</div><div class="line">      <span class="comment">// Allow post-processors to modify the merged bean definition.</span></div><div class="line">      <span class="keyword">synchronized</span> (mbd.postProcessingLock) &#123;</div><div class="line">           <span class="keyword">if</span> (!mbd.postProcessed) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                     applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">                      <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</div><div class="line">                                <span class="string">"Post-processing of merged bean definition failed"</span>, ex);</div><div class="line">                &#125;</div><div class="line">                mbd.postProcessed = <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// Eagerly cache singletons to be able to resolve circular references</span></div><div class="line">      <span class="comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span></div><div class="line">      <span class="comment">//是否需要提前曝光：单例&amp;允许循环依赖(这个可以手动设置)&amp;当前bean正在创建中，检测循环依赖(记录创建bean的ObjectFactory)</span></div><div class="line">      <span class="built_in">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="keyword">this</span>.allowCircularReferences &amp;&amp;</div><div class="line">                isSingletonCurrentlyInCreation(beanName));</div><div class="line">      <span class="keyword">if</span> (earlySingletonExposure) &#123;</div><div class="line">           <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">                logger.debug(<span class="string">"Eagerly caching bean '"</span> + beanName +</div><div class="line">                           <span class="string">"' to allow for resolving potential circular references"</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="comment">//为避免后期循环依赖，可以在bean初始化完成前将创建实例的ObjectFactory加入工厂</span></div><div class="line">           addSingletonFactory(beanName, <span class="keyword">new</span> ObjectFactory&lt;<span class="keyword">Object</span>&gt;() &#123;</div><div class="line">                @Override</div><div class="line">                <span class="keyword">public</span> <span class="keyword">Object</span> getObject() <span class="keyword">throws</span> BeansException &#123;</div><div class="line">                      <span class="comment">//AOP在这里将advice动态织入bean中，若没有直接返回bean</span></div><div class="line">                      <span class="keyword">return</span> getEarlyBeanReference(beanName, mbd, bean);</div><div class="line">                &#125;</div><div class="line">           &#125;);</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// Initialize the bean instance.</span></div><div class="line">      <span class="keyword">Object</span> exposedObject = bean;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">//对bean进行填充，将各个属性值注入，其中，可能存在依赖于其他bean的属性，则会递归初始依赖bean(下面会贴出代码)</span></div><div class="line">           populateBean(beanName, mbd, instanceWrapper);</div><div class="line">           <span class="keyword">if</span> (exposedObject != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">//调用初始化方法</span></div><div class="line">                exposedObject = initializeBean(beanName, exposedObject, mbd);</div><div class="line">           &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">           <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;</div><div class="line">                <span class="keyword">throw</span> (BeanCreationException) ex;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</div><div class="line">                           mbd.getResourceDescription(), beanName, <span class="string">"Initialization of bean failed"</span>, ex);</div><div class="line">           &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (earlySingletonExposure) &#123;</div><div class="line">           <span class="keyword">Object</span> earlySingletonReference = getSingleton(beanName, <span class="keyword">false</span>);</div><div class="line">           <span class="keyword">if</span> (earlySingletonReference != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (exposedObject == bean) &#123;</div><div class="line">                      exposedObject = earlySingletonReference;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;</div><div class="line">                      <span class="keyword">String</span>[] dependentBeans = getDependentBeans(beanName);</div><div class="line">                      Set&lt;<span class="keyword">String</span>&gt; actualDependentBeans = <span class="keyword">new</span> LinkedHashSet&lt;<span class="keyword">String</span>&gt;(dependentBeans.length);</div><div class="line">                      <span class="keyword">for</span> (<span class="keyword">String</span> dependentBean : dependentBeans) &#123;</div><div class="line">                           <span class="keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;</div><div class="line">                                actualDependentBeans.<span class="built_in">add</span>(dependentBean);</div><div class="line">                           &#125;</div><div class="line">                      &#125;</div><div class="line">                      <span class="keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;</div><div class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> BeanCurrentlyInCreationException(beanName,</div><div class="line">                                      <span class="string">"Bean with name '"</span> + beanName + <span class="string">"' has been injected into other beans ["</span> +</div><div class="line">                                     StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +</div><div class="line">                                      <span class="string">"] in its raw version as part of a circular reference, but has eventually been "</span> +</div><div class="line">                                      <span class="string">"wrapped. This means that said other beans do not use the final version of the "</span> +</div><div class="line">                                      <span class="string">"bean. This is often the result of over-eager type matching - consider using "</span> +</div><div class="line">                                      <span class="string">"'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example."</span>);</div><div class="line">                      &#125;</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// Register bean as disposable.</span></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">//根据scope进行注册</span></div><div class="line">           registerDisposableBeanIfNecessary(beanName, bean, mbd);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</div><div class="line">                      mbd.getResourceDescription(), beanName, <span class="string">"Invalid destruction signature"</span>, ex);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> exposedObject;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//AbstractAutowireCapableBeanFactory</span></div><div class="line"><span class="comment">//创建bean实例</span></div><div class="line"><span class="keyword">protected</span> <span class="function">BeanWrapper <span class="title">createBeanInstance</span><span class="params">(String beanName, RootBeanDefinition mbd, Object[] args)</span> </span>&#123;</div><div class="line">      <span class="comment">// Make sure bean class is actually resolved at this point.</span></div><div class="line">      Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName);</div><div class="line">      <span class="keyword">if</span> (beanClass != <span class="keyword">null</span> &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,</div><div class="line">                      <span class="string">"Bean class isn't public, and non-public access not allowed: "</span> + beanClass.getName());</div><div class="line">      &#125;</div><div class="line"></div><div class="line">                    <span class="comment">//如果工厂方法不为空，则使用工厂方法初始化策略</span></div><div class="line">      <span class="keyword">if</span> (mbd.getFactoryMethodName() != <span class="keyword">null</span>)  &#123;</div><div class="line">           <span class="function"><span class="keyword">return</span> <span class="title">instantiateUsingFactoryMethod</span><span class="params">(beanName, mbd, args)</span></span>;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// Shortcut when re-creating the same bean...</span></div><div class="line">      <span class="keyword">boolean</span> resolved = <span class="keyword">false</span>;</div><div class="line">      <span class="keyword">boolean</span> autowireNecessary = <span class="keyword">false</span>;</div><div class="line">      <span class="keyword">if</span> (args == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;</div><div class="line">                <span class="comment">//一个类有多个构造函数，每个构造函数都有不同的参数，所以调用前需要先根据参数锁定构造函数或对应的工厂方法</span></div><div class="line">                <span class="keyword">if</span> (mbd.resolvedConstructorOrFactoryMethod != <span class="keyword">null</span>) &#123;</div><div class="line">                      resolved = <span class="keyword">true</span>;</div><div class="line">                      autowireNecessary = mbd.constructorArgumentsResolved;</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">//如果已经解析过则使用解析好的构造函数方法不需要再次锁定</span></div><div class="line">      <span class="keyword">if</span> (resolved) &#123;</div><div class="line">           <span class="keyword">if</span> (autowireNecessary) &#123;</div><div class="line">                <span class="comment">//构造函数自动注入</span></div><div class="line">                <span class="function"><span class="keyword">return</span> <span class="title">autowireConstructor</span><span class="params">(beanName, mbd, <span class="keyword">null</span>, <span class="keyword">null</span>)</span></span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">//使用默认构造函数构造</span></div><div class="line">                <span class="function"><span class="keyword">return</span> <span class="title">instantiateBean</span><span class="params">(beanName, mbd)</span></span>;</div><div class="line">           &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// Need to determine the constructor...</span></div><div class="line">      <span class="comment">//需要根据参数解析构造函数</span></div><div class="line">      Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);</div><div class="line">      <span class="keyword">if</span> (ctors != <span class="keyword">null</span> ||</div><div class="line">                mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR ||</div><div class="line">                mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args))  &#123;</div><div class="line">           <span class="comment">//带参数的实例化,下面会贴上代码</span></div><div class="line">           <span class="function"><span class="keyword">return</span> <span class="title">autowireConstructor</span><span class="params">(beanName, mbd, ctors, args)</span></span>;</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// No special handling: simply use no-arg constructor.</span></div><div class="line">      <span class="comment">//不带参构造函数,下面会贴出代码</span></div><div class="line">      <span class="function"><span class="keyword">return</span> <span class="title">instantiateBean</span><span class="params">(beanName, mbd)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//AbstractAutowireCapableBeanFactory</span></div><div class="line"><span class="comment">//带参数的实例化</span></div><div class="line"><span class="keyword">protected</span> BeanWrapper autowireConstructor(                                                                                  </div><div class="line">           <span class="keyword">String</span> beanName, RootBeanDefinition mbd, Constructor&lt;?&gt;[] ctors, <span class="keyword">Object</span>[] explicitArgs) &#123;                        </div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> ConstructorResolver(<span class="keyword">this</span>).autowireConstructor(beanName, mbd, ctors, explicitArgs);                         </div><div class="line">&#125;                                                                                                                           </div><div class="line">                                                                         <span class="comment">//ConstructorResolver                                       </span></div><div class="line"><span class="keyword">public</span> BeanWrapper autowireConstructor(<span class="keyword">final</span> <span class="keyword">String</span> beanName, <span class="keyword">final</span> RootBeanDefinition mbd,                                 </div><div class="line">           Constructor&lt;?&gt;[] chosenCtors, <span class="keyword">final</span> <span class="keyword">Object</span>[] explicitArgs) &#123;                                                     </div><div class="line">      BeanWrapperImpl bw = <span class="keyword">new</span> BeanWrapperImpl();                                                                           </div><div class="line">      <span class="keyword">this</span>.beanFactory.initBeanWrapper(bw);                                                                                 </div><div class="line">      Constructor&lt;?&gt; constructorToUse = <span class="keyword">null</span>;                                                                               </div><div class="line">      ArgumentsHolder argsHolderToUse = <span class="keyword">null</span>;                                                                               </div><div class="line">      <span class="keyword">Object</span>[] argsToUse = <span class="keyword">null</span>;                                                                                            </div><div class="line">                                                                                                                            </div><div class="line">                    <span class="comment">//如果getBean方法调用的时候指定方法参数那么直接使用                                                                          </span></div><div class="line">      <span class="keyword">if</span> (explicitArgs != <span class="keyword">null</span>) &#123;                                                                                           </div><div class="line">           argsToUse = explicitArgs;                                                                                        </div><div class="line">      &#125;                                                                                                                     </div><div class="line">      <span class="keyword">else</span> &#123;                                                                                                                </div><div class="line">           <span class="keyword">Object</span>[] argsToResolve = <span class="keyword">null</span>;                                                                                   </div><div class="line">           <span class="keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;                                                                     </div><div class="line">                constructorToUse = (Constructor&lt;?&gt;) mbd.resolvedConstructorOrFactoryMethod;                                 </div><div class="line">                <span class="keyword">if</span> (constructorToUse != <span class="keyword">null</span> &amp;&amp; mbd.constructorArgumentsResolved) &#123;                                         </div><div class="line">                      <span class="comment">// Found a cached constructor... 从缓存中获取                                                               </span></div><div class="line">                      argsToUse = mbd.resolvedConstructorArguments;                                                         </div><div class="line">                      <span class="keyword">if</span> (argsToUse == <span class="keyword">null</span>) &#123;                                                                              </div><div class="line">                           argsToResolve = mbd.preparedConstructorArguments;                                                </div><div class="line">                      &#125;                                                                                                     </div><div class="line">                &#125;                                                                                                           </div><div class="line">           &#125;                                                                                                                </div><div class="line">           <span class="keyword">if</span> (argsToResolve != <span class="keyword">null</span>) &#123;                                                                                     </div><div class="line">                <span class="comment">//解析参数类型，如给定方法的构造函数A(int,int)则通过此方法后就会把配置中的("1","1")转换为(1,1)                                                </span></div><div class="line">                argsToUse = resolvePreparedArguments(beanName, mbd, bw, constructorToUse, argsToResolve);                   </div><div class="line">           &#125;                                                                                                                </div><div class="line">      &#125;                                                                                                                     </div><div class="line">      <span class="keyword">if</span> (constructorToUse == <span class="keyword">null</span>) &#123;                                                                                       </div><div class="line">           <span class="comment">// Need to resolve the constructor.                                                                              </span></div><div class="line">           <span class="built_in">boolean</span> autowiring = (chosenCtors != <span class="keyword">null</span> ||                                                                     </div><div class="line">                      mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR);                            </div><div class="line">           ConstructorArgumentValues resolvedValues = <span class="keyword">null</span>;                                                                 </div><div class="line">           <span class="built_in">int</span> minNrOfArgs;                                                                                                 </div><div class="line">           <span class="keyword">if</span> (explicitArgs != <span class="keyword">null</span>) &#123;                                                                                      </div><div class="line">                minNrOfArgs = explicitArgs.length;                                                                          </div><div class="line">           &#125;                                                                                                                </div><div class="line">           <span class="keyword">else</span> &#123;                                                                                                           </div><div class="line">                ConstructorArgumentValues cargs = mbd.getConstructorArgumentValues();                                       </div><div class="line">                resolvedValues = <span class="keyword">new</span> ConstructorArgumentValues();                                                           </div><div class="line">                minNrOfArgs = resolveConstructorArguments(beanName, mbd, bw, cargs, resolvedValues);                        </div><div class="line">           &#125;                                                                                                                </div><div class="line">           <span class="comment">// Take specified constructors, if any.                                                                          </span></div><div class="line">           Constructor&lt;?&gt;[] candidates = chosenCtors;                                                                       </div><div class="line">           <span class="keyword">if</span> (candidates == <span class="keyword">null</span>) &#123;                                                                                        </div><div class="line">                Class&lt;?&gt; beanClass = mbd.getBeanClass();                                                                    </div><div class="line">                <span class="keyword">try</span> &#123;                                                                                                       </div><div class="line">                      candidates = (mbd.isNonPublicAccessAllowed() ?                                                        </div><div class="line">                                beanClass.getDeclaredConstructors() : beanClass.getConstructors());                         </div><div class="line">                &#125;                                                                                                           </div><div class="line">                <span class="keyword">catch</span> (Throwable ex) &#123;                                                                                      </div><div class="line">                      <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,                               </div><div class="line">                                <span class="string">"Resolution of declared constructors on bean Class ["</span> + beanClass.getName() +               </div><div class="line">                                <span class="string">"] from ClassLoader ["</span> + beanClass.getClassLoader() + <span class="string">"] failed"</span>, ex);                      </div><div class="line">                &#125;                                                                                                           </div><div class="line">           &#125;                                                                                                                </div><div class="line">           AutowireUtils.sortConstructors(candidates);                                                                      </div><div class="line">           <span class="built_in">int</span> minTypeDiffWeight = Integer.MAX_VALUE;                                                                       </div><div class="line">           Set&lt;Constructor&lt;?&gt;&gt; ambiguousConstructors = <span class="keyword">null</span>;                                                                </div><div class="line">           LinkedList&lt;UnsatisfiedDependencyException&gt; causes = <span class="keyword">null</span>;                                                        </div><div class="line">           <span class="keyword">for</span> (Constructor&lt;?&gt; candidate : candidates) &#123;                                                                    </div><div class="line">                Class&lt;?&gt;[] paramTypes = candidate.getParameterTypes();                                                      </div><div class="line">                <span class="keyword">if</span> (constructorToUse != <span class="keyword">null</span> &amp;&amp; argsToUse.length &gt; paramTypes.length) &#123;                                     </div><div class="line">                      <span class="comment">// Already found greedy constructor that can be satisfied -&gt;                                          </span></div><div class="line">                      <span class="comment">// do not look any further, there are only less greedy constructors left.                             </span></div><div class="line">                      <span class="keyword">break</span>;                                                                                                </div><div class="line">                &#125;                                                                                                           </div><div class="line">                <span class="keyword">if</span> (paramTypes.length &lt; minNrOfArgs) &#123;                                                                      </div><div class="line">                      <span class="keyword">continue</span>;                                                                                             </div><div class="line">                &#125;                                                                                                           </div><div class="line">                ArgumentsHolder argsHolder;                                                                                 </div><div class="line">                <span class="keyword">if</span> (resolvedValues != <span class="keyword">null</span>) &#123;                                                                               </div><div class="line">                      <span class="keyword">try</span> &#123;                                                                                                 </div><div class="line">                           <span class="keyword">String</span>[] paramNames = ConstructorPropertiesChecker.evaluate(candidate, paramTypes.length);       </div><div class="line">                           <span class="keyword">if</span> (paramNames == <span class="keyword">null</span>) &#123;                                                                        </div><div class="line">                                ParameterNameDiscoverer pnd = <span class="keyword">this</span>.beanFactory.getParameterNameDiscoverer();                </div><div class="line">                                <span class="keyword">if</span> (pnd != <span class="keyword">null</span>) &#123;                                                                          </div><div class="line">                                      paramNames = pnd.getParameterNames(candidate);                                        </div><div class="line">                                &#125;                                                                                           </div><div class="line">                           &#125;                                                                                                </div><div class="line">                           argsHolder = createArgumentArray(beanName, mbd, resolvedValues, bw, paramTypes, paramNames,      </div><div class="line">                                     getUserDeclaredConstructor(candidate), autowiring);                                    </div><div class="line">                      &#125;                                                                                                     </div><div class="line">                      <span class="keyword">catch</span> (UnsatisfiedDependencyException ex) &#123;                                                           </div><div class="line">                           <span class="keyword">if</span> (<span class="keyword">this</span>.beanFactory.logger.isTraceEnabled()) &#123;                                                  </div><div class="line">                                <span class="keyword">this</span>.beanFactory.logger.trace(                                                              </div><div class="line">                                           <span class="string">"Ignoring constructor ["</span> + candidate + <span class="string">"] of bean '"</span> + beanName + <span class="string">"': "</span> + ex);   </div><div class="line">                           &#125;                                                                                                </div><div class="line">                           <span class="comment">// Swallow and try next constructor.                                                             </span></div><div class="line">                           <span class="keyword">if</span> (causes == <span class="keyword">null</span>) &#123;                                                                            </div><div class="line">                                causes = <span class="keyword">new</span> LinkedList&lt;UnsatisfiedDependencyException&gt;();                                  </div><div class="line">                           &#125;                                                                                                </div><div class="line">                           causes.<span class="built_in">add</span>(ex);                                                                                  </div><div class="line">                           <span class="keyword">continue</span>;                                                                                        </div><div class="line">                      &#125;                                                                                                     </div><div class="line">                &#125;                                                                                                           </div><div class="line">                <span class="keyword">else</span> &#123;                                                                                                      </div><div class="line">                      <span class="comment">// Explicit arguments given -&gt; arguments length must match exactly.                                   </span></div><div class="line">                      <span class="keyword">if</span> (paramTypes.length != explicitArgs.length) &#123;                                                       </div><div class="line">                           <span class="keyword">continue</span>;                                                                                        </div><div class="line">                      &#125;                                                                                                     </div><div class="line">                      argsHolder = <span class="keyword">new</span> ArgumentsHolder(explicitArgs);                                                       </div><div class="line">                &#125;                                                                                                           </div><div class="line">                <span class="built_in">int</span> typeDiffWeight = (mbd.isLenientConstructorResolution() ?                                                </div><div class="line">                           argsHolder.getTypeDifferenceWeight(paramTypes) : argsHolder.getAssignabilityWeight(paramTypes)); </div><div class="line">                <span class="comment">// Choose this constructor if it represents the closest match.                                              </span></div><div class="line">                <span class="keyword">if</span> (typeDiffWeight &lt; minTypeDiffWeight) &#123;                                                                   </div><div class="line">                      constructorToUse = candidate;                                                                         </div><div class="line">                      argsHolderToUse = argsHolder;                                                                         </div><div class="line">                      argsToUse = argsHolder.arguments;                                                                     </div><div class="line">                      minTypeDiffWeight = typeDiffWeight;                                                                   </div><div class="line">                      ambiguousConstructors = <span class="keyword">null</span>;                                                                         </div><div class="line">                &#125;                                                                                                           </div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (constructorToUse != <span class="keyword">null</span> &amp;&amp; typeDiffWeight == minTypeDiffWeight) &#123;                                 </div><div class="line">                      <span class="keyword">if</span> (ambiguousConstructors == <span class="keyword">null</span>) &#123;                                                                  </div><div class="line">                           ambiguousConstructors = <span class="keyword">new</span> LinkedHashSet&lt;Constructor&lt;?&gt;&gt;();                                     </div><div class="line">                           ambiguousConstructors.<span class="built_in">add</span>(constructorToUse);                                                     </div><div class="line">                      &#125;                                                                                                     </div><div class="line">                      ambiguousConstructors.<span class="built_in">add</span>(candidate);                                                                 </div><div class="line">                &#125;                                                                                                           </div><div class="line">           &#125;                                                                                                                </div><div class="line">           <span class="keyword">if</span> (constructorToUse == <span class="keyword">null</span>) &#123;                                                                                  </div><div class="line">                <span class="keyword">if</span> (causes != <span class="keyword">null</span>) &#123;                                                                                       </div><div class="line">                      UnsatisfiedDependencyException ex = causes.removeLast();                                              </div><div class="line">                      <span class="keyword">for</span> (Exception cause : causes) &#123;                                                                      </div><div class="line">                           <span class="keyword">this</span>.beanFactory.onSuppressedException(cause);                                                   </div><div class="line">                      &#125;                                                                                                     </div><div class="line">                      <span class="keyword">throw</span> ex;                                                                                             </div><div class="line">                &#125;                                                                                                           </div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,                                     </div><div class="line">                           <span class="string">"Could not resolve matching constructor "</span> +                                                      </div><div class="line">                           <span class="string">"(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities)"</span>);    </div><div class="line">           &#125;                                                                                                                </div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (ambiguousConstructors != <span class="keyword">null</span> &amp;&amp; !mbd.isLenientConstructorResolution()) &#123;                               </div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,                                     </div><div class="line">                           <span class="string">"Ambiguous constructor matches found in bean '"</span> + beanName + <span class="string">"' "</span> +                              </div><div class="line">                           <span class="string">"(hint: specify index/type/name arguments for simple parameters to avoid type ambiguities): "</span> +  </div><div class="line">                           ambiguousConstructors);                                                                          </div><div class="line">           &#125;                                                                                                                </div><div class="line">           <span class="keyword">if</span> (explicitArgs == <span class="keyword">null</span>) &#123;                                                                                      </div><div class="line">                argsHolderToUse.storeCache(mbd, constructorToUse);                                                          </div><div class="line">           &#125;                                                                                                                </div><div class="line">      &#125;                                                                                                                     </div><div class="line">      <span class="keyword">try</span> &#123;                                                                                                                 </div><div class="line">           <span class="keyword">Object</span> beanInstance;                                                                                             </div><div class="line">           <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;                                                                       </div><div class="line">                <span class="keyword">final</span> Constructor&lt;?&gt; ctorToUse = constructorToUse;                                                          </div><div class="line">                <span class="keyword">final</span> <span class="keyword">Object</span>[] argumentsToUse = argsToUse;                                                                  </div><div class="line">                beanInstance = AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;<span class="keyword">Object</span>&gt;() &#123;                               </div><div class="line">                      @Override                                                                                             </div><div class="line">                      <span class="keyword">public</span> <span class="keyword">Object</span> run() &#123;                                                                                 </div><div class="line">                           <span class="keyword">return</span> beanFactory.getInstantiationStrategy().instantiate(                                       </div><div class="line">                                      mbd, beanName, beanFactory, ctorToUse, argumentsToUse);                               </div><div class="line">                      &#125;                                                                                                     </div><div class="line">                &#125;, beanFactory.getAccessControlContext());                                                                  </div><div class="line">           &#125;                                                                                                                </div><div class="line">           <span class="keyword">else</span> &#123;                                                                                                           </div><div class="line">                beanInstance = <span class="keyword">this</span>.beanFactory.getInstantiationStrategy().instantiate(                                     </div><div class="line">                           mbd, beanName, <span class="keyword">this</span>.beanFactory, constructorToUse, argsToUse);                                   </div><div class="line">           &#125;                                                                                                                </div><div class="line">           bw.setBeanInstance(beanInstance);                                                                                </div><div class="line">           <span class="keyword">return</span> bw;                                                                                                       </div><div class="line">      &#125;                                                                                                                     </div><div class="line">      <span class="keyword">catch</span> (Throwable ex) &#123;                                                                                                </div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(mbd.getResourceDescription(), beanName,                                          </div><div class="line">                      <span class="string">"Bean instantiation via constructor failed"</span>, ex);                                                     </div><div class="line">      &#125;                                                                                                                     </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//AbstractAutowireCapableBeanFactory</span></div><div class="line"><span class="comment">//不带参构造函数</span></div><div class="line"><span class="keyword">protected</span> BeanWrapper instantiateBean(<span class="keyword">final</span> <span class="keyword">String</span> beanName, <span class="keyword">final</span> RootBeanDefinition mbd) &#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">Object</span> beanInstance;</div><div class="line">           <span class="keyword">final</span> BeanFactory parent = <span class="keyword">this</span>;</div><div class="line">           <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</div><div class="line">                beanInstance = AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;<span class="keyword">Object</span>&gt;() &#123;</div><div class="line">                      @Override</div><div class="line">                      <span class="keyword">public</span> <span class="keyword">Object</span> run() &#123;</div><div class="line">                           <span class="keyword">return</span> getInstantiationStrategy().instantiate(mbd, beanName, parent);</div><div class="line">                      &#125;</div><div class="line">                &#125;, getAccessControlContext());</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">//实例化的过程</span></div><div class="line">                beanInstance = getInstantiationStrategy().instantiate(mbd, beanName, parent);</div><div class="line">           &#125;</div><div class="line">           BeanWrapper bw = <span class="keyword">new</span> BeanWrapperImpl(beanInstance);</div><div class="line">           initBeanWrapper(bw);</div><div class="line">           <span class="keyword">return</span> bw;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</div><div class="line">                      mbd.getResourceDescription(), beanName, <span class="string">"Instantiation of bean failed"</span>, ex);</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//SimpleInstantiationStrategy</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="function">Object <span class="title">instantiate</span><span class="params">(RootBeanDefinition bd, String beanName, BeanFactory owner)</span> </span>&#123;</div><div class="line">      <span class="comment">// Don't override the class with CGLIB if no overrides.</span></div><div class="line">      <span class="comment">//如果有需要覆盖或者动态替换的方法则当然要使用cglib进行动态代理,因为可以在创建代理的同时将动态方法芝入类中，但是如果没有需要动态改变的方法，为了方便直接反射就可以了</span></div><div class="line">      <span class="keyword">if</span> (bd.getMethodOverrides().isEmpty()) &#123;</div><div class="line">           Constructor&lt;?&gt; constructorToUse;</div><div class="line">           <span class="keyword">synchronized</span> (bd.constructorArgumentLock) &#123;</div><div class="line">                constructorToUse = (Constructor&lt;?&gt;) bd.resolvedConstructorOrFactoryMethod;</div><div class="line">                <span class="keyword">if</span> (constructorToUse == <span class="keyword">null</span>) &#123;</div><div class="line">                      <span class="keyword">final</span> Class&lt;?&gt; clazz = bd.getBeanClass();</div><div class="line">                      <span class="keyword">if</span> (clazz.isInterface()) &#123;</div><div class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> BeanInstantiationException(clazz, <span class="string">"Specified class is an interface"</span>);</div><div class="line">                      &#125;</div><div class="line">                      <span class="keyword">try</span> &#123;</div><div class="line">                           <span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</div><div class="line">                                constructorToUse = AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedExceptionAction&lt;Constructor&lt;?&gt;&gt;() &#123;</div><div class="line">                                      <span class="meta">@Override</span></div><div class="line">                                      <span class="keyword">public</span> Constructor&lt;?&gt; run() <span class="keyword">throws</span> Exception &#123;</div><div class="line">                                           <span class="keyword">return</span> clazz.getDeclaredConstructor((Class[]) <span class="keyword">null</span>);</div><div class="line">                                      &#125;</div><div class="line">                                &#125;);</div><div class="line">                           &#125;</div><div class="line">                           <span class="keyword">else</span> &#123;</div><div class="line">                                constructorToUse =     clazz.getDeclaredConstructor((Class[]) <span class="keyword">null</span>);</div><div class="line">                           &#125;</div><div class="line">                           bd.resolvedConstructorOrFactoryMethod = constructorToUse;</div><div class="line">                      &#125;</div><div class="line">                      <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> BeanInstantiationException(clazz, <span class="string">"No default constructor found"</span>, ex);</div><div class="line">                      &#125;</div><div class="line">                &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="function"><span class="keyword">return</span> BeanUtils.<span class="title">instantiateClass</span><span class="params">(constructorToUse)</span></span>;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">// Must generate CGLIB subclass.</span></div><div class="line">           <span class="function"><span class="keyword">return</span> <span class="title">instantiateWithMethodInjection</span><span class="params">(bd, beanName, owner)</span></span>;</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">//CglibSubclassingInstantiationStrategy<span class="keyword"></span></div><div class="line">public Object instantiate(Constructor&lt;?&gt; ctor, Object... args) &#123;</div><div class="line">	Class&lt;?&gt; subclass = createEnhancedSubclass(this.beanDefinition);</div><div class="line">	Object instance;</div><div class="line"><span class="built_in">	if </span>(ctor == null) &#123;</div><div class="line">	<span class="built_in">	instance </span>= BeanUtils.instantiate(subclass);</div><div class="line">	&#125;</div><div class="line">	else &#123;</div><div class="line">		try &#123;</div><div class="line">			Constructor&lt;?&gt; enhancedSubclassConstructor = subclass.getConstructor(ctor.getParameterTypes());</div><div class="line">		<span class="built_in">	instance </span>= enhancedSubclassConstructor.newInstance(args);</div><div class="line">		&#125;</div><div class="line">		catch (Exception ex) &#123;</div><div class="line">		<span class="built_in">	throw </span>new BeanInstantiationException(this.beanDefinition.getBeanClass(),</div><div class="line">					<span class="string">"Failed to invoke constructor for CGLIB enhanced subclass ["</span> + subclass.getName() + <span class="string">"]"</span>, ex);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	// SPR-10785: set callbacks directly on the<span class="built_in"> instance </span>instead of in the</div><div class="line">	// enhanced class (via the Enhancer) in order to avoid memory leaks.</div><div class="line">	Factory factory = (Factory) instance;</div><div class="line">	factory.setCallbacks(new Callback[] &#123;NoOp.INSTANCE,</div><div class="line">		<span class="built_in">	new </span>LookupOverrideMethodInterceptor(this.beanDefinition, this.owner),</div><div class="line">		<span class="built_in">	new </span>ReplaceOverrideMethodInterceptor(this.beanDefinition, this.owner)&#125;);</div><div class="line"><span class="built_in">	return </span>instance;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>记录创建bean的ObjectFactory</strong><br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//AbstractAutowireCapableBeanFactory.doCreateBean(final String beanName, final RootBeanDefinition mbd, final Object[] args)</span></div><div class="line"><span class="keyword">boolean</span> earlySingletonExposure = (mbd.isSingleton() &amp;&amp; <span class="keyword">this</span>.allowCircularReferences &amp;&amp;</div><div class="line">                isSingletonCurrentlyInCreation(beanName));</div></pre></td></tr></table></figure></p>
<p>earlySingletonExposure：提早曝光的单例<br>mbd.isSingleton()：此RootBeanDefinition代表的是否是单例<br>this.allowCircularReferences：是否允许循环依赖，可以通过硬编码的方式进行设置或者通过自定义命名空间进行配置<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ClassPathXmlApplicationContext bf = <span class="keyword">new</span> <span class="type">ClassPathXmlApplicationContext</span>(<span class="string">"aspectTest.xml"</span>);</div><div class="line">bf.setAllowBeanDefinitionOverriding(<span class="literal">false</span>);</div></pre></td></tr></table></figure></p>
<p>isSingletonCurrentlyInCreation(beanName)：该bean是否在创建中。在Spring中，会有个专门的属性默认为DefaultSingletonBeanRegistry的singletonsCurrentlyInCreation来记录bean的加载状态，在bean开始创建前将beanName记录在属性中，创建完毕后移除。<br>    <img src="/uploads/spring9.jpg" alt=""></p>
<h3 id="属性注入"><a href="#属性注入" class="headerlink" title="属性注入"></a>属性注入</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line">//AbstractAutowireCapableBeanFactory</div><div class="line"><span class="symbol">protected</span> void <span class="keyword">populateBean(String </span><span class="keyword">beanName, </span>RootBeanDefinition mbd, <span class="keyword">BeanWrapper </span><span class="keyword">bw) </span>&#123;</div><div class="line">	PropertyValues pvs = mbd.getPropertyValues()<span class="comment">;</span></div><div class="line"></div><div class="line">	<span class="meta">if</span> (<span class="keyword">bw </span>== null) &#123;</div><div class="line">		<span class="meta">if</span> (!pvs.isEmpty()) &#123;</div><div class="line">			throw new <span class="keyword">BeanCreationException(</span></div><div class="line">					mbd.getResourceDescription(), <span class="keyword">beanName, </span><span class="string">"Cannot apply property values to null instance"</span>)<span class="comment">;</span></div><div class="line">		&#125;</div><div class="line">		<span class="meta">else</span> &#123;</div><div class="line">			// Skip property <span class="keyword">population </span>phase for null instance.</div><div class="line">			//没有可填充的属性</div><div class="line">			return<span class="comment">;</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	// Give any InstantiationAwareBeanPostProcessors the opportunity to modify the</div><div class="line">	// state of the <span class="keyword">bean </span><span class="keyword">before </span>properties are set. This can <span class="keyword">be </span>used, for example,</div><div class="line">	// to support styles of <span class="meta">field</span> injection.</div><div class="line">	<span class="keyword">boolean </span>continueWithPropertyPopulation = true<span class="comment">;</span></div><div class="line"></div><div class="line">	<span class="meta">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</div><div class="line">		for (<span class="keyword">BeanPostProcessor </span><span class="keyword">bp </span>: getBeanPostProcessors()) &#123;</div><div class="line">			<span class="meta">if</span> (<span class="keyword">bp </span>instanceof InstantiationAwareBeanPostProcessor) &#123;</div><div class="line">				InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) <span class="keyword">bp;</span></div><div class="line">				<span class="meta">if</span> (!ibp.postProcessAfterInstantiation(<span class="keyword">bw.getWrappedInstance(), </span><span class="keyword">beanName)) </span>&#123;</div><div class="line">					continueWithPropertyPopulation = false<span class="comment">;</span></div><div class="line">					<span class="keyword">break;</span></div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">    //如果后处理器发出停止填充命令则终止后续的执行</div><div class="line">	<span class="meta">if</span> (!continueWithPropertyPopulation) &#123;</div><div class="line">		return<span class="comment">;</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME <span class="title">||</span></div><div class="line">			mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123;</div><div class="line">		MutablePropertyValues newPvs = new MutablePropertyValues(pvs)<span class="comment">;</span></div><div class="line"></div><div class="line">		// <span class="keyword">Add </span>property values <span class="keyword">based </span>on autowire <span class="keyword">by </span>name <span class="meta">if</span> applicable.</div><div class="line">		//根据名称自动注入</div><div class="line">		<span class="meta">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME) &#123;</div><div class="line">			autowireByName(<span class="keyword">beanName, </span>mbd, <span class="keyword">bw, </span>newPvs)<span class="comment">;</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		// <span class="keyword">Add </span>property values <span class="keyword">based </span>on autowire <span class="keyword">by </span>type <span class="meta">if</span> applicable.</div><div class="line">		//根据类型自动注入</div><div class="line">		<span class="meta">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123;</div><div class="line">			autowireByType(<span class="keyword">beanName, </span>mbd, <span class="keyword">bw, </span>newPvs)<span class="comment">;</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		pvs = newPvs<span class="comment">;</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">    //后处理器已经初始化</div><div class="line">	<span class="keyword">boolean </span>hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors()<span class="comment">;</span></div><div class="line">	//需要检查依赖</div><div class="line">	<span class="keyword">boolean </span>needsDepCheck = (mbd.getDependencyCheck() != RootBeanDefinition.DEPENDENCY_CHECK_NONE)<span class="comment">;</span></div><div class="line"></div><div class="line">	<span class="meta">if</span> (hasInstAwareBpps <span class="title">||</span> needsDepCheck) &#123;</div><div class="line">		PropertyDescriptor[] filteredPds = filterPropertyDescriptorsForDependencyCheck(<span class="keyword">bw, </span>mbd.allowCaching)<span class="comment">;</span></div><div class="line">		<span class="meta">if</span> (hasInstAwareBpps) &#123;</div><div class="line">			for (<span class="keyword">BeanPostProcessor </span><span class="keyword">bp </span>: getBeanPostProcessors()) &#123;</div><div class="line">				<span class="meta">if</span> (<span class="keyword">bp </span>instanceof InstantiationAwareBeanPostProcessor) &#123;</div><div class="line">					InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) <span class="keyword">bp;</span></div><div class="line">					//对所有需要依赖检查的属性进行后处理</div><div class="line">					pvs = ibp.postProcessPropertyValues(pvs, filteredPds, <span class="keyword">bw.getWrappedInstance(), </span><span class="keyword">beanName);</span></div><div class="line">					<span class="meta">if</span> (pvs == null) &#123;</div><div class="line">						return<span class="comment">;</span></div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="meta">if</span> (needsDepCheck) &#123;</div><div class="line">			checkDependencies(<span class="keyword">beanName, </span>mbd, filteredPds, pvs)<span class="comment">;</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">    //将属性应用到<span class="keyword">bean中</span></div><div class="line">	applyPropertyValues(<span class="keyword">beanName, </span>mbd, <span class="keyword">bw, </span>pvs)<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">//AbstractAutowireCapableBeanFactory</div><div class="line">//根据名称自动注入</div><div class="line"><span class="symbol">protected</span> void autowireByName(</div><div class="line">		<span class="keyword">String </span><span class="keyword">beanName, </span>AbstractBeanDefinition mbd, <span class="keyword">BeanWrapper </span><span class="keyword">bw, </span>MutablePropertyValues pvs) &#123;</div><div class="line"></div><div class="line">    //寻找<span class="keyword">bw中需要依赖注入的属性</span></div><div class="line">	<span class="keyword">String[] </span>propertyNames = unsatisfiedNonSimpleProperties(mbd, <span class="keyword">bw);</span></div><div class="line">	for (<span class="keyword">String </span>propertyName : propertyNames) &#123;</div><div class="line">		<span class="meta">if</span> (containsBean(propertyName)) &#123;</div><div class="line">		    //递归初始化相关的<span class="keyword">bean</span></div><div class="line">			Object <span class="keyword">bean </span>= getBean(propertyName)<span class="comment">;</span></div><div class="line">			pvs.<span class="keyword">add(propertyName, </span><span class="keyword">bean);</span></div><div class="line">			//注册依赖</div><div class="line">			registerDependentBean(propertyName, <span class="keyword">beanName);</span></div><div class="line">			<span class="meta">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">				logger.debug(<span class="string">"Added autowiring by name from bean name '"</span> + <span class="keyword">beanName </span>+</div><div class="line">						<span class="string">"' via property '"</span> + propertyName + <span class="string">"' to bean named '"</span> + propertyName + <span class="string">"'"</span>)<span class="comment">;</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="meta">else</span> &#123;</div><div class="line">			<span class="meta">if</span> (logger.isTraceEnabled()) &#123;</div><div class="line">				logger.trace(<span class="string">"Not autowiring property '"</span> + propertyName + <span class="string">"' of bean '"</span> + <span class="keyword">beanName </span>+</div><div class="line">						<span class="string">"' by name: no matching bean found"</span>)<span class="comment">;</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//AbstractAutowireCapableBeanFactory</span></div><div class="line"><span class="comment">//根据类型自动注入</span></div><div class="line"><span class="keyword">protected</span> <span class="keyword">void</span> autowireByType(</div><div class="line">		<span class="keyword">String</span> beanName, AbstractBeanDefinition mbd, BeanWrapper bw, MutablePropertyValues pvs) &#123;</div><div class="line"></div><div class="line">	TypeConverter converter = getCustomTypeConverter();</div><div class="line">	<span class="keyword">if</span> (converter == <span class="keyword">null</span>) &#123;</div><div class="line">		converter = bw;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Set&lt;<span class="keyword">String</span>&gt; autowiredBeanNames = <span class="keyword">new</span> LinkedHashSet&lt;<span class="keyword">String</span>&gt;(<span class="number">4</span>);</div><div class="line">	<span class="comment">//寻找bw中需要依赖注入的属性</span></div><div class="line">	<span class="keyword">String</span>[] propertyNames = unsatisfiedNonSimpleProperties(mbd, bw);</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">String</span> propertyName : propertyNames) &#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			PropertyDescriptor pd = bw.getPropertyDescriptor(propertyName);</div><div class="line">			<span class="comment">// Don't try autowiring by type for type Object: never makes sense,</span></div><div class="line">			<span class="comment">// even if it technically is a unsatisfied, non-simple property.</span></div><div class="line">			<span class="keyword">if</span> (!<span class="keyword">Object</span>.class.equals(pd.getPropertyType())) &#123;</div><div class="line">			    <span class="comment">//探测指定属性的set方法</span></div><div class="line">				MethodParameter methodParam = BeanUtils.getWriteMethodParameter(pd);</div><div class="line">				<span class="comment">// Do not allow eager init for type matching in case of a prioritized post-processor.</span></div><div class="line">				<span class="built_in">boolean</span> eager = !PriorityOrdered.class.isAssignableFrom(bw.getWrappedClass());</div><div class="line">				DependencyDescriptor desc = <span class="keyword">new</span> AutowireByTypeDependencyDescriptor(methodParam, eager);</div><div class="line">				<span class="comment">//解析指定beanName的属性所匹配的值，并把解析到的属性名称存储在autowiredBeanNames中，当属性存在多个封装bean时如：Autowired private List&lt;A&gt; aList; 将会找到所有匹配A类型的bean并将其注入</span></div><div class="line">				<span class="keyword">Object</span> autowiredArgument = resolveDependency(desc, beanName, autowiredBeanNames, converter);</div><div class="line">				<span class="keyword">if</span> (autowiredArgument != <span class="keyword">null</span>) &#123;</div><div class="line">					pvs.<span class="built_in">add</span>(propertyName, autowiredArgument);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">String</span> autowiredBeanName : autowiredBeanNames) &#123;</div><div class="line">				    <span class="comment">//注册依赖</span></div><div class="line">					registerDependentBean(autowiredBeanName, beanName);</div><div class="line">					<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">						logger.debug(<span class="string">"Autowiring by type from bean name '"</span> + beanName + <span class="string">"' via property '"</span> +</div><div class="line">								propertyName + <span class="string">"' to bean named '"</span> + autowiredBeanName + <span class="string">"'"</span>);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				autowiredBeanNames.<span class="built_in">clear</span>();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">catch</span> (BeansException ex) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> UnsatisfiedDependencyException(mbd.getResourceDescription(), beanName, propertyName, ex);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//AbstractAutowireCapableBeanFactory</span></div><div class="line"><span class="comment">//将属性应用到bean中（之前获取的属性以propertyValues形式存在，还没有应用到已经实例化的bean中）</span></div><div class="line"><span class="keyword">protected</span> <span class="keyword">void</span> applyPropertyValues(<span class="keyword">String</span> beanName, BeanDefinition mbd, BeanWrapper bw, PropertyValues pvs) &#123;</div><div class="line">	<span class="keyword">if</span> (pvs == <span class="keyword">null</span> || pvs.isEmpty()) &#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	MutablePropertyValues mpvs = <span class="keyword">null</span>;</div><div class="line">	List&lt;PropertyValue&gt; original;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (System.getSecurityManager() != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">if</span> (bw <span class="keyword">instanceof</span> BeanWrapperImpl) &#123;</div><div class="line">			((BeanWrapperImpl) bw).setSecurityContext(getAccessControlContext());</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (pvs <span class="keyword">instanceof</span> MutablePropertyValues) &#123;</div><div class="line">		mpvs = (MutablePropertyValues) pvs;</div><div class="line">		<span class="keyword">if</span> (mpvs.isConverted()) &#123;</div><div class="line">			<span class="comment">// Shortcut: use the pre-converted values as-is.</span></div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				bw.setPropertyValues(mpvs);</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">catch</span> (BeansException ex) &#123;</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</div><div class="line">						mbd.getResourceDescription(), beanName, <span class="string">"Error setting property values"</span>, ex);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		original = mpvs.getPropertyValueList();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> &#123;</div><div class="line">		original = Arrays.asList(pvs.getPropertyValues());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	TypeConverter converter = getCustomTypeConverter();</div><div class="line">	<span class="keyword">if</span> (converter == <span class="keyword">null</span>) &#123;</div><div class="line">		converter = bw;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">//获取对应的解析器</span></div><div class="line">	BeanDefinitionValueResolver valueResolver = <span class="keyword">new</span> BeanDefinitionValueResolver(<span class="keyword">this</span>, beanName, mbd, converter);</div><div class="line"></div><div class="line">	<span class="comment">// Create a deep copy, resolving any references for values.</span></div><div class="line">	List&lt;PropertyValue&gt; deepCopy = <span class="keyword">new</span> ArrayList&lt;PropertyValue&gt;(original.<span class="built_in">size</span>());</div><div class="line">	<span class="built_in">boolean</span> resolveNecessary = <span class="keyword">false</span>;</div><div class="line">	<span class="comment">//遍历属性,将属性转换为对应类的对应属性的类型</span></div><div class="line">	<span class="keyword">for</span> (PropertyValue pv : original) &#123;</div><div class="line">		<span class="keyword">if</span> (pv.isConverted()) &#123;</div><div class="line">			deepCopy.<span class="built_in">add</span>(pv);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">String</span> propertyName = pv.getName();</div><div class="line">			<span class="keyword">Object</span> originalValue = pv.getValue();</div><div class="line">			<span class="keyword">Object</span> resolvedValue = valueResolver.resolveValueIfNecessary(pv, originalValue);</div><div class="line">			<span class="keyword">Object</span> convertedValue = resolvedValue;</div><div class="line">			<span class="built_in">boolean</span> convertible = bw.isWritableProperty(propertyName) &amp;&amp;</div><div class="line">					!PropertyAccessorUtils.isNestedOrIndexedProperty(propertyName);</div><div class="line">			<span class="keyword">if</span> (convertible) &#123;</div><div class="line">				convertedValue = convertForProperty(resolvedValue, propertyName, bw, converter);</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// Possibly store converted value in merged bean definition,</span></div><div class="line">			<span class="comment">// in order to avoid re-conversion for every created bean instance.</span></div><div class="line">			<span class="keyword">if</span> (resolvedValue == originalValue) &#123;</div><div class="line">				<span class="keyword">if</span> (convertible) &#123;</div><div class="line">					pv.setConvertedValue(convertedValue);</div><div class="line">				&#125;</div><div class="line">				deepCopy.<span class="built_in">add</span>(pv);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (convertible &amp;&amp; originalValue <span class="keyword">instanceof</span> TypedStringValue &amp;&amp;</div><div class="line">					!((TypedStringValue) originalValue).isDynamic() &amp;&amp;</div><div class="line">					!(convertedValue <span class="keyword">instanceof</span> Collection || ObjectUtils.isArray(convertedValue))) &#123;</div><div class="line">				pv.setConvertedValue(convertedValue);</div><div class="line">				deepCopy.<span class="built_in">add</span>(pv);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> &#123;</div><div class="line">				resolveNecessary = <span class="keyword">true</span>;</div><div class="line">				deepCopy.<span class="built_in">add</span>(<span class="keyword">new</span> PropertyValue(pv, convertedValue));</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (mpvs != <span class="keyword">null</span> &amp;&amp; !resolveNecessary) &#123;</div><div class="line">		mpvs.setConverted();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Set our (possibly massaged) deep copy.</span></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		bw.setPropertyValues(<span class="keyword">new</span> MutablePropertyValues(deepCopy));</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (BeansException ex) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> BeanCreationException(</div><div class="line">				mbd.getResourceDescription(), beanName, <span class="string">"Error setting property values"</span>, ex);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h1>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>「真诚赞赏，手留余香」</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/weixin.jpg" alt="杨辉 WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/zhifubao.jpg" alt="杨辉 Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/编程/" rel="tag"># 编程</a>
          
            <a href="/tags/Spring/" rel="tag"># Spring</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/19/微信机器人/" rel="next" title="微信机器人">
                <i class="fa fa-chevron-left"></i> 微信机器人
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/10/12/Java并发编程/" rel="prev" title="Java并发编程">
                Java并发编程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/author.jpg"
               alt="杨辉" />
          <p class="site-author-name" itemprop="name">杨辉</p>
           
              <p class="site-description motion-element" itemprop="description">淡泊以明志，宁静而致远</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">51</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">24</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/hdyang12" target="_blank" title="github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  github
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.csdn.net/qq619771478" title="CSDN" target="_blank">CSDN</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#IOC"><span class="nav-number">1.</span> <span class="nav-text">IOC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#解析"><span class="nav-number">1.1.</span> <span class="nav-text">解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注册"><span class="nav-number">1.2.</span> <span class="nav-text">注册</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bean的加载"><span class="nav-number">1.3.</span> <span class="nav-text">bean的加载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#属性注入"><span class="nav-number">1.3.1.</span> <span class="nav-text">属性注入</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#AOP"><span class="nav-number">2.</span> <span class="nav-text">AOP</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">杨辉</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

<br/>
<div class="powered-by">
<span id="busuanzi_container_site_uv"> 
  本站访客数 <span id="busuanzi_value_site_uv"></span> 人
</span>
</div>
<span id="busuanzi_container_site_pv"> 
  本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
</span>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "4e23027f183547059b04893d59788da5",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  










  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("WVkl2iB2BaJcwxurjLC9hGFS-gzGzoHsz", "MAp4EhLfpT7JJAODisjq2rSh");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

  <script type="text/javascript">  
	function IsPC() {
		var userAgentInfo = navigator.userAgent;
		var Agents = ["Android", "iPhone",
					"SymbianOS", "Windows Phone",
					"iPad", "iPod"];
		var flag = true;
		for (var v = 0; v < Agents.length; v++) {
			if (userAgentInfo.indexOf(Agents[v]) > 0) {
				flag = false;
				break;
			}
		}
		return flag;
	} 
  
var scriptNode = document.createElement("script"); 
scriptNode.setAttribute("type", "text/javascript");  
  
if(IsPC()){  
	<!-- 背景动画 -->
    scriptNode.setAttribute("src", "/js/src/particle.js");  
} 
 
document.head.appendChild(scriptNode); 
</script>
</body>
<!-- 背景动画
<script type="text/javascript" src="/js/src/particle.js"></script> -->
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>
</html>
