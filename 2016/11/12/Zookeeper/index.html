<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();
</script>








<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="编程," />





  <link rel="alternate" href="/atom.xml" title="Hui Yang's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/author.ico?v=5.1.0" />






<meta name="description" content="Zookeeper入门">
<meta name="keywords" content="编程">
<meta property="og:type" content="article">
<meta property="og:title" content="Zookeeper">
<meta property="og:url" content="http://yoursite.com/2016/11/12/Zookeeper/index.html">
<meta property="og:site_name" content="Hui Yang&#39;s Blog">
<meta property="og:description" content="Zookeeper入门">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper2.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper3.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper4.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper5.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper6.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper7.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper14.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper10.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper11.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper12.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper13.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper1.jpg">
<meta property="og:updated_time" content="2018-09-26T14:04:03.716Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zookeeper">
<meta name="twitter:description" content="Zookeeper入门">
<meta name="twitter:image" content="http://yoursite.com/uploads/zookeeper2.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2016/11/12/Zookeeper/"/>





  <title>Zookeeper | Hui Yang's Blog</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>
	<a href="https://github.com/hdyang12"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hui Yang's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/12/Zookeeper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="杨辉">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/author.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui Yang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Zookeeper</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-12T11:00:00+08:00">
                2016-11-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blog/" itemprop="url" rel="index">
                    <span itemprop="name">blog</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a class="cloud-tie-join-count" href="/2016/11/12/Zookeeper/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count join-count" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/11/12/Zookeeper/" class="leancloud_visitors" data-flag-title="Zookeeper">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  7,267 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  26 分钟
                </span>
              
            </div>
          

          
              <div class="post-description">
                  Zookeeper入门
              </div>
          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Zookeeper概述"><a href="#Zookeeper概述" class="headerlink" title="Zookeeper概述"></a>Zookeeper概述</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>随着互联网技术的高速发展，企业对计算机系统的计算、储存能力要求越来越高，最简单的证明就是出现了一些诸如：高并发，海量储存这样的词汇。在这样的背景下，单纯依靠少量高性能主机来完成计算任务已经不能满足企业的需求，企业的IT架构逐渐从集中式向分布式过渡，所谓的分布式是指：把一个计算任务分解成若干个计算单元，并且分派到若干不同的计算机中去执行，然后汇总计算结果的过程！</p>
<p>分布式系统要解决的核心任务是如何把众多的计算机协同起来完成计算任务</p>
<h2 id="Zookeeper是什么？"><a href="#Zookeeper是什么？" class="headerlink" title="Zookeeper是什么？"></a>Zookeeper是什么？</h2><p>Zookeeper是源代码开放的分布式协调服务，解决分布式数据一致性问题。它是一个分布式的服务协调组件</p>
<h2 id="Zookeeper的基本概念"><a href="#Zookeeper的基本概念" class="headerlink" title="Zookeeper的基本概念"></a>Zookeeper的基本概念</h2><h3 id="集群角色"><a href="#集群角色" class="headerlink" title="集群角色"></a>集群角色</h3><p>Leader、Follower、Observer</p>
<ul>
<li>Leader服务器是整个Zookeeper集群工作机制中的核心</li>
<li>Follower服务器是Zookeeper集群状态的跟随者</li>
<li>Observer服务器充当一个观察者的角色</li>
<li>客户端是请求发起方</li>
</ul>
<p><img src="/uploads/zookeeper2.jpg" alt=""></p>
<h3 id="心跳检测"><a href="#心跳检测" class="headerlink" title="心跳检测"></a>心跳检测</h3><p>Zk中我们让所有的机器都注册一个临时节点，我们判断一个机器是否可用，我们只需要判断这个节点在zk中是否存在就可以了。</p>
<h3 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h3><p>会话是指客户端和Zookeeper服务器的连接，Zookeeper中的会话叫Session，客户端靠与服务器建立一个TCP的长连接来维持一个Session，客户端在启动的时候首先会与服务器建立一个TCP连接，通过这个连接，客户端能够通过心跳检测与服务器保持有效的会话，也能向ZK服务器发送请求并获得响应</p>
<h2 id="Zookeeper安装"><a href="#Zookeeper安装" class="headerlink" title="Zookeeper安装"></a>Zookeeper安装</h2><ul>
<li>下载后解压安装Zookeeper包，官方下载链接点击<a href="http://hadoop.apache.org/zookeeper/releases.html" target="_blank" rel="external">这里</a></li>
<li>根据Zookeeper集群节点情况，创建如下格式的Zookeeper配置文件zoo.cfg：<figure class="highlight makefile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">tickTime=2000               //基本时间度量单位,一次心跳时间</div><div class="line">dataDir=/var/zookeeper/config</div><div class="line">clientPort=2181</div><div class="line">initLimit=5                 //初始化连接时, follower和leader之间的最长心跳时间5 * 2000ms = 10s</div><div class="line">syncLimit=2                 //请求和应答的最大时间长度 2 * 2000ms</div><div class="line"><span class="section">server.1=zoo1:2888:3888		//server.1=192.168.111.101:2888:3888	</span></div><div class="line"><span class="section">server.2=zoo2:2888:3888		//server.2=192.168.111.102:2888:3888	</span></div><div class="line"><span class="section">server.3=zoo3:2888:3888		//server.3=192.168.111.103:2888:3888</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>其中，dataDir指定Zookeeper的数据文件目录；其中server.id=host:port:port，id是为每个Zookeeper节点的编号，保存在dataDir目录下的myid文件中，zoo1~zoo3表示各个Zookeeper节点的hostname，第一个port是用于连接leader的端口(仲裁通信)，第二个port是用于leader选举的端口。</p>
<ul>
<li>在dataDir目录下创建myid文件，文件中只包含一行，且内容为该节点对应的server.id中的id编号。</li>
<li>启动Zookeeper服务：<br>通过<strong>bin/zkServer.sh</strong>脚本启动Zookeeper服务。 <code>./zkServer.sh start</code><br>查看该节点是leader还是follow：<strong>zkServer.sh status</strong><h2 id="zookeeper结构"><a href="#zookeeper结构" class="headerlink" title="zookeeper结构"></a>zookeeper结构</h2>可以简单的说，zookeeper就是一个文件系统加一个通知机制<h3 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h3>下面我们看zookeeper是如何实现协同操作的，首先，zookeeper维护了一个类似文件系统的数据结构。可以看到有根目录，根目录下有若干个子目录。每一个子目录都被称为Znode。和文件系统一样我们能够自由地增加删除znode。Znode是可以存储数据的。Zookeeper中znode可以分为4种类型：持久节点、临时节点、持久有序节点、临时有序节点<br>持久节点：<br>即使znode的创建者不再属于系统，数据也可以保存下来而不丢失。例如：<br>分配任务的主节点崩溃，但是从节点的任务分配情况也会保存下来。<br>临时节点：<br>主节点崩溃，该znode(master)和主节点一起消失–&gt;系统检测到–&gt;选举<br>有序：<br>唯一名称，创建顺序，task1,task2…</li>
</ul>
<p>文件系统可以提供很多信息。针对一个znode，如果该znode是主节点的znode没有信息，那么说明还没有选出主节点。<br>其他znode节点：<br>workers作为父节点：其下znode节点为可用从节点信息<br>tasks作为父节点：其下znode节点为等待执行任务<br>assign作为父节点：其下znode节点为分配到某从节点任务</p>
<h3 id="通知机制"><a href="#通知机制" class="headerlink" title="通知机制"></a>通知机制</h3><p>客户端注册监听它关心的目录节点，当目录节点发生变化(数据改变，被删除，子目录节点增加删除)时，zookeeper会通知客户端。</p>
<p>leader节点负责写服务和数据的同步，follow节点负责读服务。Zookeeper不允许局部写入或读取znode节点的数据。</p>
<h2 id="zookeeper-shell客户端命令简介"><a href="#zookeeper-shell客户端命令简介" class="headerlink" title="zookeeper shell客户端命令简介"></a>zookeeper shell客户端命令简介</h2><p><strong><em>zookeeper目录结构</em></strong><br><img src="/uploads/zookeeper3.jpg" alt=""><br><strong><em>客户端连接</em></strong><br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">//</span>当前目录为zookeeper目录;且连接的是当前的zookeeper;连接其他服务器的例如:.<span class="regexp">/bin/</span>zkCli.sh –server <span class="number">10.77</span>.<span class="number">20.23</span>:<span class="number">2181</span></div><div class="line">$ .<span class="regexp">/bin/</span>zkCli.sh</div></pre></td></tr></table></figure></p>
<p>连接成功<br><img src="/uploads/zookeeper4.jpg" alt=""></p>
<h3 id="ls-查看"><a href="#ls-查看" class="headerlink" title="ls 查看"></a>ls 查看</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="string">zk:</span> <span class="string">localhost:</span><span class="number">2181</span>(CONNECTED) <span class="number">0</span>] ls /</div></pre></td></tr></table></figure>
<p><img src="/uploads/zookeeper5.jpg" alt=""><br>这个命令只能看到指定节点下第一级的所有子节点<br>第一次部署的zookeeper集群，默认在根节点”/“下面有一个叫做/zookeeper的保留节点。</p>
<h3 id="create-创建节点并存储数据"><a href="#create-创建节点并存储数据" class="headerlink" title="create 创建节点并存储数据"></a>create 创建节点并存储数据</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="string">zk:</span> <span class="string">localhost:</span><span class="number">2181</span>(CONNECTED) <span class="number">1</span>] create /zhangsan <span class="string">"zhangsan"</span></div></pre></td></tr></table></figure>
<p><img src="/uploads/zookeeper6.jpg" alt=""><br>create有以下属性: [-s] [-e]<br>-s 或 -e 分别指定节点特性：顺序 或 临时节点。默认情况下，不添加-s 或 -e 参数的，创建的是不带序号的持久节点。</p>
<h3 id="get-获取内容"><a href="#get-获取内容" class="headerlink" title="get 获取内容"></a>get 获取内容</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="meta">zk: localhost:2181(CONNECTED) 10</span>] <span class="keyword">get</span> -s /zhangsan</div></pre></td></tr></table></figure>
<p><img src="/uploads/zookeeper7.jpg" alt=""><br>之前版本的zookeeper不加-s能直接看到属性信息，该版本的不加-s只能看到数据内容<br>数据及各属性信息含义：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//数据内容</span></div><div class="line"><span class="string">"zhangsan"</span></div><div class="line"><span class="comment">//创建该节点的事务ID</span></div><div class="line">cZxid = <span class="number">0x43</span></div><div class="line">ctime = Wed Sep <span class="number">26</span> <span class="number">00</span>:<span class="number">12</span>:<span class="number">28</span> CST <span class="number">2018</span></div><div class="line"><span class="comment">//最后一次更新该节点的事务ID</span></div><div class="line">mZxid = <span class="number">0x43</span></div><div class="line"><span class="comment">//最后一次更新该节点的时间</span></div><div class="line">mtime = Wed Sep <span class="number">26</span> <span class="number">00</span>:<span class="number">12</span>:<span class="number">28</span> CST <span class="number">2018</span></div><div class="line">pZxid = <span class="number">0x43</span></div><div class="line">cversion = <span class="number">0</span></div><div class="line">dataVersion = <span class="number">0</span></div><div class="line">aclVersion = <span class="number">0</span></div><div class="line">ephemeralOwner = <span class="number">0x0</span></div><div class="line">dataLength = <span class="number">10</span></div><div class="line">numChildren = <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>其中numChildren为该节点下子节点的个数<br><img src="/uploads/zookeeper14.jpg" alt=""></p>
<h3 id="set-重新设置"><a href="#set-重新设置" class="headerlink" title="set 重新设置"></a>set 重新设置</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="meta">zk: localhost:2181(CONNECTED) 11</span>] <span class="keyword">set</span> /zhangsan <span class="string">"zhangsan1"</span></div></pre></td></tr></table></figure>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="meta">zk: localhost:2181(CONNECTED) 12</span>] <span class="keyword">get</span> -s /zhangsan</div></pre></td></tr></table></figure>
<p>再次get并查看数据<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="string">"zhangsan1"</span></div><div class="line">cZxid = <span class="number">0x43</span></div><div class="line">ctime = Wed Sep <span class="number">26</span> <span class="number">00</span>:<span class="number">12</span>:<span class="number">28</span> CST <span class="number">2018</span></div><div class="line">mZxid = <span class="number">0x46</span></div><div class="line">mtime = Wed Sep <span class="number">26</span> <span class="number">00</span>:<span class="number">32</span>:<span class="number">57</span> CST <span class="number">2018</span></div><div class="line">pZxid = <span class="number">0x43</span></div><div class="line">cversion = <span class="number">0</span></div><div class="line">dataVersion = <span class="number">1</span></div><div class="line">aclVersion = <span class="number">0</span></div><div class="line">ephemeralOwner = <span class="number">0x0</span></div><div class="line">dataLength = <span class="number">11</span></div><div class="line">numChildren = <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>可以看到 数据内容、mZxid、mtime、dataVersion、dataLength属性发生了变化。</p>
<h3 id="delete-删除节点"><a href="#delete-删除节点" class="headerlink" title="delete 删除节点"></a>delete 删除节点</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="string">zk:</span> <span class="string">localhost:</span><span class="number">2181</span>(CONNECTED) <span class="number">13</span>] delete /zhangsan</div></pre></td></tr></table></figure>
<p>使用delete命令可以删除Zookeeper上的指定节点。<br>注意：想要删除某一个指定节点，该节点必须没有子节点存在。无法删除一个包含子节点的节点。<br><img src="/uploads/zookeeper10.jpg" alt=""><br>可以使用deleteall命令进行删除包含子节点的节点。</p>
<h3 id="其他命令"><a href="#其他命令" class="headerlink" title="其他命令"></a>其他命令</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="string">zk:</span> <span class="string">localhost:</span><span class="number">2181</span>(CONNECTED) <span class="number">20</span>] help</div></pre></td></tr></table></figure>
<p><img src="/uploads/zookeeper11.jpg" alt=""></p>
<h2 id="Java客户端API使用"><a href="#Java客户端API使用" class="headerlink" title="Java客户端API使用"></a>Java客户端API使用</h2><p>目前没用过，用到再介绍;主要命令和客户端的一致</p>
<h2 id="Zookeeper选举机制"><a href="#Zookeeper选举机制" class="headerlink" title="Zookeeper选举机制"></a>Zookeeper选举机制</h2><p>Leader选举是保证分布式数据一致性的关键所在。当Zookeeper集群中的一台服务器出现以下两种情况之一时，需要进入Leader选举。</p>
<ul>
<li>服务器初始化启动。</li>
<li>服务器运行期间无法和Leader保持连接。</li>
</ul>
<h3 id="服务器启动时期的Leader选举"><a href="#服务器启动时期的Leader选举" class="headerlink" title="服务器启动时期的Leader选举"></a>服务器启动时期的Leader选举</h3><ol>
<li><p>每个Server发出一个投票。由于是初始情况，Server1和Server2都会将自己作为Leader服务器来进行投票，每次投票会包含所推举的服务器的myid和ZXID，使用(myid, ZXID)来表示，此时Server1的投票为(1, 0)，Server2的投票为(2, 0)，然后各自将这个投票发给集群中其他机器。</p>
</li>
<li><p>接受来自各个服务器的投票。集群的每个服务器收到投票后，首先判断该投票的有效性，如检查是否是本轮投票、是否来自LOOKING状态的服务器。</p>
</li>
<li><p>处理投票。针对每一个投票，服务器都需要将别人的投票和自己的投票进行PK，PK规则如下</p>
<ul>
<li>优先检查ZXID。ZXID比较大的服务器优先作为Leader。</li>
<li><p>如果ZXID相同，那么就比较myid。myid较大的服务器作为Leader服务器。</p>
<p>对于Server1而言，它的投票是(1, 0)，接收Server2的投票为(2, 0)，首先会比较两者的ZXID，均为0，再比较myid，此时Server2的myid最大，于是更新自己的投票为(2, 0)，然后重新投票，对于Server2而言，其无须更新自己的投票，只是再次向集群中所有机器发出上一次投票信息即可。</p>
</li>
</ul>
</li>
<li><p>统计投票。每次投票后，服务器都会统计投票信息，判断是否已经有过半机器接受到相同的投票信息，对于Server1、Server2而言，都统计出集群中已经有两台机器接受了(2, 0)的投票信息，此时便认为已经选出了Leader。</p>
</li>
<li><p>改变服务器状态。一旦确定了Leader，每个服务器就会更新自己的状态，如果是Follower，那么就变更为FOLLOWING，如果是Leader，就变更为LEADING。</p>
</li>
</ol>
<p>简单例子<br>服务器1启动，无其他节点，得不到响应，选举状态为LOOKING状态<br>服务器2启动，没有历史数据，都选自己，2的id大，所以1同意2为leader，但是未过半数，服务器1/2状态依然为LOOKING<br>服务器3启动，1和2有历史数据，都选2，服务器3选自己，2的票数为2,2/3超过半数，2为leader<br>服务器4启动，发起投票，1/2/3根据历史数据选2，leader为2。</p>
<h3 id="服务器运行时期的Leader选举"><a href="#服务器运行时期的Leader选举" class="headerlink" title="服务器运行时期的Leader选举"></a>服务器运行时期的Leader选举</h3><p>在Zookeeper运行期间，Leader与非Leader服务器各司其职，即便当有非Leader服务器宕机或新加入，此时也不会影响Leader，但是一旦Leader服务器挂了，那么整个集群将暂停对外服务，进入新一轮Leader选举，其过程和启动时期的Leader选举过程基本一致。假设正在运行的有Server1、Server2、Server3三台服务器，当前Leader是Server2，若某一时刻Leader挂了，此时便开始Leader选举。选举过程如下</p>
<ol>
<li><p>变更状态。Leader挂后，余下的非Observer服务器都会讲自己的服务器状态变更为LOOKING，然后开始进入Leader选举过程。</p>
</li>
<li><p>每个Server会发出一个投票。在运行期间，每个服务器上的ZXID可能不同，此时假定Server1的ZXID为123，Server3的ZXID为122；在第一轮投票中，Server1和Server3都会投自己，产生投票(1, 123)，(3, 122)，然后各自将投票发送给集群中所有机器。</p>
</li>
<li><p>接收来自各个服务器的投票。与启动时过程相同。</p>
</li>
<li><p>处理投票。与启动时过程相同，此时，Server1将会成为Leader。</p>
</li>
<li><p>统计投票。与启动时过程相同。</p>
</li>
<li><p>改变服务器的状态。与启动时过程相同。</p>
</li>
</ol>
<h3 id="Leader选举算法分析"><a href="#Leader选举算法分析" class="headerlink" title="Leader选举算法分析"></a>Leader选举算法分析</h3><p><strong><em>在3.4.0后的Zookeeper的版本只保留了TCP版本的FastLeaderElection选举算法。</em></strong></p>
<p>当一台机器进入Leader选举时，当前集群可能会处于以下两种状态</p>
<ul>
<li><p>集群中已经存在Leader。</p>
</li>
<li><p>集群中不存在Leader。</p>
</li>
</ul>
<p>对于集群中已经存在Leader而言，此种情况一般都是某台机器启动得较晚，在其启动之前，集群已经在正常工作，对这种情况，该机器试图去选举Leader时，会被告知当前服务器的Leader信息，对于该机器而言，仅仅需要和Leader机器建立起连接，并进行状态同步即可。</p>
<p>而在集群中不存在Leader情况下则会相对复杂，其步骤如下：</p>
<ol>
<li><p>第一次投票。无论哪种导致进行Leader选举，集群的所有机器都处于试图选举出一个Leader的状态，即LOOKING状态，LOOKING机器会向所有其他机器发送消息，该消息称为投票。投票中包含了SID（服务器的唯一标识）和ZXID（事务ID），(SID, ZXID)形式来标识一次投票信息。假定Zookeeper由5台机器组成，SID分别为1、2、3、4、5，ZXID分别为9、9、9、8、8，并且此时SID为2的机器是Leader机器，某一时刻，1、2所在机器出现故障，因此集群开始进行Leader选举。在第一次投票时，每台机器都会将自己作为投票对象，于是SID为3、4、5的机器投票情况分别为(3, 9)，(4, 8)， (5, 8)。</p>
</li>
<li><p>变更投票。每台机器发出投票后，也会收到其他机器的投票，每台机器会根据一定规则来处理收到的其他机器的投票，并以此来决定是否需要变更自己的投票，这个规则也是整个Leader选举算法的核心所在，其中术语描述如下</p>
<ul>
<li><p>vote_sid：接收到的投票中所推举Leader服务器的SID。</p>
</li>
<li><p>vote_zxid：接收到的投票中所推举Leader服务器的ZXID。</p>
</li>
<li><p>self_sid：当前服务器自己的SID。</p>
</li>
<li><p>self_zxid：当前服务器自己的ZXID。</p>
<p>每次对收到的投票的处理，都是对(vote_sid, vote_zxid)和(self_sid, self_zxid)对比的过程。<br>规则一：如果vote_zxid大于self_zxid，就认可当前收到的投票，并再次将该投票发送出去。<br>规则二：如果vote_zxid小于self_zxid，那么坚持自己的投票，不做任何变更。<br>规则三：如果vote_zxid等于self_zxid，那么就对比两者的SID，如果vote_sid大于self_sid，那么就认可当前收到的投票，并再次将该投票发送出去。<br>规则四：如果vote_zxid等于self_zxid，并且vote_sid小于self_sid，那么坚持自己的投票，不做任何变更。</p>
<p>结合上面规则，给出下面的集群变更过程:<br><img src="/uploads/zookeeper12.jpg" alt=""></p>
</li>
</ul>
</li>
<li><p>确定Leader。经过第二轮投票后，集群中的每台机器都会再次接收到其他机器的投票，然后开始统计投票，如果一台机器收到了超过半数的相同投票，那么这个投票对应的SID机器即为Leader。此时Server3将成为Leader。</p>
</li>
</ol>
<p>由上面规则可知，通常那台服务器上的数据越新（ZXID会越大），其成为Leader的可能性越大，也就越能够保证数据的恢复。如果ZXID相同，则SID越大机会越大。</p>
<h3 id="Leader选举实现细节"><a href="#Leader选举实现细节" class="headerlink" title="Leader选举实现细节"></a>Leader选举实现细节</h3><h4 id="服务器状态"><a href="#服务器状态" class="headerlink" title="服务器状态"></a>服务器状态</h4><p>服务器具有四种状态，分别是LOOKING、FOLLOWING、LEADING、OBSERVING。</p>
<ul>
<li><p>LOOKING：寻找Leader状态。当服务器处于该状态时，它会认为当前集群中没有Leader，因此需要进入Leader选举状态。</p>
</li>
<li><p>FOLLOWING：跟随者状态。表明当前服务器角色是Follower。</p>
</li>
<li><p>LEADING：领导者状态。表明当前服务器角色是Leader。</p>
</li>
<li><p>OBSERVING：观察者状态。表明当前服务器角色是Observer。</p>
</li>
</ul>
<h4 id="投票数据结构"><a href="#投票数据结构" class="headerlink" title="投票数据结构"></a>投票数据结构</h4><p>每个投票中包含了两个最基本的信息，所推举服务器的SID和ZXID。<br>投票（Vote）在Zookeeper中包含字段如下：</p>
<ul>
<li><p>id：被推举的Leader的SID。</p>
</li>
<li><p>zxid：被推举的Leader事务ID。</p>
</li>
<li><p>electionEpoch：逻辑时钟，用来判断多个投票是否在同一轮选举周期中，该值在服务端是一个自增序列，每次进入新一轮的投票后，都会对该值进行加1操作。</p>
</li>
<li><p>peerEpoch：被推举的Leader的epoch。每次leader选举完成之后，都会选举出一个新的peerEpoch，用来标记事务请求所属的轮次。</p>
</li>
<li><p>state：当前服务器的状态。</p>
</li>
</ul>
<h4 id="QuorumCnxManager：网络I-O"><a href="#QuorumCnxManager：网络I-O" class="headerlink" title="QuorumCnxManager：网络I/O"></a>QuorumCnxManager：网络I/O</h4><p>每台服务器在启动的过程中，会启动一个QuorumPeerManager，负责各台服务器之间的底层Leader选举过程中的网络通信。</p>
<ol>
<li><p>消息队列。QuorumCnxManager内部维护了一系列的队列，用来保存接收到的、待发送的消息以及消息的发送器，除接收队列以外，其他队列都按照SID分组形成队列集合，如一个集群中除了自身还有3台机器，那么就会为这3台机器分别创建一个发送队列，互不干扰。</p>
<ul>
<li><p>recvQueue：消息接收队列，用于存放那些从其他服务器接收到的消息。</p>
</li>
<li><p>queueSendMap：消息发送队列，用于保存那些待发送的消息，按照SID进行分组。</p>
</li>
<li><p>senderWorkerMap：发送器集合，每个SenderWorker消息发送器，都对应一台远程Zookeeper服务器，负责消息的发送，也按照SID进行分组。</p>
</li>
<li><p>lastMessageSent：最近发送过的消息，为每个SID保留最近发送过的一个消息。</p>
</li>
</ul>
</li>
<li><p>建立连接。为了能够相互投票，Zookeeper集群中的所有机器都需要两两建立起网络连接。QuorumCnxManager在启动时会创建一个ServerSocket来监听Leader选举的通信端口(默认为3888)。开启监听后，Zookeeper能够不断地接收到来自其他服务器的创建连接请求，在接收到其他服务器的TCP连接请求时，会进行处理。为了避免两台机器之间重复地创建TCP连接，Zookeeper只允许SID大的服务器主动和其他机器建立连接，否则断开连接。在接收到创建连接请求后，服务器通过对比自己和远程服务器的SID值来判断是否接收连接请求，如果当前服务器发现自己的SID更大，那么会断开当前连接，然后自己主动和远程服务器建立连接。一旦连接建立，就会根据远程服务器的SID来创建相应的消息发送器SendWorker和消息接收器RecvWorker，并启动。</p>
</li>
<li><p>消息接收与发送。消息接收：由消息接收器RecvWorker负责，由于Zookeeper为每个远程服务器都分配一个单独的RecvWorker，因此，每个RecvWorker只需要不断地从这个TCP连接中读取消息，并将其保存到recvQueue队列中。消息发送：由于Zookeeper为每个远程服务器都分配一个单独的SendWorker，因此，每个SendWorker只需要不断地从对应的消息发送队列中获取出一个消息发送即可，同时将这个消息放入lastMessageSent中。在SendWorker中，一旦Zookeeper发现针对当前服务器的消息发送队列为空，那么此时需要从lastMessageSent中取出一个最近发送过的消息来进行再次发送，这是为了解决接收方在消息接收前或者接收到消息后服务器挂了，导致消息尚未被正确处理。同时，Zookeeper能够保证接收方在处理消息时，会对重复消息进行正确的处理。</p>
</li>
</ol>
<h4 id="FastLeaderElection：选举算法核心"><a href="#FastLeaderElection：选举算法核心" class="headerlink" title="FastLeaderElection：选举算法核心"></a>FastLeaderElection：选举算法核心</h4><ul>
<li><p>外部投票：特指其他服务器发来的投票。</p>
</li>
<li><p>内部投票：服务器自身当前的投票。</p>
</li>
<li><p>选举轮次：Zookeeper服务器Leader选举的轮次，即logicalclock。</p>
</li>
<li><p>PK：对内部投票和外部投票进行对比来确定是否需要变更内部投票。</p>
</li>
</ul>
<h5 id="选票管理"><a href="#选票管理" class="headerlink" title="选票管理"></a>选票管理</h5><ul>
<li><p>sendqueue：选票发送队列，用于保存待发送的选票。</p>
</li>
<li><p>recvqueue：选票接收队列，用于保存接收到的外部投票。</p>
</li>
<li><p>WorkerReceiver：选票接收器。其会不断地从QuorumCnxManager中获取其他服务器发来的选举消息，并将其转换成一个选票，然后保存到recvqueue中，在选票接收过程中，如果发现该外部选票的选举轮次小于当前服务器的，那么忽略该外部投票，同时立即发送自己的内部投票。</p>
</li>
<li><p>WorkerSender：选票发送器，不断地从sendqueue中获取待发送的选票，并将其传递到底层QuorumCnxManager中。</p>
</li>
</ul>
<h5 id="算法核心"><a href="#算法核心" class="headerlink" title="算法核心"></a>算法核心</h5><p><img src="/uploads/zookeeper13.jpg" alt=""></p>
<p>　　上图展示了FastLeaderElection模块是如何与底层网络I/O进行交互的。Leader选举的基本流程如下</p>
<ol>
<li><p>自增选举轮次。Zookeeper规定所有有效的投票都必须在同一轮次中，在开始新一轮投票时，会首先对logicalclock进行自增操作。</p>
</li>
<li><p>初始化选票。在开始进行新一轮投票之前，每个服务器都会初始化自身的选票，并且在初始化阶段，每台服务器都会将自己推举为Leader。</p>
</li>
<li><p>发送初始化选票。完成选票的初始化后，服务器就会发起第一次投票。Zookeeper会将刚刚初始化好的选票放入sendqueue中，由发送器WorkerSender负责发送出去。</p>
</li>
<li><p>接收外部投票。每台服务器会不断地从recvqueue队列中获取外部选票。如果服务器发现无法获取到任何外部投票，那么就会立即确认自己是否和集群中其他服务器保持着有效的连接，如果没有连接，则马上建立连接，如果已经建立了连接，则再次发送自己当前的内部投票。</p>
</li>
<li><p>判断选举轮次。在发送完初始化选票之后，接着开始处理外部投票。在处理外部投票时，会根据选举轮次来进行不同的处理。</p>
<ul>
<li><p>外部投票的选举轮次大于内部投票。若服务器自身的选举轮次落后于该外部投票对应服务器的选举轮次，那么就会立即更新自己的选举轮次(logicalclock)，并且清空所有已经收到的投票，然后使用初始化的投票来进行PK以确定是否变更内部投票。最终再将内部投票发送出去。</p>
</li>
<li><p>外部投票的选举轮次小于内部投票。若服务器接收的外选票的选举轮次落后于自身的选举轮次，那么Zookeeper就会直接忽略该外部投票，不做任何处理，并返回步骤4。</p>
</li>
<li><p>外部投票的选举轮次等于内部投票。此时可以开始进行选票PK。</p>
</li>
</ul>
</li>
<li><p>选票PK。在进行选票PK时，符合任意一个条件就需要变更投票。</p>
<ul>
<li><p>若外部投票中推举的Leader服务器的选举轮次大于内部投票，那么需要变更投票。</p>
</li>
<li><p>若选举轮次一致，那么就对比两者的ZXID，若外部投票的ZXID大，那么需要变更投票。</p>
</li>
<li><p>若两者的ZXID一致，那么就对比两者的SID，若外部投票的SID大，那么就需要变更投票。</p>
</li>
</ul>
</li>
<li><p>变更投票。经过PK后，若确定了外部投票优于内部投票，那么就变更投票，即使用外部投票的选票信息来覆盖内部投票，变更完成后，再次将这个变更后的内部投票发送出去。</p>
</li>
<li><p>选票归档。无论是否变更了投票，都会将刚刚收到的那份外部投票放入选票集合recvset中进行归档。recvset用于记录当前服务器在本轮次的Leader选举中收到的所有外部投票（按照服务队的SID区别，如{(1, vote1), (2, vote2)…}）。</p>
</li>
<li><p>统计投票。完成选票归档后，就可以开始统计投票，统计投票是为了统计集群中是否已经有过半的服务器认可了当前的内部投票，如果确定已经有过半服务器认可了该投票，则终止投票。否则返回步骤4。</p>
</li>
<li><p>更新服务器状态。若已经确定可以终止投票，那么就开始更新服务器状态，服务器首选判断当前被过半服务器认可的投票所对应的Leader服务器是否是自己，若是自己，则将自己的服务器状态更新为LEADING，若不是，则根据具体情况来确定自己是FOLLOWING或是OBSERVING。</p>
</li>
</ol>
<p>以上10个步骤就是FastLeaderElection的核心，其中步骤4-9会经过几轮循环，直到有Leader选举产生。</p>
<p>可能出现的问题：<br>选举轮次，也就是逻辑时钟，即logicalclock。这个值，不会频繁变化，一次选举，自增一次。一次选举过程中，可能包括多次投票，投票不涉及逻辑时钟的自增。<br>举例，初始情况下5台机器，sid分别为1、2、3、4、5，逻辑时钟都是0。依次启动后，开始选举，所有的机器逻辑时钟自增为1。经过多次投票，假设第三台机器为leader，其他4台机器为follower，此时5台机器的逻辑时钟都为1。<br>一般情况下，逻辑时钟应该都是相同的。但是，由于一些机器崩溃的问题，是可能出现逻辑时钟不一致的情况的。例如，上例中，sid=3的机器为leader。之后某一刻，sid为1、3的机器崩溃，zookeeper仍然可以正常对外提供服务。但需要重新选主，剩下的2、4、5重新投票选主，假设sid=5成为新的leader，逻辑时钟自增，由1变成2。之后某一刻，sid为5的机器奔溃，sid为1的机器复活，仍然有3台机器运行，zookeeper可以对外提供服务，但需要重新选主。重新选主，逻辑时钟自增，这时sid为2、4的机器的逻辑时钟是由2自增为3，而sid为1的机器的逻辑时钟是由1自增为2。这种情况下，就出现了逻辑时钟不一致的情况。这时，需要清除sid为1的机器内部的投票数据，因为这些投票数据都是过时的数据。</p>
<h4 id="选举源码实现"><a href="#选举源码实现" class="headerlink" title="选举源码实现"></a>选举源码实现</h4><h2 id="Zookeeper的典型应用场景："><a href="#Zookeeper的典型应用场景：" class="headerlink" title="Zookeeper的典型应用场景："></a>Zookeeper的典型应用场景：</h2><h3 id="统一命名服务"><a href="#统一命名服务" class="headerlink" title="统一命名服务"></a>统一命名服务</h3><p>在分布式系统中，通过使用命名服务，客户端应用能够根据指定名字来获取资源或服务的地址，提供者等信息。被命名的实体通常可以是集群中的机器，提供的服务地址，远程对象等等——这些我们都可以统称他们为名字（Name）</p>
<h3 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h3><p>配置的管理在分布式应用环境中很常见，例如同一个应用系统需要多台 PC Server 运行，但是它们运行的应用系统的某些配置项是相同的，如果要修改这些相同的配置项，那么就必须同时修改每台运行这个应用系统的 PC Server，这样非常麻烦而且容易出错。</p>
<p>像这样的配置信息完全可以交给 Zookeeper 来管理，将配置信息保存在 Zookeeper 的某个目录节点中，然后将所有需要修改的应用机器监控配置信息的状态，一旦配置信息发生变化，每台应用机器就会收到 Zookeeper 的通知，然后从 Zookeeper 获取新的配置信息应用到系统中</p>
<h3 id="集群管理"><a href="#集群管理" class="headerlink" title="集群管理"></a>集群管理</h3><p>Zookeeper 能够很容易的实现集群管理的功能，如有多台 Server 组成一个服务集群，那么必须要一个“总管”知道当前集群中每台机器的服务状态，一旦有机器不能提供服务，集群中其它集群必须知道，从而做出调整重新分配服务策略。同样当增加集群的服务能力时，就会增加一台或多台 Server，同样也必须让“总管”知道。</p>
<h3 id="共享锁"><a href="#共享锁" class="headerlink" title="共享锁"></a>共享锁</h3><p>共享锁在同一个进程中很容易实现，但是在跨进程或者在不同 Server 之间就不好实现了。Zookeeper 却很容易实现这个功能，实现方式也是需要获得锁的 Server 创建一个 EPHEMERAL_SEQUENTIAL 目录节点，然后调用 getChildren方法获取当前的目录节点列表中最小的目录节点是不是就是自己创建的目录节点，如果正是自己创建的，那么它就获得了这个锁，如果不是那么它就调用 exists(String path, boolean watch) 方法并监控 Zookeeper 上目录节点列表的变化，一直到自己创建的节点是列表中最小编号的目录节点，从而获得锁，释放锁很简单，只要删除前面它自己所创建的目录节点就行了。<br><img src="/uploads/zookeeper1.jpg" alt=""></p>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>在分布式环境中，为了保证高可用性，通常同一个应用或同一个服务的提供方都会部署多份，达到对等服务。而消费者就须要在这些对等的服务器中选择一个来执行相关的业务逻辑。</p>
<h3 id="分布式通知-协调"><a href="#分布式通知-协调" class="headerlink" title="分布式通知/协调"></a>分布式通知/协调</h3><p>ZooKeeper中特有watcher注册与异步通知机制，能够很好的实现分布式环境下不同系统之间的通知与协调，实现对数据变更的实时处理。使用方法通常是不同系统都对ZK上同一个znode进行注册，监听znode的变化（包括znode本身内容及子节点的），其中一个系统update了znode，那么另一个系统能够收到通知，并作出相应处理</p>
<h2 id="Zookeeper的优势"><a href="#Zookeeper的优势" class="headerlink" title="Zookeeper的优势"></a>Zookeeper的优势</h2><p>1.源代码开放<br>2.已经被证实是高性能，易用稳定的工业级产品<br>3.有着广泛的应用：Hadoop、HBase、kafaka、Storm、Solr</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>「真诚赞赏，手留余香」</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/weixin.jpg" alt="杨辉 WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/zhifubao.jpg" alt="杨辉 Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/编程/" rel="tag"># 编程</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/09/20/集合框架/" rel="next" title="集合框架">
                <i class="fa fa-chevron-left"></i> 集合框架
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/01/01/留言板/" rel="prev" title="留言板">
                留言板 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/author.jpg"
               alt="杨辉" />
          <p class="site-author-name" itemprop="name">杨辉</p>
           
              <p class="site-description motion-element" itemprop="description">淡泊以明志，宁静而致远</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">52</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">24</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/hdyang12" target="_blank" title="github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  github
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.csdn.net/qq619771478" title="CSDN" target="_blank">CSDN</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Zookeeper概述"><span class="nav-number">1.</span> <span class="nav-text">Zookeeper概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#背景"><span class="nav-number">1.1.</span> <span class="nav-text">背景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zookeeper是什么？"><span class="nav-number">2.</span> <span class="nav-text">Zookeeper是什么？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zookeeper的基本概念"><span class="nav-number">3.</span> <span class="nav-text">Zookeeper的基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群角色"><span class="nav-number">3.1.</span> <span class="nav-text">集群角色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#心跳检测"><span class="nav-number">3.2.</span> <span class="nav-text">心跳检测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#会话"><span class="nav-number">3.3.</span> <span class="nav-text">会话</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zookeeper安装"><span class="nav-number">4.</span> <span class="nav-text">Zookeeper安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#zookeeper结构"><span class="nav-number">5.</span> <span class="nav-text">zookeeper结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#文件系统"><span class="nav-number">5.1.</span> <span class="nav-text">文件系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通知机制"><span class="nav-number">5.2.</span> <span class="nav-text">通知机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#zookeeper-shell客户端命令简介"><span class="nav-number">6.</span> <span class="nav-text">zookeeper shell客户端命令简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ls-查看"><span class="nav-number">6.1.</span> <span class="nav-text">ls 查看</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#create-创建节点并存储数据"><span class="nav-number">6.2.</span> <span class="nav-text">create 创建节点并存储数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#get-获取内容"><span class="nav-number">6.3.</span> <span class="nav-text">get 获取内容</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#set-重新设置"><span class="nav-number">6.4.</span> <span class="nav-text">set 重新设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#delete-删除节点"><span class="nav-number">6.5.</span> <span class="nav-text">delete 删除节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他命令"><span class="nav-number">6.6.</span> <span class="nav-text">其他命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Java客户端API使用"><span class="nav-number">7.</span> <span class="nav-text">Java客户端API使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zookeeper选举机制"><span class="nav-number">8.</span> <span class="nav-text">Zookeeper选举机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务器启动时期的Leader选举"><span class="nav-number">8.1.</span> <span class="nav-text">服务器启动时期的Leader选举</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务器运行时期的Leader选举"><span class="nav-number">8.2.</span> <span class="nav-text">服务器运行时期的Leader选举</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Leader选举算法分析"><span class="nav-number">8.3.</span> <span class="nav-text">Leader选举算法分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Leader选举实现细节"><span class="nav-number">8.4.</span> <span class="nav-text">Leader选举实现细节</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#服务器状态"><span class="nav-number">8.4.1.</span> <span class="nav-text">服务器状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#投票数据结构"><span class="nav-number">8.4.2.</span> <span class="nav-text">投票数据结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#QuorumCnxManager：网络I-O"><span class="nav-number">8.4.3.</span> <span class="nav-text">QuorumCnxManager：网络I/O</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FastLeaderElection：选举算法核心"><span class="nav-number">8.4.4.</span> <span class="nav-text">FastLeaderElection：选举算法核心</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#选票管理"><span class="nav-number">8.4.4.1.</span> <span class="nav-text">选票管理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#算法核心"><span class="nav-number">8.4.4.2.</span> <span class="nav-text">算法核心</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#选举源码实现"><span class="nav-number">8.4.5.</span> <span class="nav-text">选举源码实现</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zookeeper的典型应用场景："><span class="nav-number">9.</span> <span class="nav-text">Zookeeper的典型应用场景：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#统一命名服务"><span class="nav-number">9.1.</span> <span class="nav-text">统一命名服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置管理"><span class="nav-number">9.2.</span> <span class="nav-text">配置管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群管理"><span class="nav-number">9.3.</span> <span class="nav-text">集群管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#共享锁"><span class="nav-number">9.4.</span> <span class="nav-text">共享锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#负载均衡"><span class="nav-number">9.5.</span> <span class="nav-text">负载均衡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式通知-协调"><span class="nav-number">9.6.</span> <span class="nav-text">分布式通知/协调</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zookeeper的优势"><span class="nav-number">10.</span> <span class="nav-text">Zookeeper的优势</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">杨辉</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

<br/>
<div class="powered-by">
<span id="busuanzi_container_site_uv"> 
  本站访客数 <span id="busuanzi_value_site_uv"></span> 人
</span>
</div>
<span id="busuanzi_container_site_pv"> 
  本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
</span>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "4e23027f183547059b04893d59788da5",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  










  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("WVkl2iB2BaJcwxurjLC9hGFS-gzGzoHsz", "MAp4EhLfpT7JJAODisjq2rSh");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

  <script type="text/javascript">  
	function IsPC() {
		var userAgentInfo = navigator.userAgent;
		var Agents = ["Android", "iPhone",
					"SymbianOS", "Windows Phone",
					"iPad", "iPod"];
		var flag = true;
		for (var v = 0; v < Agents.length; v++) {
			if (userAgentInfo.indexOf(Agents[v]) > 0) {
				flag = false;
				break;
			}
		}
		return flag;
	} 
  
var scriptNode = document.createElement("script"); 
scriptNode.setAttribute("type", "text/javascript");  
  
if(IsPC()){  
	<!-- 背景动画 -->
    scriptNode.setAttribute("src", "/js/src/particle.js");  
} 
 
document.head.appendChild(scriptNode); 
</script>
</body>
<!-- 背景动画
<script type="text/javascript" src="/js/src/particle.js"></script> -->
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>
</html>
