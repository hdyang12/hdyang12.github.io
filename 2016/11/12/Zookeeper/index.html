<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();
</script>








<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="编程," />





  <link rel="alternate" href="/atom.xml" title="Hui Yang's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/author.ico?v=5.1.0" />






<meta name="description" content="Zookeeper入门">
<meta name="keywords" content="编程">
<meta property="og:type" content="article">
<meta property="og:title" content="Zookeeper">
<meta property="og:url" content="http://yoursite.com/2016/11/12/Zookeeper/index.html">
<meta property="og:site_name" content="Hui Yang&#39;s Blog">
<meta property="og:description" content="Zookeeper入门">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper2.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper3.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper4.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper5.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper6.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper7.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper14.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper10.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper11.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper12.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper13.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper1.jpg">
<meta property="og:image" content="http://yoursite.com/uploads/zookeeper15.jpg">
<meta property="og:updated_time" content="2018-10-16T16:07:27.299Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zookeeper">
<meta name="twitter:description" content="Zookeeper入门">
<meta name="twitter:image" content="http://yoursite.com/uploads/zookeeper2.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2016/11/12/Zookeeper/"/>





  <title>Zookeeper | Hui Yang's Blog</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>
	<a href="https://github.com/hdyang12"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png"></a>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hui Yang's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/11/12/Zookeeper/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="杨辉">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/author.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hui Yang's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Zookeeper</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-11-12T11:00:00+08:00">
                2016-11-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/blog/" itemprop="url" rel="index">
                    <span itemprop="name">blog</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a class="cloud-tie-join-count" href="/2016/11/12/Zookeeper/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count join-count" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2016/11/12/Zookeeper/" class="leancloud_visitors" data-flag-title="Zookeeper">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  15,774 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  65 分钟
                </span>
              
            </div>
          

          
              <div class="post-description">
                  Zookeeper入门
              </div>
          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="Zookeeper概述"><a href="#Zookeeper概述" class="headerlink" title="Zookeeper概述"></a>Zookeeper概述</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>随着互联网技术的高速发展，企业对计算机系统的计算、储存能力要求越来越高，最简单的证明就是出现了一些诸如：高并发，海量储存这样的词汇。在这样的背景下，单纯依靠少量高性能主机来完成计算任务已经不能满足企业的需求，企业的IT架构逐渐从集中式向分布式过渡，所谓的分布式是指：把一个计算任务分解成若干个计算单元，并且分派到若干不同的计算机中去执行，然后汇总计算结果的过程！</p>
<p>分布式系统要解决的核心任务是如何把众多的计算机协同起来完成计算任务</p>
<h2 id="Zookeeper是什么？"><a href="#Zookeeper是什么？" class="headerlink" title="Zookeeper是什么？"></a>Zookeeper是什么？</h2><p>Zookeeper是源代码开放的分布式协调服务，解决分布式数据一致性问题。它是一个分布式的服务协调组件</p>
<h2 id="Zookeeper的基本概念"><a href="#Zookeeper的基本概念" class="headerlink" title="Zookeeper的基本概念"></a>Zookeeper的基本概念</h2><h3 id="集群角色"><a href="#集群角色" class="headerlink" title="集群角色"></a>集群角色</h3><p>Leader、Follower、Observer</p>
<ul>
<li>Leader服务器是整个Zookeeper集群工作机制中的核心</li>
<li>Follower服务器是Zookeeper集群状态的跟随者</li>
<li>Observer服务器充当一个观察者的角色</li>
<li>客户端是请求发起方</li>
</ul>
<p><img src="/uploads/zookeeper2.jpg" alt=""></p>
<h3 id="心跳检测"><a href="#心跳检测" class="headerlink" title="心跳检测"></a>心跳检测</h3><p>Zk中我们让所有的机器都注册一个临时节点，我们判断一个机器是否可用，我们只需要判断这个节点在zk中是否存在就可以了。</p>
<h3 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h3><p>会话是指客户端和Zookeeper服务器的连接，Zookeeper中的会话叫Session，客户端靠与服务器建立一个TCP的长连接来维持一个Session，客户端在启动的时候首先会与服务器建立一个TCP连接，通过这个连接，客户端能够通过心跳检测与服务器保持有效的会话，也能向ZK服务器发送请求并获得响应</p>
<h2 id="Zookeeper安装"><a href="#Zookeeper安装" class="headerlink" title="Zookeeper安装"></a>Zookeeper安装</h2><ul>
<li>下载后解压安装Zookeeper包，官方下载链接点击<a href="http://hadoop.apache.org/zookeeper/releases.html" target="_blank" rel="external">这里</a></li>
<li>根据Zookeeper集群节点情况，创建如下格式的Zookeeper配置文件zoo.cfg：<figure class="highlight makefile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">tickTime=2000               //基本时间度量单位,一次心跳时间</div><div class="line">dataDir=/var/zookeeper/config</div><div class="line">clientPort=2181</div><div class="line">initLimit=5                 //初始化连接时, follower和leader之间的最长心跳时间5 * 2000ms = 10s</div><div class="line">syncLimit=2                 //请求和应答的最大时间长度 2 * 2000ms</div><div class="line"><span class="section">server.1=zoo1:2888:3888		//server.1=192.168.111.101:2888:3888	</span></div><div class="line"><span class="section">server.2=zoo2:2888:3888		//server.2=192.168.111.102:2888:3888	</span></div><div class="line"><span class="section">server.3=zoo3:2888:3888		//server.3=192.168.111.103:2888:3888</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>其中，dataDir指定Zookeeper的数据文件目录；其中server.id=host:port:port，id是为每个Zookeeper节点的编号，保存在dataDir目录下的myid文件中，zoo1~zoo3表示各个Zookeeper节点的hostname，第一个port是用于连接leader的端口(仲裁通信)，第二个port是用于leader选举的端口。</p>
<ul>
<li>在dataDir目录下创建myid文件，文件中只包含一行，且内容为该节点对应的server.id中的id编号。</li>
<li>启动Zookeeper服务：<br>通过<strong>bin/zkServer.sh</strong>脚本启动Zookeeper服务。 <code>./zkServer.sh start</code><br>查看该节点是leader还是follow：<strong>zkServer.sh status</strong><h2 id="zookeeper结构"><a href="#zookeeper结构" class="headerlink" title="zookeeper结构"></a>zookeeper结构</h2>可以简单的说，zookeeper就是一个文件系统加一个通知机制<h3 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h3>下面我们看zookeeper是如何实现协同操作的，首先，zookeeper维护了一个类似文件系统的数据结构。可以看到有根目录，根目录下有若干个子目录。每一个子目录都被称为Znode。和文件系统一样我们能够自由地增加删除znode。Znode是可以存储数据的。Zookeeper中znode可以分为4种类型：持久节点、临时节点、持久有序节点、临时有序节点<br>持久节点：<br>即使znode的创建者不再属于系统，数据也可以保存下来而不丢失。例如：<br>分配任务的主节点崩溃，但是从节点的任务分配情况也会保存下来。<br>临时节点：<br>主节点崩溃，该znode(master)和主节点一起消失–&gt;系统检测到–&gt;选举<br>有序：<br>唯一名称，创建顺序，task1,task2…</li>
</ul>
<p>文件系统可以提供很多信息。针对一个znode，如果该znode是主节点的znode没有信息，那么说明还没有选出主节点。<br>其他znode节点：<br>workers作为父节点：其下znode节点为可用从节点信息<br>tasks作为父节点：其下znode节点为等待执行任务<br>assign作为父节点：其下znode节点为分配到某从节点任务</p>
<h3 id="通知机制"><a href="#通知机制" class="headerlink" title="通知机制"></a>通知机制</h3><p>客户端注册监听它关心的目录节点，当目录节点发生变化(数据改变，被删除，子目录节点增加删除)时，zookeeper会通知客户端。</p>
<p>leader节点负责写服务和数据的同步，follow节点负责读服务。Zookeeper不允许局部写入或读取znode节点的数据。</p>
<h2 id="zookeeper-shell客户端命令简介"><a href="#zookeeper-shell客户端命令简介" class="headerlink" title="zookeeper shell客户端命令简介"></a>zookeeper shell客户端命令简介</h2><p><strong><em>zookeeper目录结构</em></strong><br><img src="/uploads/zookeeper3.jpg" alt=""><br><strong><em>客户端连接</em></strong><br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="regexp">//</span>当前目录为zookeeper目录;且连接的是当前的zookeeper;连接其他服务器的例如:.<span class="regexp">/bin/</span>zkCli.sh –server <span class="number">10.77</span>.<span class="number">20.23</span>:<span class="number">2181</span></div><div class="line">$ .<span class="regexp">/bin/</span>zkCli.sh</div></pre></td></tr></table></figure></p>
<p>连接成功<br><img src="/uploads/zookeeper4.jpg" alt=""></p>
<h3 id="ls-查看"><a href="#ls-查看" class="headerlink" title="ls 查看"></a>ls 查看</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="string">zk:</span> <span class="string">localhost:</span><span class="number">2181</span>(CONNECTED) <span class="number">0</span>] ls /</div></pre></td></tr></table></figure>
<p><img src="/uploads/zookeeper5.jpg" alt=""><br>这个命令只能看到指定节点下第一级的所有子节点<br>第一次部署的zookeeper集群，默认在根节点”/“下面有一个叫做/zookeeper的保留节点。</p>
<h3 id="create-创建节点并存储数据"><a href="#create-创建节点并存储数据" class="headerlink" title="create 创建节点并存储数据"></a>create 创建节点并存储数据</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="string">zk:</span> <span class="string">localhost:</span><span class="number">2181</span>(CONNECTED) <span class="number">1</span>] create /zhangsan <span class="string">"zhangsan"</span></div></pre></td></tr></table></figure>
<p><img src="/uploads/zookeeper6.jpg" alt=""><br>create有以下属性: [-s] [-e]<br>-s 或 -e 分别指定节点特性：顺序 或 临时节点。默认情况下，不添加-s 或 -e 参数的，创建的是不带序号的持久节点。</p>
<h3 id="get-获取内容"><a href="#get-获取内容" class="headerlink" title="get 获取内容"></a>get 获取内容</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="meta">zk: localhost:2181(CONNECTED) 10</span>] <span class="keyword">get</span> -s /zhangsan</div></pre></td></tr></table></figure>
<p><img src="/uploads/zookeeper7.jpg" alt=""><br>之前版本的zookeeper不加-s能直接看到属性信息，该版本的不加-s只能看到数据内容<br>数据及各属性信息含义：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//数据内容</span></div><div class="line"><span class="string">"zhangsan"</span></div><div class="line"><span class="comment">//创建该节点的事务ID</span></div><div class="line">cZxid = <span class="number">0x43</span></div><div class="line">ctime = Wed Sep <span class="number">26</span> <span class="number">00</span>:<span class="number">12</span>:<span class="number">28</span> CST <span class="number">2018</span></div><div class="line"><span class="comment">//最后一次更新该节点的事务ID</span></div><div class="line">mZxid = <span class="number">0x43</span></div><div class="line"><span class="comment">//最后一次更新该节点的时间</span></div><div class="line">mtime = Wed Sep <span class="number">26</span> <span class="number">00</span>:<span class="number">12</span>:<span class="number">28</span> CST <span class="number">2018</span></div><div class="line">pZxid = <span class="number">0x43</span></div><div class="line">cversion = <span class="number">0</span></div><div class="line">dataVersion = <span class="number">0</span></div><div class="line">aclVersion = <span class="number">0</span></div><div class="line">ephemeralOwner = <span class="number">0x0</span></div><div class="line">dataLength = <span class="number">10</span></div><div class="line">numChildren = <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>其中numChildren为该节点下子节点的个数<br><img src="/uploads/zookeeper14.jpg" alt=""></p>
<h3 id="set-重新设置"><a href="#set-重新设置" class="headerlink" title="set 重新设置"></a>set 重新设置</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="meta">zk: localhost:2181(CONNECTED) 11</span>] <span class="keyword">set</span> /zhangsan <span class="string">"zhangsan1"</span></div></pre></td></tr></table></figure>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="meta">zk: localhost:2181(CONNECTED) 12</span>] <span class="keyword">get</span> -s /zhangsan</div></pre></td></tr></table></figure>
<p>再次get并查看数据<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="string">"zhangsan1"</span></div><div class="line">cZxid = <span class="number">0x43</span></div><div class="line">ctime = Wed Sep <span class="number">26</span> <span class="number">00</span>:<span class="number">12</span>:<span class="number">28</span> CST <span class="number">2018</span></div><div class="line">mZxid = <span class="number">0x46</span></div><div class="line">mtime = Wed Sep <span class="number">26</span> <span class="number">00</span>:<span class="number">32</span>:<span class="number">57</span> CST <span class="number">2018</span></div><div class="line">pZxid = <span class="number">0x43</span></div><div class="line">cversion = <span class="number">0</span></div><div class="line">dataVersion = <span class="number">1</span></div><div class="line">aclVersion = <span class="number">0</span></div><div class="line">ephemeralOwner = <span class="number">0x0</span></div><div class="line">dataLength = <span class="number">11</span></div><div class="line">numChildren = <span class="number">0</span></div></pre></td></tr></table></figure></p>
<p>可以看到 数据内容、mZxid、mtime、dataVersion、dataLength属性发生了变化。</p>
<h3 id="delete-删除节点"><a href="#delete-删除节点" class="headerlink" title="delete 删除节点"></a>delete 删除节点</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="string">zk:</span> <span class="string">localhost:</span><span class="number">2181</span>(CONNECTED) <span class="number">13</span>] delete /zhangsan</div></pre></td></tr></table></figure>
<p>使用delete命令可以删除Zookeeper上的指定节点。<br>注意：想要删除某一个指定节点，该节点必须没有子节点存在。无法删除一个包含子节点的节点。<br><img src="/uploads/zookeeper10.jpg" alt=""><br>可以使用deleteall命令进行删除包含子节点的节点。</p>
<h3 id="其他命令"><a href="#其他命令" class="headerlink" title="其他命令"></a>其他命令</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="string">zk:</span> <span class="string">localhost:</span><span class="number">2181</span>(CONNECTED) <span class="number">20</span>] help</div></pre></td></tr></table></figure>
<p><img src="/uploads/zookeeper11.jpg" alt=""></p>
<h2 id="Java客户端API使用"><a href="#Java客户端API使用" class="headerlink" title="Java客户端API使用"></a>Java客户端API使用</h2><p>目前没用过，用到再介绍;主要命令和客户端的一致</p>
<h2 id="Zookeeper选举机制"><a href="#Zookeeper选举机制" class="headerlink" title="Zookeeper选举机制"></a>Zookeeper选举机制</h2><p>Leader选举是保证分布式数据一致性的关键所在。当Zookeeper集群中的一台服务器出现以下两种情况之一时，需要进入Leader选举。</p>
<ul>
<li>服务器初始化启动。</li>
<li>服务器运行期间无法和Leader保持连接。</li>
</ul>
<h3 id="服务器启动时期的Leader选举"><a href="#服务器启动时期的Leader选举" class="headerlink" title="服务器启动时期的Leader选举"></a>服务器启动时期的Leader选举</h3><ol>
<li><p>每个Server发出一个投票。由于是初始情况，Server1和Server2都会将自己作为Leader服务器来进行投票，每次投票会包含所推举的服务器的myid和ZXID，使用(myid, ZXID)来表示，此时Server1的投票为(1, 0)，Server2的投票为(2, 0)，然后各自将这个投票发给集群中其他机器。</p>
</li>
<li><p>接受来自各个服务器的投票。集群的每个服务器收到投票后，首先判断该投票的有效性，如检查是否是本轮投票、是否来自LOOKING状态的服务器。</p>
</li>
<li><p>处理投票。针对每一个投票，服务器都需要将别人的投票和自己的投票进行PK，PK规则如下</p>
<ul>
<li>优先检查ZXID。ZXID比较大的服务器优先作为Leader。</li>
<li><p>如果ZXID相同，那么就比较myid。myid较大的服务器作为Leader服务器。</p>
<p>对于Server1而言，它的投票是(1, 0)，接收Server2的投票为(2, 0)，首先会比较两者的ZXID，均为0，再比较myid，此时Server2的myid最大，于是更新自己的投票为(2, 0)，然后重新投票，对于Server2而言，其无须更新自己的投票，只是再次向集群中所有机器发出上一次投票信息即可。</p>
</li>
</ul>
</li>
<li><p>统计投票。每次投票后，服务器都会统计投票信息，判断是否已经有过半机器接受到相同的投票信息，对于Server1、Server2而言，都统计出集群中已经有两台机器接受了(2, 0)的投票信息，此时便认为已经选出了Leader。</p>
</li>
<li><p>改变服务器状态。一旦确定了Leader，每个服务器就会更新自己的状态，如果是Follower，那么就变更为FOLLOWING，如果是Leader，就变更为LEADING。</p>
</li>
</ol>
<p>简单例子<br>服务器1启动，无其他节点，得不到响应，选举状态为LOOKING状态<br>服务器2启动，没有历史数据，都选自己，2的id大，所以1同意2为leader，但是未过半数，服务器1/2状态依然为LOOKING<br>服务器3启动，1和2有历史数据，都选2，服务器3选自己，2的票数为2,2/3超过半数，2为leader<br>服务器4启动，发起投票，1/2/3根据历史数据选2，leader为2。</p>
<h3 id="服务器运行时期的Leader选举"><a href="#服务器运行时期的Leader选举" class="headerlink" title="服务器运行时期的Leader选举"></a>服务器运行时期的Leader选举</h3><p>在Zookeeper运行期间，Leader与非Leader服务器各司其职，即便当有非Leader服务器宕机或新加入，此时也不会影响Leader，但是一旦Leader服务器挂了，那么整个集群将暂停对外服务，进入新一轮Leader选举，其过程和启动时期的Leader选举过程基本一致。假设正在运行的有Server1、Server2、Server3三台服务器，当前Leader是Server2，若某一时刻Leader挂了，此时便开始Leader选举。选举过程如下</p>
<ol>
<li><p>变更状态。Leader挂后，余下的非Observer服务器都会讲自己的服务器状态变更为LOOKING，然后开始进入Leader选举过程。</p>
</li>
<li><p>每个Server会发出一个投票。在运行期间，每个服务器上的ZXID可能不同，此时假定Server1的ZXID为123，Server3的ZXID为122；在第一轮投票中，Server1和Server3都会投自己，产生投票(1, 123)，(3, 122)，然后各自将投票发送给集群中所有机器。</p>
</li>
<li><p>接收来自各个服务器的投票。与启动时过程相同。</p>
</li>
<li><p>处理投票。与启动时过程相同，此时，Server1将会成为Leader。</p>
</li>
<li><p>统计投票。与启动时过程相同。</p>
</li>
<li><p>改变服务器的状态。与启动时过程相同。</p>
</li>
</ol>
<h3 id="Leader选举算法分析"><a href="#Leader选举算法分析" class="headerlink" title="Leader选举算法分析"></a>Leader选举算法分析</h3><p><strong><em>在3.4.0后的Zookeeper的版本只保留了TCP版本的FastLeaderElection选举算法。</em></strong></p>
<p>当一台机器进入Leader选举时，当前集群可能会处于以下两种状态</p>
<ul>
<li><p>集群中已经存在Leader。</p>
</li>
<li><p>集群中不存在Leader。</p>
</li>
</ul>
<p>对于集群中已经存在Leader而言，此种情况一般都是某台机器启动得较晚，在其启动之前，集群已经在正常工作，对这种情况，该机器试图去选举Leader时，会被告知当前服务器的Leader信息，对于该机器而言，仅仅需要和Leader机器建立起连接，并进行状态同步即可。</p>
<p>而在集群中不存在Leader情况下则会相对复杂，其步骤如下：</p>
<ol>
<li><p>第一次投票。无论哪种导致进行Leader选举，集群的所有机器都处于试图选举出一个Leader的状态，即LOOKING状态，LOOKING机器会向所有其他机器发送消息，该消息称为投票。投票中包含了SID（服务器的唯一标识）和ZXID（事务ID），(SID, ZXID)形式来标识一次投票信息。假定Zookeeper由5台机器组成，SID分别为1、2、3、4、5，ZXID分别为9、9、9、8、8，并且此时SID为2的机器是Leader机器，某一时刻，1、2所在机器出现故障，因此集群开始进行Leader选举。在第一次投票时，每台机器都会将自己作为投票对象，于是SID为3、4、5的机器投票情况分别为(3, 9)，(4, 8)， (5, 8)。</p>
</li>
<li><p>变更投票。每台机器发出投票后，也会收到其他机器的投票，每台机器会根据一定规则来处理收到的其他机器的投票，并以此来决定是否需要变更自己的投票，这个规则也是整个Leader选举算法的核心所在，其中术语描述如下</p>
<ul>
<li><p>vote_sid：接收到的投票中所推举Leader服务器的SID。</p>
</li>
<li><p>vote_zxid：接收到的投票中所推举Leader服务器的ZXID。</p>
</li>
<li><p>self_sid：当前服务器自己的SID。</p>
</li>
<li><p>self_zxid：当前服务器自己的ZXID。</p>
<p>每次对收到的投票的处理，都是对(vote_sid, vote_zxid)和(self_sid, self_zxid)对比的过程。<br>规则一：如果vote_zxid大于self_zxid，就认可当前收到的投票，并再次将该投票发送出去。<br>规则二：如果vote_zxid小于self_zxid，那么坚持自己的投票，不做任何变更。<br>规则三：如果vote_zxid等于self_zxid，那么就对比两者的SID，如果vote_sid大于self_sid，那么就认可当前收到的投票，并再次将该投票发送出去。<br>规则四：如果vote_zxid等于self_zxid，并且vote_sid小于self_sid，那么坚持自己的投票，不做任何变更。</p>
<p>结合上面规则，给出下面的集群变更过程:<br><img src="/uploads/zookeeper12.jpg" alt=""></p>
</li>
</ul>
</li>
<li><p>确定Leader。经过第二轮投票后，集群中的每台机器都会再次接收到其他机器的投票，然后开始统计投票，如果一台机器收到了超过半数的相同投票，那么这个投票对应的SID机器即为Leader。此时Server3将成为Leader。</p>
</li>
</ol>
<p>由上面规则可知，通常那台服务器上的数据越新（ZXID会越大），其成为Leader的可能性越大，也就越能够保证数据的恢复。如果ZXID相同，则SID越大机会越大。</p>
<h3 id="Leader选举实现细节"><a href="#Leader选举实现细节" class="headerlink" title="Leader选举实现细节"></a>Leader选举实现细节</h3><h4 id="服务器状态"><a href="#服务器状态" class="headerlink" title="服务器状态"></a>服务器状态</h4><p>服务器具有四种状态，分别是LOOKING、FOLLOWING、LEADING、OBSERVING。</p>
<ul>
<li><p>LOOKING：寻找Leader状态。当服务器处于该状态时，它会认为当前集群中没有Leader，因此需要进入Leader选举状态。</p>
</li>
<li><p>FOLLOWING：跟随者状态。表明当前服务器角色是Follower。</p>
</li>
<li><p>LEADING：领导者状态。表明当前服务器角色是Leader。</p>
</li>
<li><p>OBSERVING：观察者状态。表明当前服务器角色是Observer。</p>
</li>
</ul>
<h4 id="投票数据结构"><a href="#投票数据结构" class="headerlink" title="投票数据结构"></a>投票数据结构</h4><p>每个投票中包含了两个最基本的信息，所推举服务器的SID和ZXID。<br>投票（Vote）在Zookeeper中包含字段如下：</p>
<ul>
<li><p>id：被推举的Leader的SID。</p>
</li>
<li><p>zxid：被推举的Leader事务ID。</p>
</li>
<li><p>electionEpoch：逻辑时钟，用来判断多个投票是否在同一轮选举周期中，该值在服务端是一个自增序列，每次进入新一轮的投票后，都会对该值进行加1操作。</p>
</li>
<li><p>peerEpoch：被推举的Leader的epoch。每次leader选举完成之后，都会选举出一个新的peerEpoch，用来标记事务请求所属的轮次。</p>
</li>
<li><p>state：当前服务器的状态。</p>
</li>
</ul>
<h4 id="QuorumCnxManager：网络I-O"><a href="#QuorumCnxManager：网络I-O" class="headerlink" title="QuorumCnxManager：网络I/O"></a>QuorumCnxManager：网络I/O</h4><p>每台服务器在启动的过程中，会启动一个QuorumPeerManager，负责各台服务器之间的底层Leader选举过程中的网络通信。</p>
<ol>
<li><p>消息队列。QuorumCnxManager内部维护了一系列的队列，用来保存接收到的、待发送的消息以及消息的发送器，除接收队列以外，其他队列都按照SID分组形成队列集合，如一个集群中除了自身还有3台机器，那么就会为这3台机器分别创建一个发送队列，互不干扰。</p>
<ul>
<li><p>recvQueue：消息接收队列，用于存放那些从其他服务器接收到的消息。</p>
</li>
<li><p>queueSendMap：消息发送队列，用于保存那些待发送的消息，按照SID进行分组。</p>
</li>
<li><p>senderWorkerMap：发送器集合，每个SenderWorker消息发送器，都对应一台远程Zookeeper服务器，负责消息的发送，也按照SID进行分组。</p>
</li>
<li><p>lastMessageSent：最近发送过的消息，为每个SID保留最近发送过的一个消息。</p>
</li>
</ul>
</li>
<li><p>建立连接。为了能够相互投票，Zookeeper集群中的所有机器都需要两两建立起网络连接。QuorumCnxManager在启动时会创建一个ServerSocket来监听Leader选举的通信端口(默认为3888)。开启监听后，Zookeeper能够不断地接收到来自其他服务器的创建连接请求，在接收到其他服务器的TCP连接请求时，会进行处理。为了避免两台机器之间重复地创建TCP连接，Zookeeper只允许SID大的服务器主动和其他机器建立连接，否则断开连接。在接收到创建连接请求后，服务器通过对比自己和远程服务器的SID值来判断是否接收连接请求，如果当前服务器发现自己的SID更大，那么会断开当前连接，然后自己主动和远程服务器建立连接。一旦连接建立，就会根据远程服务器的SID来创建相应的消息发送器SendWorker和消息接收器RecvWorker，并启动。</p>
</li>
<li><p>消息接收与发送。消息接收：由消息接收器RecvWorker负责，由于Zookeeper为每个远程服务器都分配一个单独的RecvWorker，因此，每个RecvWorker只需要不断地从这个TCP连接中读取消息，并将其保存到recvQueue队列中。消息发送：由于Zookeeper为每个远程服务器都分配一个单独的SendWorker，因此，每个SendWorker只需要不断地从对应的消息发送队列中获取出一个消息发送即可，同时将这个消息放入lastMessageSent中。在SendWorker中，一旦Zookeeper发现针对当前服务器的消息发送队列为空，那么此时需要从lastMessageSent中取出一个最近发送过的消息来进行再次发送，这是为了解决接收方在消息接收前或者接收到消息后服务器挂了，导致消息尚未被正确处理。同时，Zookeeper能够保证接收方在处理消息时，会对重复消息进行正确的处理。</p>
</li>
</ol>
<h4 id="FastLeaderElection：选举算法核心"><a href="#FastLeaderElection：选举算法核心" class="headerlink" title="FastLeaderElection：选举算法核心"></a>FastLeaderElection：选举算法核心</h4><ul>
<li><p>外部投票：特指其他服务器发来的投票。</p>
</li>
<li><p>内部投票：服务器自身当前的投票。</p>
</li>
<li><p>选举轮次：Zookeeper服务器Leader选举的轮次，即logicalclock。</p>
</li>
<li><p>PK：对内部投票和外部投票进行对比来确定是否需要变更内部投票。</p>
</li>
</ul>
<h5 id="选票管理"><a href="#选票管理" class="headerlink" title="选票管理"></a>选票管理</h5><ul>
<li><p>sendqueue：选票发送队列，用于保存待发送的选票。</p>
</li>
<li><p>recvqueue：选票接收队列，用于保存接收到的外部投票。</p>
</li>
<li><p>WorkerReceiver：选票接收器。其会不断地从QuorumCnxManager中获取其他服务器发来的选举消息，并将其转换成一个选票，然后保存到recvqueue中，在选票接收过程中，如果发现该外部选票的选举轮次小于当前服务器的，那么忽略该外部投票，同时立即发送自己的内部投票。</p>
</li>
<li><p>WorkerSender：选票发送器，不断地从sendqueue中获取待发送的选票，并将其传递到底层QuorumCnxManager中。</p>
</li>
</ul>
<h5 id="算法核心"><a href="#算法核心" class="headerlink" title="算法核心"></a>算法核心</h5><p><img src="/uploads/zookeeper13.jpg" alt=""></p>
<p>　　上图展示了FastLeaderElection模块是如何与底层网络I/O进行交互的。Leader选举的基本流程如下</p>
<ol>
<li><p>自增选举轮次。Zookeeper规定所有有效的投票都必须在同一轮次中，在开始新一轮投票时，会首先对logicalclock进行自增操作。</p>
</li>
<li><p>初始化选票。在开始进行新一轮投票之前，每个服务器都会初始化自身的选票，并且在初始化阶段，每台服务器都会将自己推举为Leader。</p>
</li>
<li><p>发送初始化选票。完成选票的初始化后，服务器就会发起第一次投票。Zookeeper会将刚刚初始化好的选票放入sendqueue中，由发送器WorkerSender负责发送出去。</p>
</li>
<li><p>接收外部投票。每台服务器会不断地从recvqueue队列中获取外部选票。如果服务器发现无法获取到任何外部投票，那么就会立即确认自己是否和集群中其他服务器保持着有效的连接，如果没有连接，则马上建立连接，如果已经建立了连接，则再次发送自己当前的内部投票。</p>
</li>
<li><p>判断选举轮次。在发送完初始化选票之后，接着开始处理外部投票。在处理外部投票时，会根据选举轮次来进行不同的处理。</p>
<ul>
<li><p>外部投票的选举轮次大于内部投票。若服务器自身的选举轮次落后于该外部投票对应服务器的选举轮次，那么就会立即更新自己的选举轮次(logicalclock)，并且清空所有已经收到的投票，然后使用初始化的投票来进行PK以确定是否变更内部投票。最终再将内部投票发送出去。</p>
</li>
<li><p>外部投票的选举轮次小于内部投票。若服务器接收的外选票的选举轮次落后于自身的选举轮次，那么Zookeeper就会直接忽略该外部投票，不做任何处理，并返回步骤4。</p>
</li>
<li><p>外部投票的选举轮次等于内部投票。此时可以开始进行选票PK。</p>
</li>
</ul>
</li>
<li><p>选票PK。在进行选票PK时，符合任意一个条件就需要变更投票。</p>
<ul>
<li><p>若外部投票中推举的Leader服务器的选举轮次大于内部投票，那么需要变更投票。</p>
</li>
<li><p>若选举轮次一致，那么就对比两者的ZXID，若外部投票的ZXID大，那么需要变更投票。</p>
</li>
<li><p>若两者的ZXID一致，那么就对比两者的SID，若外部投票的SID大，那么就需要变更投票。</p>
</li>
</ul>
</li>
<li><p>变更投票。经过PK后，若确定了外部投票优于内部投票，那么就变更投票，即使用外部投票的选票信息来覆盖内部投票，变更完成后，再次将这个变更后的内部投票发送出去。</p>
</li>
<li><p>选票归档。无论是否变更了投票，都会将刚刚收到的那份外部投票放入选票集合recvset中进行归档。recvset用于记录当前服务器在本轮次的Leader选举中收到的所有外部投票（按照服务队的SID区别，如{(1, vote1), (2, vote2)…}）。</p>
</li>
<li><p>统计投票。完成选票归档后，就可以开始统计投票，统计投票是为了统计集群中是否已经有过半的服务器认可了当前的内部投票，如果确定已经有过半服务器认可了该投票，则终止投票。否则返回步骤4。</p>
</li>
<li><p>更新服务器状态。若已经确定可以终止投票，那么就开始更新服务器状态，服务器首选判断当前被过半服务器认可的投票所对应的Leader服务器是否是自己，若是自己，则将自己的服务器状态更新为LEADING，若不是，则根据具体情况来确定自己是FOLLOWING或是OBSERVING。</p>
</li>
</ol>
<p>以上10个步骤就是FastLeaderElection的核心，其中步骤4-9会经过几轮循环，直到有Leader选举产生。</p>
<p>可能出现的问题：<br>选举轮次，也就是逻辑时钟，即logicalclock。这个值，不会频繁变化，一次选举，自增一次。一次选举过程中，可能包括多次投票，投票不涉及逻辑时钟的自增。<br>举例，初始情况下5台机器，sid分别为1、2、3、4、5，逻辑时钟都是0。依次启动后，开始选举，所有的机器逻辑时钟自增为1。经过多次投票，假设第三台机器为leader，其他4台机器为follower，此时5台机器的逻辑时钟都为1。<br>一般情况下，逻辑时钟应该都是相同的。但是，由于一些机器崩溃的问题，是可能出现逻辑时钟不一致的情况的。例如，上例中，sid=3的机器为leader。之后某一刻，sid为1、3的机器崩溃，zookeeper仍然可以正常对外提供服务。但需要重新选主，剩下的2、4、5重新投票选主，假设sid=5成为新的leader，逻辑时钟自增，由1变成2。之后某一刻，sid为5的机器奔溃，sid为1的机器复活，仍然有3台机器运行，zookeeper可以对外提供服务，但需要重新选主。重新选主，逻辑时钟自增，这时sid为2、4的机器的逻辑时钟是由2自增为3，而sid为1的机器的逻辑时钟是由1自增为2。这种情况下，就出现了逻辑时钟不一致的情况。这时，需要清除sid为1的机器内部的投票数据，因为这些投票数据都是过时的数据。</p>
<h4 id="FastLeaderElection源码分析"><a href="#FastLeaderElection源码分析" class="headerlink" title="FastLeaderElection源码分析"></a>FastLeaderElection源码分析</h4><h5 id="类的继承关系"><a href="#类的继承关系" class="headerlink" title="类的继承关系"></a>类的继承关系</h5><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FastLeaderElection</span> <span class="keyword">implements</span> <span class="title">Election</span> </span>&#123;&#125;</div></pre></td></tr></table></figure>
<p>说明：FastLeaderElection实现了Election接口，其需要实现接口中定义的lookForLeader方法和shutdown方法，其是标准的Fast Paxos算法的实现，各服务器之间基于TCP协议进行选举。</p>
<h5 id="FastLeaderElection类的内部类"><a href="#FastLeaderElection类的内部类" class="headerlink" title="FastLeaderElection类的内部类"></a>FastLeaderElection类的内部类</h5><p>FastLeaderElection有三个较为重要的内部类，分别为Notification、ToSend、Messenger。</p>
<h6 id="Notification类"><a href="#Notification类" class="headerlink" title="Notification类　"></a>Notification类　</h6><p>说明：Notification表示收到的选举投票信息（其他服务器发来的选举投票信息），其包含了被选举者的id、zxid、选举周期等信息，其buildMsg方法将选举信息封装至ByteBuffer中再进行发送。<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">class</span> Notification &#123;</div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Format version, introduced in 3.4.6</div><div class="line">     */</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> CURRENTVERSION = <span class="number">0</span>x1; </div><div class="line">    <span class="keyword">int</span> version;</div><div class="line">            </div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Proposed leader</div><div class="line">     */</div><div class="line">    <span class="comment">// 被推选的leader的id</span></div><div class="line">    <span class="keyword">long</span> leader;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * zxid of the proposed leader</div><div class="line">     */</div><div class="line">    <span class="comment">// 被推选的leader的事务id</span></div><div class="line">    <span class="keyword">long</span> zxid;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Epoch</div><div class="line">     */</div><div class="line">    <span class="comment">// 推选者的选举周期</span></div><div class="line">    <span class="keyword">long</span> electionEpoch;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * current state of sender</div><div class="line">     */</div><div class="line">    <span class="comment">// 推选者的状态</span></div><div class="line">    QuorumPeer.ServerState state;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Address of sender</div><div class="line">     */</div><div class="line">    <span class="comment">// 推选者的id</span></div><div class="line">    <span class="keyword">long</span> sid;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * epoch of the proposed leader</div><div class="line">     */</div><div class="line">    <span class="comment">// 被推选者的选举周期</span></div><div class="line">    <span class="keyword">long</span> peerEpoch;</div><div class="line">    </div><div class="line">    @Override</div><div class="line">    <span class="keyword">public</span> String toString() &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(<span class="keyword">Long</span>.toHexString(version) + <span class="string">" (message format version), "</span> </div><div class="line">                + leader + <span class="string">" (n.leader), 0x"</span></div><div class="line">                + <span class="keyword">Long</span>.toHexString(zxid) + <span class="string">" (n.zxid), 0x"</span></div><div class="line">                + <span class="keyword">Long</span>.toHexString(electionEpoch) + <span class="string">" (n.round), "</span> + state</div><div class="line">                + <span class="string">" (n.state), "</span> + sid + <span class="string">" (n.sid), 0x"</span></div><div class="line">                + <span class="keyword">Long</span>.toHexString(peerEpoch) + <span class="string">" (n.peerEpoch) "</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> ByteBuffer buildMsg(<span class="keyword">int</span> state,</div><div class="line">        <span class="keyword">long</span> leader,</div><div class="line">        <span class="keyword">long</span> zxid,</div><div class="line">        <span class="keyword">long</span> electionEpoch,</div><div class="line">        <span class="keyword">long</span> epoch) &#123;</div><div class="line">    <span class="keyword">byte</span> requestBytes[] = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">40</span>];</div><div class="line">    ByteBuffer requestBuffer = ByteBuffer.wrap(requestBytes);</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Building notification packet to send </div><div class="line">     */</div><div class="line"></div><div class="line">    requestBuffer.clear();</div><div class="line">    requestBuffer.putInt(state);</div><div class="line">    requestBuffer.putLong(leader);</div><div class="line">    requestBuffer.putLong(zxid);</div><div class="line">    requestBuffer.putLong(electionEpoch);</div><div class="line">    requestBuffer.putLong(epoch);</div><div class="line">    requestBuffer.putInt(Notification.CURRENTVERSION);</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> requestBuffer;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h6 id="ToSend类"><a href="#ToSend类" class="headerlink" title="ToSend类　"></a>ToSend类　</h6><p>说明：ToSend表示发送给其他服务器的选举投票信息，也包含了被选举者的id、zxid、选举周期等信息。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToSend</span> &#123;</span></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">enum</span> <span class="title">mType</span> &#123;</span>crequest, challenge, notification, ack&#125;</div><div class="line"></div><div class="line">    ToSend(mType type,</div><div class="line">            <span class="keyword">long</span> leader,</div><div class="line">            <span class="keyword">long</span> zxid,</div><div class="line">            <span class="keyword">long</span> electionEpoch,</div><div class="line">            ServerState state,</div><div class="line">            <span class="keyword">long</span> sid,</div><div class="line">            <span class="keyword">long</span> peerEpoch) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.leader = leader;</div><div class="line">        <span class="keyword">this</span>.zxid = zxid;</div><div class="line">        <span class="keyword">this</span>.electionEpoch = electionEpoch;</div><div class="line">        <span class="keyword">this</span>.state = state;</div><div class="line">        <span class="keyword">this</span>.sid = sid;</div><div class="line">        <span class="keyword">this</span>.peerEpoch = peerEpoch;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Proposed leader in the case of notification</div><div class="line">     */</div><div class="line">    <span class="comment">//被推举的leader的id</span></div><div class="line">    <span class="keyword">long</span> leader;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * id contains the tag for acks, and zxid for notifications</div><div class="line">     */</div><div class="line">    <span class="comment">// 被推举的leader的最大事务id</span></div><div class="line">    <span class="keyword">long</span> zxid;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Epoch</div><div class="line">     */</div><div class="line">    <span class="comment">// 推举者的选举周期</span></div><div class="line">    <span class="keyword">long</span> electionEpoch;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Current state;</div><div class="line">     */</div><div class="line">    <span class="comment">// 推举者的状态</span></div><div class="line">    QuorumPeer.ServerState state;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Address of recipient</div><div class="line">     */</div><div class="line">    <span class="comment">// 推举者的id</span></div><div class="line">    <span class="keyword">long</span> sid;</div><div class="line">    </div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Leader epoch</div><div class="line">     */</div><div class="line">    <span class="comment">// 被推举的leader的选举周期</span></div><div class="line">    <span class="keyword">long</span> peerEpoch;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h6 id="Messenger类"><a href="#Messenger类" class="headerlink" title="Messenger类"></a>Messenger类</h6><p>Messenger包含了WorkerReceiver和WorkerSender两个内部类</p>
<p>WorkerReceiver<br>说明：WorkerReceiver实现了Runnable接口，是选票接收器。其会不断地从QuorumCnxManager中获取其他服务器发来的选举消息，并将其转换成一个选票，然后保存到recvqueue中，在选票接收过程中，如果发现该外部选票的选举轮次小于当前服务器的，那么忽略该外部投票，同时立即发送自己的内部投票。其是将QuorumCnxManager的Message转化为FastLeaderElection的Notification。<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div></pre></td><td class="code"><pre><div class="line">class WorkerReceiver implements Runnable &#123;</div><div class="line">    <span class="comment">// 是否终止</span></div><div class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean</span> <span class="built_in">stop</span>;</div><div class="line">    <span class="comment">// 服务器之间的连接</span></div><div class="line">    QuorumCnxManager manager;</div><div class="line"></div><div class="line">    WorkerReceiver(QuorumCnxManager manager) &#123;</div><div class="line">        <span class="keyword">this</span>.<span class="built_in">stop</span> = false;</div><div class="line">        <span class="keyword">this</span>.manager = manager;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="built_in">run</span>() &#123;</div><div class="line">        <span class="comment">// 响应</span></div><div class="line">        Message response;</div><div class="line">        <span class="built_in">while</span> (!<span class="built_in">stop</span>) &#123; <span class="comment">// 不终止</span></div><div class="line">            <span class="comment">// Sleeps on receive</span></div><div class="line">            <span class="built_in">try</span>&#123;</div><div class="line">                <span class="comment">// 从recvQueue中取出一个选举投票消息（从其他服务器发送过来）</span></div><div class="line">                response = manager.pollRecvQueue(<span class="number">3000</span>, TimeUnit.MILLISECONDS);</div><div class="line">                <span class="comment">// 无投票，跳过</span></div><div class="line">                <span class="built_in">if</span>(response == null) <span class="built_in">continue</span>;</div><div class="line"></div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * If it is from an observer, respond right away.</div><div class="line">                 * Note that the following predicate assumes that</div><div class="line">                 * if a server is not a follower, then it must be</div><div class="line">                 * an observer. If we ever have any other type of</div><div class="line">                 * learner in the future, we'll have to change the</div><div class="line">                 * way we check for observers.</div><div class="line">                 */</div><div class="line">                <span class="built_in">if</span>(!self.getVotingView().containsKey(response.sid))&#123; <span class="comment">// 当前的投票者集合不包含服务器</span></div><div class="line">                    <span class="comment">// 获取自己的投票</span></div><div class="line">                    Vote current = self.getCurrentVote();</div><div class="line">                    <span class="comment">// 构造ToSend消息</span></div><div class="line">                    ToSend notmsg = <span class="keyword">new</span> ToSend(ToSend.mType.notification,</div><div class="line">                            current.getId(),</div><div class="line">                            current.getZxid(),</div><div class="line">                            logicalclock,</div><div class="line">                            self.getPeerState(),</div><div class="line">                            response.sid,</div><div class="line">                            current.getPeerEpoch());</div><div class="line">                    <span class="comment">// 放入sendqueue队列，等待发送</span></div><div class="line">                    sendqueue.offer(notmsg);</div><div class="line">                &#125; <span class="built_in">else</span> &#123; <span class="comment">// 包含服务器，表示接收到该服务器的选票消息</span></div><div class="line">                    <span class="comment">// Receive new message</span></div><div class="line">                    <span class="built_in">if</span> (LOG.isDebugEnabled()) &#123;</div><div class="line">                        LOG.debug(<span class="string">"Receive new notification message. My id = "</span></div><div class="line">                                + self.getId());</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     * We check for 28 bytes for backward compatibility</div><div class="line">                     */</div><div class="line">                    <span class="comment">// 检查向后兼容性</span></div><div class="line">                    <span class="built_in">if</span> (response.<span class="built_in">buffer</span>.capacity() &lt; <span class="number">28</span>) &#123;</div><div class="line">                        LOG.error(<span class="string">"Got a short response: "</span></div><div class="line">                                + response.<span class="built_in">buffer</span>.capacity());</div><div class="line">                        <span class="built_in">continue</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// 若容量为28，则表示可向后兼容</span></div><div class="line">                    <span class="keyword">boolean</span> backCompatibility = (response.<span class="built_in">buffer</span>.capacity() == <span class="number">28</span>);</div><div class="line">                    <span class="comment">// 设置buffer中的position、limit等属性</span></div><div class="line">                    response.<span class="built_in">buffer</span>.<span class="built_in">clear</span>();</div><div class="line"></div><div class="line">                    <span class="comment">// Instantiate Notification and set its attributes</span></div><div class="line">                    <span class="comment">// 创建接收通知</span></div><div class="line">                    Notification n = <span class="keyword">new</span> Notification();</div><div class="line">                    </div><div class="line">                    <span class="comment">// State of peer that sent this message</span></div><div class="line">                    <span class="comment">// 推选者的状态</span></div><div class="line">                    QuorumPeer.ServerState ackstate = QuorumPeer.ServerState.LOOKING;</div><div class="line">                    <span class="built_in">switch</span> (response.<span class="built_in">buffer</span>.getInt()) &#123; <span class="comment">// 读取状态</span></div><div class="line">                    <span class="built_in">case</span> <span class="number">0</span>:</div><div class="line">                        ackstate = QuorumPeer.ServerState.LOOKING;</div><div class="line">                        <span class="built_in">break</span>;</div><div class="line">                    <span class="built_in">case</span> <span class="number">1</span>:</div><div class="line">                        ackstate = QuorumPeer.ServerState.FOLLOWING;</div><div class="line">                        <span class="built_in">break</span>;</div><div class="line">                    <span class="built_in">case</span> <span class="number">2</span>:</div><div class="line">                        ackstate = QuorumPeer.ServerState.LEADING;</div><div class="line">                        <span class="built_in">break</span>;</div><div class="line">                    <span class="built_in">case</span> <span class="number">3</span>:</div><div class="line">                        ackstate = QuorumPeer.ServerState.OBSERVING;</div><div class="line">                        <span class="built_in">break</span>;</div><div class="line">                    <span class="built_in">default</span>:</div><div class="line">                        <span class="built_in">continue</span>;</div><div class="line">                    &#125;</div><div class="line">                    </div><div class="line">                    <span class="comment">// 获取leader的id</span></div><div class="line">                    n.leader = response.<span class="built_in">buffer</span>.getLong();</div><div class="line">                    <span class="comment">// 获取zxid</span></div><div class="line">                    n.zxid = response.<span class="built_in">buffer</span>.getLong();</div><div class="line">                    <span class="comment">// 获取选举周期</span></div><div class="line">                    n.electionEpoch = response.<span class="built_in">buffer</span>.getLong();</div><div class="line">                    n.state = ackstate;</div><div class="line">                    <span class="comment">// 设置服务器的id</span></div><div class="line">                    n.sid = response.sid;</div><div class="line">                    <span class="built_in">if</span>(!backCompatibility)&#123; <span class="comment">// 不向后兼容</span></div><div class="line">                        n.peerEpoch = response.<span class="built_in">buffer</span>.getLong();</div><div class="line">                    &#125; <span class="built_in">else</span> &#123; <span class="comment">// 向后兼容</span></div><div class="line">                        <span class="built_in">if</span>(LOG.isInfoEnabled())&#123;</div><div class="line">                            LOG.info(<span class="string">"Backward compatibility mode, server id="</span> + n.sid);</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">// 获取选举周期</span></div><div class="line">                        n.peerEpoch = ZxidUtils.getEpochFromZxid(n.zxid);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     * Version added in 3.4.6</div><div class="line">                     */</div><div class="line">                    </div><div class="line">                    <span class="comment">// 确定版本号</span></div><div class="line">                    n.version = (response.<span class="built_in">buffer</span>.remaining() &gt;= <span class="number">4</span>) ? </div><div class="line">                                 response.<span class="built_in">buffer</span>.getInt() : <span class="number">0x0</span>;</div><div class="line"></div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     * Print notification info</div><div class="line">                     */</div><div class="line">                    <span class="built_in">if</span>(LOG.isInfoEnabled())&#123;</div><div class="line">                        printNotification(n);</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     * If this server is looking, then send proposed leader</div><div class="line">                     */</div><div class="line"></div><div class="line">                    <span class="built_in">if</span>(self.getPeerState() == QuorumPeer.ServerState.LOOKING)&#123; <span class="comment">// 本服务器为LOOKING状态</span></div><div class="line">                        <span class="comment">// 将消息放入recvqueue中</span></div><div class="line">                        recvqueue.offer(n);</div><div class="line"></div><div class="line">                        <span class="comment">/*</span></div><div class="line">                         * Send a notification back if the peer that sent this</div><div class="line">                         * message is also looking and its logical clock is</div><div class="line">                         * lagging behind.</div><div class="line">                         */</div><div class="line">                        <span class="built_in">if</span>((ackstate == QuorumPeer.ServerState.LOOKING) <span class="comment">// 推选者服务器为LOOKING状态</span></div><div class="line">                                &amp;&amp; (n.electionEpoch &lt; logicalclock))&#123; <span class="comment">// 选举周期小于逻辑时钟</span></div><div class="line">                            <span class="comment">// 创建新的投票</span></div><div class="line">                            Vote v = getVote();</div><div class="line">                            <span class="comment">// 构造新的发送消息（本服务器自己的投票）</span></div><div class="line">                            ToSend notmsg = <span class="keyword">new</span> ToSend(ToSend.mType.notification,</div><div class="line">                                    v.getId(),</div><div class="line">                                    v.getZxid(),</div><div class="line">                                    logicalclock,</div><div class="line">                                    self.getPeerState(),</div><div class="line">                                    response.sid,</div><div class="line">                                    v.getPeerEpoch());</div><div class="line">                            <span class="comment">// 将发送消息放置于队列，等待发送</span></div><div class="line">                            sendqueue.offer(notmsg);</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="built_in">else</span> &#123; <span class="comment">// 推选服务器状态不为LOOKING</span></div><div class="line">                        <span class="comment">/*</span></div><div class="line">                         * If this server is not looking, but the one that sent the ack</div><div class="line">                         * is looking, then send back what it believes to be the leader.</div><div class="line">                         */</div><div class="line">                        <span class="comment">// 获取当前投票</span></div><div class="line">                        Vote current = self.getCurrentVote(); </div><div class="line">                        <span class="built_in">if</span>(ackstate == QuorumPeer.ServerState.LOOKING)&#123; <span class="comment">// 为LOOKING状态</span></div><div class="line">                            <span class="built_in">if</span>(LOG.isDebugEnabled())&#123;</div><div class="line">                                LOG.debug(<span class="string">"Sending new notification. My id =  "</span> +</div><div class="line">                                        self.getId() + <span class="string">" recipient="</span> +</div><div class="line">                                        response.sid + <span class="string">" zxid=0x"</span> +</div><div class="line">                                        Long.toHexString(current.getZxid()) +</div><div class="line">                                        <span class="string">" leader="</span> + current.getId());</div><div class="line">                            &#125;</div><div class="line">                            </div><div class="line">                            ToSend notmsg;</div><div class="line">                            <span class="built_in">if</span>(n.version &gt; <span class="number">0x0</span>) &#123; <span class="comment">// 版本号大于0</span></div><div class="line">                                <span class="comment">// 构造ToSend消息</span></div><div class="line">                                notmsg = <span class="keyword">new</span> ToSend(</div><div class="line">                                        ToSend.mType.notification,</div><div class="line">                                        current.getId(),</div><div class="line">                                        current.getZxid(),</div><div class="line">                                        current.getElectionEpoch(),</div><div class="line">                                        self.getPeerState(),</div><div class="line">                                        response.sid,</div><div class="line">                                        current.getPeerEpoch());</div><div class="line">                                </div><div class="line">                            &#125; <span class="built_in">else</span> &#123; <span class="comment">// 版本号不大于0</span></div><div class="line">                                <span class="comment">// 构造ToSend消息</span></div><div class="line">                                Vote bcVote = self.getBCVote();</div><div class="line">                                notmsg = <span class="keyword">new</span> ToSend(</div><div class="line">                                        ToSend.mType.notification,</div><div class="line">                                        bcVote.getId(),</div><div class="line">                                        bcVote.getZxid(),</div><div class="line">                                        bcVote.getElectionEpoch(),</div><div class="line">                                        self.getPeerState(),</div><div class="line">                                        response.sid,</div><div class="line">                                        bcVote.getPeerEpoch());</div><div class="line">                            &#125;</div><div class="line">                            <span class="comment">// 将发送消息放置于队列，等待发送</span></div><div class="line">                            sendqueue.offer(notmsg);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="built_in">catch</span> (InterruptedException e) &#123;</div><div class="line">                System.out.<span class="built_in">println</span>(<span class="string">"Interrupted Exception while waiting for new message"</span> +</div><div class="line">                        e.toString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        LOG.info(<span class="string">"WorkerReceiver is down"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其中，WorkerReceiver的主要逻辑在run方法中，其首先会从QuorumCnxManager中的recvQueue队列中取出其他服务器发来的选举消息，消息封装在Message数据结构中。然后判断消息中的服务器id是否包含在可以投票的服务器集合中，若不是，则会将本服务器的内部投票发送给该服务器，其流程如下<br><figure class="highlight pony"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(!self.getVotingView().containsKey(response.sid))&#123; <span class="comment">// 当前的投票者集合不包含服务器</span></div><div class="line">    <span class="comment">// 获取自己的投票</span></div><div class="line">    <span class="type">Vote</span> current = self.getCurrentVote();</div><div class="line">    <span class="comment">// 构造ToSend消息</span></div><div class="line">    <span class="type">ToSend</span> notmsg = <span class="function"><span class="keyword">new</span> <span class="title">ToSend</span>(<span class="type">ToSend</span>.mType.notification,</span></div><div class="line">            current.getId(),</div><div class="line">            <span class="title">current</span>.<span class="title">getZxid</span>(),</div><div class="line">            <span class="title">logicalclock</span>,</div><div class="line">            <span class="title">self</span>.<span class="title">getPeerState</span>(),</div><div class="line">            <span class="title">response</span>.<span class="title">sid</span>,</div><div class="line">            <span class="title">current</span>.<span class="title">getPeerEpoch</span>());</div><div class="line">    <span class="comment">// 放入sendqueue队列，等待发送</span></div><div class="line">    <span class="title">sendqueue</span>.<span class="title">offer</span>(notmsg);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>若包含该服务器，则根据消息（Message）解析出投票服务器的投票信息并将其封装为Notification，然后判断当前服务器是否为LOOKING，若为LOOKING，则直接将Notification放入FastLeaderElection的recvqueue（区别于recvQueue）中。然后判断投票服务器是否为LOOKING状态，并且其选举周期小于当前服务器的逻辑时钟，则将本（当前）服务器的内部投票发送给该服务器，否则，直接忽略掉该投票。其流程如下　</p>
<figure class="highlight pony"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(self.getPeerState() == <span class="type">QuorumPeer</span>.<span class="type">ServerState</span>.<span class="type">LOOKING</span>)&#123; <span class="comment">// 本服务器为LOOKING状态</span></div><div class="line">    <span class="comment">// 将消息放入recvqueue中</span></div><div class="line">    recvqueue.offer(n);</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Send a notification back if the peer that sent this</div><div class="line">     * message is also looking and its logical clock is</div><div class="line">     * lagging behind.</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span>((ackstate == <span class="type">QuorumPeer</span>.<span class="type">ServerState</span>.<span class="type">LOOKING</span>) <span class="comment">// 推选者服务器为LOOKING状态</span></div><div class="line">            &amp;&amp; (n.electionEpoch &lt; logicalclock))&#123; <span class="comment">// 选举周期小于逻辑时钟</span></div><div class="line">        <span class="comment">// 创建新的投票</span></div><div class="line">        <span class="type">Vote</span> v = getVote();</div><div class="line">        <span class="comment">// 构造新的发送消息（本服务器自己的投票）</span></div><div class="line">        <span class="type">ToSend</span> notmsg = <span class="function"><span class="keyword">new</span> <span class="title">ToSend</span>(<span class="type">ToSend</span>.mType.notification,</span></div><div class="line">                v.getId(),</div><div class="line">                <span class="title">v</span>.<span class="title">getZxid</span>(),</div><div class="line">                <span class="title">logicalclock</span>,</div><div class="line">                <span class="title">self</span>.<span class="title">getPeerState</span>(),</div><div class="line">                <span class="title">response</span>.<span class="title">sid</span>,</div><div class="line">                <span class="title">v</span>.<span class="title">getPeerEpoch</span>());</div><div class="line">        <span class="comment">// 将发送消息放置于队列，等待发送</span></div><div class="line">        <span class="title">sendqueue</span>.<span class="title">offer</span>(notmsg);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>若本服务器的状态不为LOOKING，则会根据投票服务器中解析的version信息来构造ToSend消息，放入sendqueue，等待发送，起流程如下<br><figure class="highlight pony"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">else</span> &#123; <span class="comment">// 本服务器状态不为LOOKING</span></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * If this server is not looking, but the one that sent the ack</div><div class="line">     * is looking, then send back what it believes to be the leader.</div><div class="line">     */</div><div class="line">    <span class="comment">// 获取当前投票</span></div><div class="line">    <span class="type">Vote</span> current = self.getCurrentVote(); </div><div class="line">    <span class="keyword">if</span>(ackstate == <span class="type">QuorumPeer</span>.<span class="type">ServerState</span>.<span class="type">LOOKING</span>)&#123; <span class="comment">// 为LOOKING状态</span></div><div class="line">        <span class="keyword">if</span>(<span class="type">LOG</span>.isDebugEnabled())&#123;</div><div class="line">            <span class="type">LOG</span>.debug(<span class="string">"Sending new notification. My id =  "</span> +</div><div class="line">                    self.getId() + <span class="string">" recipient="</span> +</div><div class="line">                    response.sid + <span class="string">" zxid=0x"</span> +</div><div class="line">                    <span class="type">Long</span>.toHexString(current.getZxid()) +</div><div class="line">                    <span class="string">" leader="</span> + current.getId());</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="type">ToSend</span> notmsg;</div><div class="line">        <span class="keyword">if</span>(n.version &gt; <span class="number">0x0</span>) &#123; <span class="comment">// 版本号大于0</span></div><div class="line">            <span class="comment">// 构造ToSend消息</span></div><div class="line">            notmsg = <span class="function"><span class="keyword">new</span> <span class="title">ToSend</span>(</span></div><div class="line">                    <span class="type">ToSend</span>.mType.notification,</div><div class="line">                    current.getId(),</div><div class="line">                    <span class="title">current</span>.<span class="title">getZxid</span>(),</div><div class="line">                    <span class="title">current</span>.<span class="title">getElectionEpoch</span>(),</div><div class="line">                    <span class="title">self</span>.<span class="title">getPeerState</span>(),</div><div class="line">                    <span class="title">response</span>.<span class="title">sid</span>,</div><div class="line">                    <span class="title">current</span>.<span class="title">getPeerEpoch</span>());</div><div class="line">            </div><div class="line">        &#125; <span class="title">else</span> &#123; <span class="comment">// 版本号不大于0</span></div><div class="line">            <span class="comment">// 构造ToSend消息</span></div><div class="line">            <span class="title">Vote</span> <span class="title">bcVote</span> = <span class="title">self</span>.<span class="title">getBCVote</span>();</div><div class="line">            <span class="title">notmsg</span> = <span class="title">new</span> <span class="title">ToSend</span>(</div><div class="line">                    <span class="type">ToSend</span>.mType.notification,</div><div class="line">                    bcVote.getId(),</div><div class="line">                    <span class="title">bcVote</span>.<span class="title">getZxid</span>(),</div><div class="line">                    <span class="title">bcVote</span>.<span class="title">getElectionEpoch</span>(),</div><div class="line">                    <span class="title">self</span>.<span class="title">getPeerState</span>(),</div><div class="line">                    <span class="title">response</span>.<span class="title">sid</span>,</div><div class="line">                    <span class="title">bcVote</span>.<span class="title">getPeerEpoch</span>());</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 将发送消息放置于队列，等待发送</span></div><div class="line">        <span class="title">sendqueue</span>.<span class="title">offer</span>(notmsg);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>WorkerSender<br>说明：WorkerSender也实现了Runnable接口，为选票发送器，其会不断地从sendqueue中获取待发送的选票，并将其传递到底层QuorumCnxManager中，其过程是将FastLeaderElection的ToSend转化为QuorumCnxManager的Message。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WorkerSender</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="comment">// 是否终止</span></div><div class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop;</div><div class="line">    <span class="comment">// 服务器之间的连接</span></div><div class="line">    QuorumCnxManager manager;</div><div class="line"></div><div class="line">    <span class="comment">// 构造器</span></div><div class="line">    WorkerSender(QuorumCnxManager manager)&#123;</div><div class="line">        <span class="comment">// 初始化属性</span></div><div class="line">        <span class="keyword">this</span>.stop = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">this</span>.manager = manager;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (!stop) &#123; <span class="comment">// 不终止</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// 从sendqueue中取出ToSend消息</span></div><div class="line">                ToSend m = sendqueue.poll(<span class="number">3000</span>, TimeUnit.MILLISECONDS);</div><div class="line">                <span class="comment">// 若为空，则跳过</span></div><div class="line">                <span class="keyword">if</span>(m == <span class="keyword">null</span>) <span class="keyword">continue</span>;</div><div class="line">                <span class="comment">// 不为空，则进行处理</span></div><div class="line">                process(m);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        LOG.info(<span class="string">"WorkerSender is down"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Called by run() once there is a new message to send.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> m     message to send</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(ToSend m)</span> </span>&#123;</div><div class="line">        <span class="comment">// 构建消息</span></div><div class="line">        ByteBuffer requestBuffer = buildMsg(m.state.ordinal(), </div><div class="line">                                                m.leader,</div><div class="line">                                                m.zxid, </div><div class="line">                                                m.electionEpoch, </div><div class="line">                                                m.peerEpoch);</div><div class="line">        <span class="comment">// 发送消息</span></div><div class="line">        manager.toSend(m.sid, requestBuffer);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Messenger类的属性<br>说明：Messenger中维护了一个WorkerSender和WorkerReceiver，分别表示选票发送器和选票接收器。<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">Messenger</span> </span>&#123;</div><div class="line">    <span class="comment">// 选票发送器</span></div><div class="line">    WorkerSender ws;</div><div class="line">    <span class="comment">// 选票接收器</span></div><div class="line">    WorkerReceiver wr;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Messenger类的构造函数　<br>说明：会启动WorkerSender和WorkerReceiver，并设置为守护线程。<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">Messenger(QuorumCnxManager manager) &#123;</div><div class="line">    <span class="comment">// 创建WorkerSender</span></div><div class="line">    <span class="built_in">this</span>.ws = <span class="keyword">new</span> <span class="type">WorkerSender</span>(manager);</div><div class="line">    <span class="comment">// 新创建线程</span></div><div class="line">    Thread t = <span class="keyword">new</span> <span class="type">Thread</span>(<span class="built_in">this</span>.ws,</div><div class="line">            <span class="string">"WorkerSender[myid="</span> + self.getId() + <span class="string">"]"</span>);</div><div class="line">    <span class="comment">// 设置为守护线程</span></div><div class="line">    t.setDaemon(<span class="literal">true</span>);</div><div class="line">    <span class="comment">// 启动</span></div><div class="line">    t.start();</div><div class="line"></div><div class="line">    <span class="comment">// 创建WorkerReceiver</span></div><div class="line">    <span class="built_in">this</span>.wr = <span class="keyword">new</span> <span class="type">WorkerReceiver</span>(manager);</div><div class="line">    <span class="comment">// 创建线程</span></div><div class="line">    t = <span class="keyword">new</span> <span class="type">Thread</span>(<span class="built_in">this</span>.wr,</div><div class="line">            <span class="string">"WorkerReceiver[myid="</span> + self.getId() + <span class="string">"]"</span>);</div><div class="line">    <span class="comment">// 设置为守护线程</span></div><div class="line">    t.setDaemon(<span class="literal">true</span>);</div><div class="line">    <span class="comment">// 启动</span></div><div class="line">    t.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="FastLeaderElection类的属性"><a href="#FastLeaderElection类的属性" class="headerlink" title="FastLeaderElection类的属性"></a>FastLeaderElection类的属性</h5><p>说明：其维护了服务器之间的连接（用于发送消息）、发送消息队列、接收消息队列、推选者的一些信息（zxid、id）、是否停止选举流程标识等。<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> FastLeaderElection <span class="keyword">implements</span> Election &#123;</div><div class="line">    <span class="comment">// 日志</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(FastLeaderElection.<span class="keyword">class</span>);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Determine how much time a process has to wait</div><div class="line">     * once it believes that it has reached the end of</div><div class="line">     * leader election.</div><div class="line">     */</div><div class="line">    <span class="comment">// 完成Leader选举之后需要等待时长</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> finalizeWait = <span class="number">200</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Upper bound on the amount of time between two consecutive</div><div class="line">     * notification checks. This impacts the amount of time to get</div><div class="line">     * the system up again after long partitions. Currently 60 seconds.</div><div class="line">     */</div><div class="line">    <span class="comment">// 两个连续通知检查之间的最大时长</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> maxNotificationInterval = <span class="number">60000</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Connection manager. Fast leader election uses TCP for</div><div class="line">     * communication between peers, and QuorumCnxManager manages</div><div class="line">     * such connections.</div><div class="line">     */</div><div class="line">    <span class="comment">// 管理服务器之间的连接</span></div><div class="line">    QuorumCnxManager manager;</div><div class="line">    </div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">// 选票发送队列，用于保存待发送的选票</span></div><div class="line">    LinkedBlockingQueue&lt;ToSend&gt; sendqueue;</div><div class="line">    </div><div class="line">    <span class="comment">// 选票接收队列，用于保存接收到的外部投票</span></div><div class="line">    LinkedBlockingQueue&lt;Notification&gt; recvqueue;</div><div class="line">    </div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">// 投票者</span></div><div class="line">    QuorumPeer self;</div><div class="line">    Messenger messenger;</div><div class="line">    <span class="comment">// 逻辑时钟</span></div><div class="line">    <span class="keyword">volatile</span> <span class="keyword">long</span> logicalclock; <span class="comment">/* Election instance */</span></div><div class="line">    <span class="comment">// 推选的leader的id</span></div><div class="line">    <span class="keyword">long</span> proposedLeader;</div><div class="line">    <span class="comment">// 推选的leader的zxid</span></div><div class="line">    <span class="keyword">long</span> proposedZxid;</div><div class="line">    <span class="comment">// 推选的leader的选举周期</span></div><div class="line">    <span class="keyword">long</span> proposedEpoch;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">// 是否停止选举</span></div><div class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="FastLeaderElection类的构造函数"><a href="#FastLeaderElection类的构造函数" class="headerlink" title="FastLeaderElection类的构造函数"></a>FastLeaderElection类的构造函数</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> FastLeaderElection(QuorumPeer self, QuorumCnxManager manager)&#123;</div><div class="line">    <span class="comment">// 字段赋值</span></div><div class="line">    <span class="keyword">this</span>.stop = <span class="literal">false</span>;</div><div class="line">    <span class="keyword">this</span>.manager = manager;</div><div class="line">    <span class="comment">// 初始化其他信息</span></div><div class="line">    starter(self, manager);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>说明：构造函数中初始化了stop字段和manager字段，并且调用了starter函数，其源码如下<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> void starter(QuorumPeer self, QuorumCnxManager manager) &#123;</div><div class="line">    <span class="comment">// 赋值，对Leader和投票者的ID进行初始化操作</span></div><div class="line">    <span class="built_in">this</span>.self = self;</div><div class="line">    proposedLeader = <span class="number">-1</span>;</div><div class="line">    proposedZxid = <span class="number">-1</span>;</div><div class="line">    </div><div class="line">    <span class="comment">// 初始化发送队列</span></div><div class="line">    sendqueue = <span class="keyword">new</span> <span class="type">LinkedBlockingQueue</span>&lt;ToSend&gt;();</div><div class="line">    <span class="comment">// 初始化接收队列</span></div><div class="line">    recvqueue = <span class="keyword">new</span> <span class="type">LinkedBlockingQueue</span>&lt;Notification&gt;();</div><div class="line">    <span class="comment">// 创建Messenger，会启动接收器和发送器线程</span></div><div class="line">    <span class="built_in">this</span>.messenger = <span class="keyword">new</span> <span class="type">Messenger</span>(manager);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>说明：其完成在构造函数中未完成的部分，如会初始化FastLeaderElection的sendqueue和recvqueue，并且启动接收器和发送器线程。</p>
<h5 id="FastLeaderElection类的核心函数分析"><a href="#FastLeaderElection类的核心函数分析" class="headerlink" title="FastLeaderElection类的核心函数分析"></a>FastLeaderElection类的核心函数分析</h5><h6 id="sendNotifications函数"><a href="#sendNotifications函数" class="headerlink" title="sendNotifications函数　"></a>sendNotifications函数　</h6><p>说明：其会遍历所有的参与者投票集合，然后将自己的选票信息发送至上述所有的投票者集合，其并非同步发送，而是将ToSend消息放置于sendqueue中，之后由WorkerSender进行发送。<br><figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> void sendNotifications() &#123;</div><div class="line">    <span class="keyword">for</span> (QuorumServer server : <span class="keyword">self</span>.getVotingView().values()) &#123; <span class="comment">// 遍历投票参与者集合</span></div><div class="line">        <span class="keyword">long</span> sid = server.id;</div><div class="line">        </div><div class="line">        <span class="comment">// 构造发送消息</span></div><div class="line">        ToSend notmsg = <span class="keyword">new</span> ToSend(ToSend.mType.notification,</div><div class="line">                proposedLeader,</div><div class="line">                proposedZxid,</div><div class="line">                logicalclock,</div><div class="line">                QuorumPeer.ServerState.LOOKING,</div><div class="line">                sid,</div><div class="line">                proposedEpoch);</div><div class="line">        <span class="keyword">if</span>(LOG.isDebugEnabled())&#123;</div><div class="line">            LOG.debug(<span class="string">"Sending Notification: "</span> + proposedLeader + <span class="string">" (n.leader), 0x"</span>  +</div><div class="line">                  <span class="keyword">Long</span>.toHexString(proposedZxid) + <span class="string">" (n.zxid), 0x"</span> + <span class="keyword">Long</span>.toHexString(logicalclock)  +</div><div class="line">                  <span class="string">" (n.round), "</span> + sid + <span class="string">" (recipient), "</span> + <span class="keyword">self</span>.getId() +</div><div class="line">                  <span class="string">" (myid), 0x"</span> + <span class="keyword">Long</span>.toHexString(proposedEpoch) + <span class="string">" (n.peerEpoch)"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 将发送消息放置于队列</span></div><div class="line">        sendqueue.offer(notmsg);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h6 id="totalOrderPredicate函数"><a href="#totalOrderPredicate函数" class="headerlink" title="totalOrderPredicate函数"></a>totalOrderPredicate函数</h6><p>说明：该函数将接收的投票与自身投票进行PK，查看是否消息中包含的服务器id是否更优，其按照epoch、zxid、id的优先级进行PK。<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">protected boolean totalOrderPredicate(long <span class="keyword">new</span><span class="type">Id</span>, long <span class="keyword">new</span><span class="type">Zxid</span>, long <span class="keyword">new</span><span class="type">Epoch</span>, long curId, long curZxid, long curEpoch) &#123;</div><div class="line">    LOG.debug(<span class="string">"id: "</span> + <span class="keyword">new</span><span class="type">Id</span> + <span class="string">", proposed id: "</span> + curId + <span class="string">", zxid: 0x"</span> +</div><div class="line">            Long.toHexString(<span class="keyword">new</span><span class="type">Zxid</span>) + <span class="string">", proposed zxid: 0x"</span> + Long.toHexString(curZxid));</div><div class="line">    <span class="keyword">if</span>(self.getQuorumVerifier().getWeight(<span class="keyword">new</span><span class="type">Id</span>) == <span class="number">0</span>)&#123; <span class="comment">// 使用计票器判断当前服务器的权重是否为0</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">/*</span></div><div class="line">     * We return true if one of the following three cases hold:</div><div class="line">     * 1- New epoch is higher</div><div class="line">     * 2- New epoch is the same as current epoch, but new zxid is higher</div><div class="line">     * 3- New epoch is the same as current epoch, new zxid is the same</div><div class="line">     *  as current zxid, but server id is higher.</div><div class="line">     */</div><div class="line">    <span class="comment">// 1. 判断消息里的epoch是不是比当前的大，如果大则消息中id对应的服务器就是leader</span></div><div class="line">    <span class="comment">// 2. 如果epoch相等则判断zxid，如果消息里的zxid大，则消息中id对应的服务器就是leader</span></div><div class="line">    <span class="comment">// 3. 如果前面两个都相等那就比较服务器id，如果大，则其就是leader</span></div><div class="line">    <span class="keyword">return</span> ((<span class="keyword">new</span><span class="type">Epoch</span> &gt; curEpoch) ||</div><div class="line">            ((<span class="keyword">new</span><span class="type">Epoch</span> == curEpoch) &amp;&amp;</div><div class="line">            ((<span class="keyword">new</span><span class="type">Zxid</span> &gt; curZxid) || ((<span class="keyword">new</span><span class="type">Zxid</span> == curZxid) &amp;&amp; (<span class="keyword">new</span><span class="type">Id</span> &gt; curId)))));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h6 id="termPredicate函数"><a href="#termPredicate函数" class="headerlink" title="termPredicate函数"></a>termPredicate函数</h6><p>说明：该函数用于判断Leader选举是否结束，即是否有一半以上的服务器选出了相同的Leader，其过程是将收到的选票与当前选票进行对比，选票相同的放入同一个集合，之后判断选票相同的集合是否超过了半数。　<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> boolean termPredicate(</div><div class="line">        HashMap&lt;<span class="built_in">Long</span>, Vote&gt; votes,</div><div class="line">        Vote vote) &#123;</div><div class="line"></div><div class="line">    HashSet&lt;<span class="built_in">Long</span>&gt; <span class="keyword">set</span> = new HashSet&lt;<span class="built_in">Long</span>&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * First make the views consistent. Sometimes peers will have</div><div class="line">     * different zxids for a server depending on timing.</div><div class="line">     */</div><div class="line">    <span class="keyword">for</span> (Map.Entry&lt;<span class="built_in">Long</span>,Vote&gt; entry : votes.entrySet()) &#123; <span class="comment">// 遍历已经接收的投票集合</span></div><div class="line">        <span class="keyword">if</span> (vote.equals(entry.getValue()))&#123; <span class="comment">// 将等于当前投票的项放入set</span></div><div class="line">            <span class="keyword">set</span>.add(entry.getKey());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//统计set，查看投某个id的票数是否超过一半</span></div><div class="line">    <span class="keyword">return</span> self.getQuorumVerifier().containsQuorum(<span class="keyword">set</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h6 id="checkLeader函数"><a href="#checkLeader函数" class="headerlink" title="checkLeader函数"></a>checkLeader函数</h6><p>说明：该函数检查是否已经完成了Leader的选举，此时Leader的状态应该是LEADING状态。　<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="built_in">boolean</span> checkLeader(</div><div class="line">        <span class="keyword">HashMap</span>&lt;Long, Vote&gt; votes,</div><div class="line">        <span class="keyword">long</span> leader,</div><div class="line">        <span class="keyword">long</span> electionEpoch)&#123;</div><div class="line">    </div><div class="line">    <span class="built_in">boolean</span> predicate = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * If everyone else thinks I'm the leader, I must be the leader.</div><div class="line">     * The other two checks are just for the case in which I'm not the</div><div class="line">     * leader. If I'm not the leader and I haven't received a message</div><div class="line">     * from leader stating that it is leading, then predicate is false.</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(leader != self.getId())&#123; <span class="comment">// 自己不为leader</span></div><div class="line">        <span class="keyword">if</span>(votes.<span class="built_in">get</span>(leader) == <span class="keyword">null</span>) predicate = <span class="keyword">false</span>; <span class="comment">// 还未选出leader</span></div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(votes.<span class="built_in">get</span>(leader).getState() != ServerState.LEADING) predicate = <span class="keyword">false</span>; <span class="comment">// 选出的leader还未给出ack信号，其他服务器还不知道leader</span></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(logicalclock != electionEpoch) &#123; <span class="comment">// 逻辑时钟不等于选举周期</span></div><div class="line">        predicate = <span class="keyword">false</span>;</div><div class="line">    &#125; </div><div class="line"></div><div class="line">    <span class="keyword">return</span> predicate;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h6 id="lookForLeader函数"><a href="#lookForLeader函数" class="headerlink" title="lookForLeader函数　　"></a>lookForLeader函数　　</h6><figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Vote lookForLeader() throws InterruptedException &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">self</span>.jmxLeaderElectionBean = <span class="keyword">new</span> LeaderElectionBean();</div><div class="line">        MBeanRegistry.getInstance().register(</div><div class="line">                <span class="keyword">self</span>.jmxLeaderElectionBean, <span class="keyword">self</span>.jmxLocalPeerBean);</div><div class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> e) &#123;</div><div class="line">        LOG.warn(<span class="string">"Failed to register with JMX"</span>, e);</div><div class="line">        <span class="keyword">self</span>.jmxLeaderElectionBean = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.start_fle == <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">self</span>.start_fle = System.currentTimeMillis();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        HashMap&lt;<span class="keyword">Long</span>, Vote&gt; recvset = <span class="keyword">new</span> HashMap&lt;<span class="keyword">Long</span>, Vote&gt;();</div><div class="line"></div><div class="line">        HashMap&lt;<span class="keyword">Long</span>, Vote&gt; outofelection = <span class="keyword">new</span> HashMap&lt;<span class="keyword">Long</span>, Vote&gt;();</div><div class="line"></div><div class="line">        <span class="keyword">int</span> notTimeout = finalizeWait;</div><div class="line"></div><div class="line">        synchronized(this)&#123;</div><div class="line">            <span class="comment">// 更新逻辑时钟，每进行一轮选举，都需要更新逻辑时钟</span></div><div class="line">            logicalclock++;</div><div class="line">            <span class="comment">// 更新选票</span></div><div class="line">            updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        LOG.info(<span class="string">"New election. My id =  "</span> + <span class="keyword">self</span>.getId() +</div><div class="line">                <span class="string">", proposed zxid=0x"</span> + <span class="keyword">Long</span>.toHexString(proposedZxid));</div><div class="line">        <span class="comment">// 想其他服务器发送自己的选票</span></div><div class="line">        sendNotifications();</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Loop in which we exchange notifications until we find a leader</div><div class="line">         */</div><div class="line"></div><div class="line">        <span class="keyword">while</span> ((<span class="keyword">self</span>.getPeerState() == ServerState.LOOKING) &amp;&amp;</div><div class="line">                (!stop))&#123; <span class="comment">// 本服务器状态为LOOKING并且还未选出leader</span></div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Remove next notification from queue, times out after 2 times</div><div class="line">             * the termination time</div><div class="line">             */</div><div class="line">            <span class="comment">// 从recvqueue接收队列中取出投票</span></div><div class="line">            Notification n = recvqueue.poll(notTimeout,</div><div class="line">                    TimeUnit.MILLISECONDS);</div><div class="line"></div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Sends more notifications if haven't received enough.</div><div class="line">             * Otherwise processes new notification.</div><div class="line">             */</div><div class="line">            <span class="keyword">if</span>(n == <span class="keyword">null</span>)&#123; <span class="comment">// 如果没有收到足够多的选票，则发送选票</span></div><div class="line">                <span class="keyword">if</span>(manager.haveDelivered())&#123; <span class="comment">// manager已经发送了所有选票消息</span></div><div class="line">                    <span class="comment">// 向所有其他服务器发送消息</span></div><div class="line">                    sendNotifications();</div><div class="line">                &#125; <span class="keyword">else</span> &#123; <span class="comment">// 还未发送所有消息</span></div><div class="line">                    <span class="comment">// 连接其他每个服务器</span></div><div class="line">                    manager.connectAll();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * Exponential backoff</div><div class="line">                 */</div><div class="line">                <span class="keyword">int</span> tmpTimeOut = notTimeout*<span class="number">2</span>;</div><div class="line">                notTimeout = (tmpTimeOut &lt; maxNotificationInterval?</div><div class="line">                        tmpTimeOut : maxNotificationInterval);</div><div class="line">                LOG.info(<span class="string">"Notification time out: "</span> + notTimeout);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">self</span>.getVotingView().containsKey(n.sid)) &#123; <span class="comment">// 投票者集合中包含接收到消息中的服务器id</span></div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * Only proceed if the vote comes from a replica in the</div><div class="line">                 * voting view.</div><div class="line">                 */</div><div class="line">                <span class="keyword">switch</span> (n.state) &#123; <span class="comment">// 确定接收消息中的服务器状态</span></div><div class="line">                <span class="keyword">case</span> LOOKING: </div><div class="line">                    <span class="comment">// If notification &gt; current, replace and send messages out</span></div><div class="line">                    <span class="keyword">if</span> (n.electionEpoch &gt; logicalclock) &#123; <span class="comment">// 其选举周期大于逻辑时钟</span></div><div class="line">                        <span class="comment">// 重新赋值逻辑时钟</span></div><div class="line">                        logicalclock = n.electionEpoch;</div><div class="line">                        recvset.clear();</div><div class="line">                        <span class="keyword">if</span>(totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</div><div class="line">                                getInitId(), getInitLastLoggedZxid(), getPeerEpoch())) &#123; <span class="comment">// 选出较优的服务器</span></div><div class="line">                            <span class="comment">// 更新选票</span></div><div class="line">                            updateProposal(n.leader, n.zxid, n.peerEpoch);</div><div class="line">                        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 无法选出较优的服务器</span></div><div class="line">                            <span class="comment">// 更新选票</span></div><div class="line">                            updateProposal(getInitId(),</div><div class="line">                                    getInitLastLoggedZxid(),</div><div class="line">                                    getPeerEpoch());</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">// 发送消息</span></div><div class="line">                        sendNotifications();</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (n.electionEpoch &lt; logicalclock) &#123; <span class="comment">// 选举周期小于逻辑时钟，不做处理</span></div><div class="line">                        <span class="keyword">if</span>(LOG.isDebugEnabled())&#123;</div><div class="line">                            LOG.debug(<span class="string">"Notification election epoch is smaller than logicalclock. n.electionEpoch = 0x"</span></div><div class="line">                                    + <span class="keyword">Long</span>.toHexString(n.electionEpoch)</div><div class="line">                                    + <span class="string">", logicalclock=0x"</span> + <span class="keyword">Long</span>.toHexString(logicalclock));</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</div><div class="line">                            proposedLeader, proposedZxid, proposedEpoch)) &#123; <span class="comment">// 等于，并且能选出较优的服务器</span></div><div class="line">                        <span class="comment">// 更新选票</span></div><div class="line">                        updateProposal(n.leader, n.zxid, n.peerEpoch);</div><div class="line">                        <span class="comment">// 发送消息</span></div><div class="line">                        sendNotifications();</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span>(LOG.isDebugEnabled())&#123;</div><div class="line">                        LOG.debug(<span class="string">"Adding vote: from="</span> + n.sid +</div><div class="line">                                <span class="string">", proposed leader="</span> + n.leader +</div><div class="line">                                <span class="string">", proposed zxid=0x"</span> + <span class="keyword">Long</span>.toHexString(n.zxid) +</div><div class="line">                                <span class="string">", proposed election epoch=0x"</span> + <span class="keyword">Long</span>.toHexString(n.electionEpoch));</div><div class="line">                    &#125;</div><div class="line">                    </div><div class="line">                    <span class="comment">// recvset用于记录当前服务器在本轮次的Leader选举中收到的所有外部投票</span></div><div class="line">                    recvset.put(n.sid, <span class="keyword">new</span> Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch));</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (termPredicate(recvset,</div><div class="line">                            <span class="keyword">new</span> Vote(proposedLeader, proposedZxid,</div><div class="line">                                    logicalclock, proposedEpoch))) &#123; <span class="comment">// 若能选出leader</span></div><div class="line"></div><div class="line">                        <span class="comment">// Verify if there is any change in the proposed leader</span></div><div class="line">                        <span class="keyword">while</span>((n = recvqueue.poll(finalizeWait,</div><div class="line">                                TimeUnit.MILLISECONDS)) != <span class="keyword">null</span>)&#123; <span class="comment">// 遍历已经接收的投票集合</span></div><div class="line">                            <span class="keyword">if</span>(totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</div><div class="line">                                    proposedLeader, proposedZxid, proposedEpoch))&#123; <span class="comment">// 能够选出较优的服务器</span></div><div class="line">                                recvqueue.put(n);</div><div class="line">                                <span class="keyword">break</span>;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="comment">/*</span></div><div class="line">                         * This predicate is true once we don't read any new</div><div class="line">                         * relevant message from the reception queue</div><div class="line">                         */</div><div class="line">                        <span class="keyword">if</span> (n == <span class="keyword">null</span>) &#123;</div><div class="line">                            <span class="keyword">self</span>.setPeerState((proposedLeader == <span class="keyword">self</span>.getId()) ?</div><div class="line">                                    ServerState.LEADING: learningState());</div><div class="line"></div><div class="line">                            Vote endVote = <span class="keyword">new</span> Vote(proposedLeader,</div><div class="line">                                                    proposedZxid,</div><div class="line">                                                    logicalclock,</div><div class="line">                                                    proposedEpoch);</div><div class="line">                            leaveInstance(endVote);</div><div class="line">                            <span class="keyword">return</span> endVote;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> OBSERVING:</div><div class="line">                    LOG.debug(<span class="string">"Notification from observer: "</span> + n.sid);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> FOLLOWING:</div><div class="line">                <span class="keyword">case</span> LEADING: <span class="comment">// 处于LEADING状态</span></div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     * Consider all notifications from the same epoch</div><div class="line">                     * together.</div><div class="line">                     */</div><div class="line">                    <span class="keyword">if</span>(n.electionEpoch == logicalclock)&#123; <span class="comment">// 与逻辑时钟相等</span></div><div class="line">                        <span class="comment">// 将该服务器和选票信息放入recvset中</span></div><div class="line">                        recvset.put(n.sid, <span class="keyword">new</span> Vote(n.leader,</div><div class="line">                                                      n.zxid,</div><div class="line">                                                      n.electionEpoch,</div><div class="line">                                                      n.peerEpoch));</div><div class="line">                       </div><div class="line">                        <span class="keyword">if</span>(ooePredicate(recvset, outofelection, n)) &#123; <span class="comment">// 判断是否完成了leader选举</span></div><div class="line">                            <span class="comment">// 设置本服务器的状态</span></div><div class="line">                            <span class="keyword">self</span>.setPeerState((n.leader == <span class="keyword">self</span>.getId()) ?</div><div class="line">                                    ServerState.LEADING: learningState());</div><div class="line">                            <span class="comment">// 创建投票信息</span></div><div class="line">                            Vote endVote = <span class="keyword">new</span> Vote(n.leader, </div><div class="line">                                    n.zxid, </div><div class="line">                                    n.electionEpoch, </div><div class="line">                                    n.peerEpoch);</div><div class="line">                            leaveInstance(endVote);</div><div class="line">                            <span class="keyword">return</span> endVote;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     * Before joining an established ensemble, verify</div><div class="line">                     * a majority is following the same leader.</div><div class="line">                     */</div><div class="line">                    outofelection.put(n.sid, <span class="keyword">new</span> Vote(n.version,</div><div class="line">                                                        n.leader,</div><div class="line">                                                        n.zxid,</div><div class="line">                                                        n.electionEpoch,</div><div class="line">                                                        n.peerEpoch,</div><div class="line">                                                        n.state));</div><div class="line">       </div><div class="line">                    <span class="keyword">if</span>(ooePredicate(outofelection, outofelection, n)) &#123;</div><div class="line">                        synchronized(this)&#123;</div><div class="line">                            logicalclock = n.electionEpoch;</div><div class="line">                            <span class="keyword">self</span>.setPeerState((n.leader == <span class="keyword">self</span>.getId()) ?</div><div class="line">                                    ServerState.LEADING: learningState());</div><div class="line">                        &#125;</div><div class="line">                        Vote endVote = <span class="keyword">new</span> Vote(n.leader,</div><div class="line">                                                n.zxid,</div><div class="line">                                                n.electionEpoch,</div><div class="line">                                                n.peerEpoch);</div><div class="line">                        leaveInstance(endVote);</div><div class="line">                        <span class="keyword">return</span> endVote;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    LOG.warn(<span class="string">"Notification state unrecognized: &#123;&#125; (n.state), &#123;&#125; (n.sid)"</span>,</div><div class="line">                            n.state, n.sid);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                LOG.warn(<span class="string">"Ignoring notification from non-cluster member "</span> + n.sid);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span>(<span class="keyword">self</span>.jmxLeaderElectionBean != <span class="keyword">null</span>)&#123;</div><div class="line">                MBeanRegistry.getInstance().unregister(</div><div class="line">                        <span class="keyword">self</span>.jmxLeaderElectionBean);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> e) &#123;</div><div class="line">            LOG.warn(<span class="string">"Failed to unregister with JMX"</span>, e);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">self</span>.jmxLeaderElectionBean = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>说明：该函数用于开始新一轮的Leader选举，其首先会将逻辑时钟自增，然后更新本服务器的选票信息（初始化选票），之后将选票信息放入sendqueue等待发送给其他服务器，其流程如下　<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">synchronized</span>(this)&#123;</div><div class="line">    <span class="comment">// 更新逻辑时钟，每进行一轮新的leader选举，都需要更新逻辑时钟</span></div><div class="line">    <span class="selector-tag">logicalclock</span>++;</div><div class="line">    <span class="comment">// 更新选票（初始化选票）</span></div><div class="line">    <span class="selector-tag">updateProposal</span>(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">LOG</span><span class="selector-class">.info</span>(<span class="string">"New election. My id =  "</span> + self.getId() +</div><div class="line">        <span class="string">", proposed zxid=0x"</span> + Long.toHexString(proposedZxid));</div><div class="line"><span class="comment">// 向其他服务器发送自己的选票（已更新的选票）</span></div><div class="line"><span class="selector-tag">sendNotifications</span>();</div></pre></td></tr></table></figure></p>
<p>之后每台服务器会不断地从recvqueue队列中获取外部选票。如果服务器发现无法获取到任何外部投票，就立即确认自己是否和集群中其他服务器保持着有效的连接，如果没有连接，则马上建立连接，如果已经建立了连接，则再次发送自己当前的内部投票，其流程如下　　<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 从recvqueue接收队列中取出投票</span></div><div class="line">Notification n = recvqueue.poll(notTimeout,</div><div class="line">        TimeUnit.MILLISECONDS);</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * Sends more notifications if haven't received enough.</div><div class="line"> * Otherwise processes new notification.</div><div class="line"> */</div><div class="line"><span class="keyword">if</span>(n == <span class="literal">null</span>)&#123; <span class="comment">// 无法获取选票</span></div><div class="line">    <span class="keyword">if</span>(manager.haveDelivered())&#123; <span class="comment">// manager已经发送了所有选票消息（表示有连接）</span></div><div class="line">        <span class="comment">// 向所有其他服务器发送消息</span></div><div class="line">        sendNotifications();</div><div class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 还未发送所有消息（表示无连接）</span></div><div class="line">        <span class="comment">// 连接其他每个服务器</span></div><div class="line">        manager.connectAll();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Exponential backoff</div><div class="line">     */</div><div class="line">    <span class="keyword">int</span> tmpTimeOut = notTimeout*<span class="number">2</span>;</div><div class="line">    notTimeout = (tmpTimeOut &lt; maxNotificationInterval?</div><div class="line">            tmpTimeOut : maxNotificationInterval);</div><div class="line">    LOG.info(<span class="string">"Notification time out: "</span> + notTimeout);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在发送完初始化选票之后，接着开始处理外部投票。在处理外部投票时，会根据选举轮次来进行不同的处理。　　</p>
<ul>
<li><p><strong><em>外部投票的选举轮次大于内部投票</em></strong>。若服务器自身的选举轮次落后于该外部投票对应服务器的选举轮次，那么就会立即更新自己的选举轮次(logicalclock)，并且清空所有已经收到的投票，然后使用初始化的投票来进行PK以确定是否变更内部投票。最终再将内部投票发送出去。</p>
</li>
<li><p><strong><em>外部投票的选举轮次小于内部投票</em></strong>。若服务器接收的外选票的选举轮次落后于自身的选举轮次，那么Zookeeper就会直接忽略该外部投票，不做任何处理。</p>
</li>
<li><p><strong><em>外部投票的选举轮次等于内部投票</em></strong>。此时可以开始进行选票PK，如果消息中的选票更优，则需要更新本服务器内部选票，再发送给其他服务器。</p>
</li>
</ul>
<p>之后再对选票进行归档操作，无论是否变更了投票，都会将刚刚收到的那份外部投票放入选票集合recvset中进行归档，其中recvset用于记录当前服务器在本轮次的Leader选举中收到的所有外部投票，然后开始统计投票，统计投票是为了统计集群中是否已经有过半的服务器认可了当前的内部投票，如果确定已经有过半服务器认可了该投票，然后再进行最后一次确认，判断是否又有更优的选票产生，若无，则终止投票，然后最终的选票，其流程如下<br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (n.electionEpoch &gt; logicalclock) &#123; <span class="comment">// 其选举周期大于逻辑时钟</span></div><div class="line">    <span class="comment">// 重新赋值逻辑时钟</span></div><div class="line">    logicalclock = n.electionEpoch;</div><div class="line">    <span class="comment">// 清空所有接收到的所有选票</span></div><div class="line">    recvset.<span class="keyword">clear</span>();</div><div class="line">    <span class="keyword">if</span>(totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</div><div class="line">            getInitId(), getInitLastLoggedZxid(), getPeerEpoch())) &#123; <span class="comment">// 进行PK，选出较优的服务器</span></div><div class="line">        <span class="comment">// 更新选票</span></div><div class="line">        updateProposal(n.leader, n.zxid, n.peerEpoch);</div><div class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 无法选出较优的服务器</span></div><div class="line">        <span class="comment">// 更新选票</span></div><div class="line">        updateProposal(getInitId(),</div><div class="line">                getInitLastLoggedZxid(),</div><div class="line">                getPeerEpoch());</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 发送本服务器的内部选票消息</span></div><div class="line">    sendNotifications();</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (n.electionEpoch &lt; logicalclock) &#123; <span class="comment">// 选举周期小于逻辑时钟，不做处理，直接忽略</span></div><div class="line">    <span class="keyword">if</span>(<span class="built_in">LOG</span>.isDebugEnabled())&#123;</div><div class="line">        <span class="built_in">LOG</span>.<span class="keyword">debug</span>(<span class="string">"Notification election epoch is smaller than logicalclock. n.electionEpoch = 0x"</span></div><div class="line">                + Long.toHexString(n.electionEpoch)</div><div class="line">                + <span class="string">", logicalclock=0x"</span> + Long.toHexString(logicalclock));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">break</span>;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</div><div class="line">        proposedLeader, proposedZxid, proposedEpoch)) &#123; <span class="comment">// PK，选出较优的服务器</span></div><div class="line">    <span class="comment">// 更新选票</span></div><div class="line">    updateProposal(n.leader, n.zxid, n.peerEpoch);</div><div class="line">    <span class="comment">// 发送消息</span></div><div class="line">    sendNotifications();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span>(<span class="built_in">LOG</span>.isDebugEnabled())&#123;</div><div class="line">    <span class="built_in">LOG</span>.<span class="keyword">debug</span>(<span class="string">"Adding vote: from="</span> + n.sid +</div><div class="line">            <span class="string">", proposed leader="</span> + n.leader +</div><div class="line">            <span class="string">", proposed zxid=0x"</span> + Long.toHexString(n.zxid) +</div><div class="line">            <span class="string">", proposed election epoch=0x"</span> + Long.toHexString(n.electionEpoch));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// recvset用于记录当前服务器在本轮次的Leader选举中收到的所有外部投票</span></div><div class="line">recvset.put(n.sid, <span class="keyword">new</span> Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch));</div><div class="line"></div><div class="line"><span class="keyword">if</span> (termPredicate(recvset,</div><div class="line">        <span class="keyword">new</span> Vote(proposedLeader, proposedZxid,</div><div class="line">                logicalclock, proposedEpoch))) &#123; <span class="comment">// 若能选出leader</span></div><div class="line"></div><div class="line">    <span class="comment">// Verify if there is any change in the proposed leader</span></div><div class="line">    <span class="keyword">while</span>((n = recvqueue.poll(finalizeWait,</div><div class="line">            TimeUnit.MILLISECONDS)) != <span class="built_in">null</span>)&#123; <span class="comment">// 遍历已经接收的投票集合</span></div><div class="line">        <span class="keyword">if</span>(totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,</div><div class="line">                proposedLeader, proposedZxid, proposedEpoch))&#123; <span class="comment">// 选票有变更，比之前提议的Leader有更好的选票加入</span></div><div class="line">            <span class="comment">// 将更优的选票放在recvset中</span></div><div class="line">            recvqueue.put(n);</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * This predicate is true once we don't read any new</div><div class="line">     * relevant message from the reception queue</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (n == <span class="built_in">null</span>) &#123; <span class="comment">// 表示之前提议的Leader已经是最优的</span></div><div class="line">        <span class="comment">// 设置服务器状态</span></div><div class="line">        self.setPeerState((proposedLeader == self.getId()) ?</div><div class="line">                ServerState.LEADING: learningState());</div><div class="line">        <span class="comment">// 最终的选票</span></div><div class="line">        Vote endVote = <span class="keyword">new</span> Vote(proposedLeader,</div><div class="line">                                proposedZxid,</div><div class="line">                                logicalclock,</div><div class="line">                                proposedEpoch);</div><div class="line">        <span class="comment">// 清空recvqueue队列的选票</span></div><div class="line">        leaveInstance(endVote);</div><div class="line">        <span class="comment">// 返回选票</span></div><div class="line">        <span class="keyword">return</span> endVote;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>若选票中的服务器状态为FOLLOWING或者LEADING时，其大致步骤会判断选举周期是否等于逻辑时钟，归档选票，是否已经完成了Leader选举，设置服务器状态，修改逻辑时钟等于选举周期，返回最终选票，其流程如下<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(n.electionEpoch == logicalclock)&#123; <span class="comment">// 与逻辑时钟相等</span></div><div class="line">    <span class="comment">// 将该服务器和选票信息放入recvset中</span></div><div class="line">    recvset.put(n.sid, <span class="keyword">new</span> <span class="type">Vote</span>(n.leader,</div><div class="line">                                  n.zxid,</div><div class="line">                                  n.electionEpoch,</div><div class="line">                                  n.peerEpoch));</div><div class="line">   </div><div class="line">    <span class="keyword">if</span>(ooePredicate(recvset, outofelection, n)) &#123; <span class="comment">// 已经完成了leader选举</span></div><div class="line">        <span class="comment">// 设置本服务器的状态</span></div><div class="line">        self.setPeerState((n.leader == self.getId()) ?</div><div class="line">                ServerState.LEADING: <span class="type">learningState</span>());</div><div class="line">        <span class="comment">// 最终的选票</span></div><div class="line">        Vote endVote = <span class="keyword">new</span> <span class="type">Vote</span>(n.leader, </div><div class="line">                n.zxid, </div><div class="line">                n.electionEpoch, </div><div class="line">                n.peerEpoch);</div><div class="line">        <span class="comment">// 清空recvqueue队列的选票</span></div><div class="line">        leaveInstance(endVote);</div><div class="line">        <span class="keyword">return</span> endVote;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * Before joining an established ensemble, verify</div><div class="line"> * a majority is following the same leader.</div><div class="line"> */</div><div class="line">outofelection.put(n.sid, <span class="keyword">new</span> <span class="type">Vote</span>(n.version,</div><div class="line">                                    n.leader,</div><div class="line">                                    n.zxid,</div><div class="line">                                    n.electionEpoch,</div><div class="line">                                    n.peerEpoch,</div><div class="line">                                    n.state));</div><div class="line"></div><div class="line"><span class="keyword">if</span>(ooePredicate(outofelection, outofelection, n)) &#123; <span class="comment">// 已经完成了leader选举</span></div><div class="line">    synchronized(<span class="built_in">this</span>)&#123;</div><div class="line">        <span class="comment">// 设置逻辑时钟</span></div><div class="line">        logicalclock = n.electionEpoch;</div><div class="line">        <span class="comment">// 设置状态</span></div><div class="line">        self.setPeerState((n.leader == self.getId()) ?</div><div class="line">                ServerState.LEADING: <span class="type">learningState</span>());</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 最终选票</span></div><div class="line">    Vote endVote = <span class="keyword">new</span> <span class="type">Vote</span>(n.leader,</div><div class="line">                            n.zxid,</div><div class="line">                            n.electionEpoch,</div><div class="line">                            n.peerEpoch);</div><div class="line">    <span class="comment">// 清空recvqueue队列的选票</span></div><div class="line">    leaveInstance(endVote);</div><div class="line">    <span class="comment">// 返回选票</span></div><div class="line">    <span class="keyword">return</span> endVote;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Zookeeper的典型应用场景："><a href="#Zookeeper的典型应用场景：" class="headerlink" title="Zookeeper的典型应用场景："></a>Zookeeper的典型应用场景：</h2><h3 id="统一命名服务"><a href="#统一命名服务" class="headerlink" title="统一命名服务"></a>统一命名服务</h3><p>在分布式系统中，通过使用命名服务，客户端应用能够根据指定名字来获取资源或服务的地址，提供者等信息。被命名的实体通常可以是集群中的机器，提供的服务地址，远程对象等等——这些我们都可以统称他们为名字（Name）</p>
<h3 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h3><p>配置的管理在分布式应用环境中很常见，例如同一个应用系统需要多台 PC Server 运行，但是它们运行的应用系统的某些配置项是相同的，如果要修改这些相同的配置项，那么就必须同时修改每台运行这个应用系统的 PC Server，这样非常麻烦而且容易出错。</p>
<p>像这样的配置信息完全可以交给 Zookeeper 来管理，将配置信息保存在 Zookeeper 的某个目录节点中，然后将所有需要修改的应用机器监控配置信息的状态，一旦配置信息发生变化，每台应用机器就会收到 Zookeeper 的通知，然后从 Zookeeper 获取新的配置信息应用到系统中</p>
<h3 id="集群管理"><a href="#集群管理" class="headerlink" title="集群管理"></a>集群管理</h3><p>Zookeeper 能够很容易的实现集群管理的功能，如有多台 Server 组成一个服务集群，那么必须要一个“总管”知道当前集群中每台机器的服务状态，一旦有机器不能提供服务，集群中其它集群必须知道，从而做出调整重新分配服务策略。同样当增加集群的服务能力时，就会增加一台或多台 Server，同样也必须让“总管”知道。</p>
<h3 id="共享锁"><a href="#共享锁" class="headerlink" title="共享锁"></a>共享锁</h3><p>共享锁在同一个进程中很容易实现，但是在跨进程或者在不同 Server 之间就不好实现了。Zookeeper 却很容易实现这个功能，实现方式也是需要获得锁的 Server 创建一个 EPHEMERAL_SEQUENTIAL 目录节点，然后调用 getChildren方法获取当前的目录节点列表中最小的目录节点是不是就是自己创建的目录节点，如果正是自己创建的，那么它就获得了这个锁，如果不是那么它就调用 exists(String path, boolean watch) 方法并监控 Zookeeper 上目录节点列表的变化，一直到自己创建的节点是列表中最小编号的目录节点，从而获得锁，释放锁很简单，只要删除前面它自己所创建的目录节点就行了。<br><img src="/uploads/zookeeper1.jpg" alt=""></p>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>在分布式环境中，为了保证高可用性，通常同一个应用或同一个服务的提供方都会部署多份，达到对等服务。而消费者就须要在这些对等的服务器中选择一个来执行相关的业务逻辑。</p>
<h3 id="分布式通知-协调"><a href="#分布式通知-协调" class="headerlink" title="分布式通知/协调"></a>分布式通知/协调</h3><p>ZooKeeper中特有watcher注册与异步通知机制，能够很好的实现分布式环境下不同系统之间的通知与协调，实现对数据变更的实时处理。使用方法通常是不同系统都对ZK上同一个znode进行注册，监听znode的变化（包括znode本身内容及子节点的），其中一个系统update了znode，那么另一个系统能够收到通知，并作出相应处理</p>
<h3 id="实际应用"><a href="#实际应用" class="headerlink" title="实际应用"></a>实际应用</h3><h4 id="Zookeeper实现Dubbo注册中心"><a href="#Zookeeper实现Dubbo注册中心" class="headerlink" title="Zookeeper实现Dubbo注册中心"></a>Zookeeper实现Dubbo注册中心</h4><p>Dubbo的Provider，Consumer在启动时都会创建一个注册中心，注册中心可以选择Zookeeper，Redis。常用的是Zookeeper。<br>Dubbo在Zookeeper上注册的节点目录(假设接口名称是：com.bob.dubbo.service.CityDubboService)：<br><img src="/uploads/zookeeper15.jpg" alt=""><br>Dubbo启动时，Consumer和Provider都会把自身的URL格式化为字符串，然后注册到zookeeper相应节点下，作为一个临时节点，当连断开时，节点被删除。<br>Consumer在启动时，不仅仅会注册自身到 …/consumers/目录下，同时还会订阅…/providers目录，实时获取其上Provider的URL字符串信息。</p>
<ul>
<li>Provider和Consumer向Zookeeper注册临时节点，当连接断开时删除相应的注册节点。</li>
<li>Consumer订阅Providers节点的子节点，实时感知Provider的变化情况，实时同步自身的Invoker对象，保证RPC的可用性。</li>
</ul>
<p>相关代码：<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZookeeperRegistry</span> <span class="keyword">extends</span> <span class="title">FailbackRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    ......</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 默认端口</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> DEFAULT_ZOOKEEPER_PORT = <span class="number">2181</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 默认 Zookeeper 根节点</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String DEFAULT_ROOT = <span class="string">"dubbo"</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Zookeeper 根节点</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String root;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Service 接口全名集合</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; anyServices = <span class="keyword">new</span> ConcurrentHashSet&lt;String&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 监听器集合</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;URL, ConcurrentMap&lt;NotifyListener, ChildListener&gt;&gt; zkListeners</div><div class="line">        = <span class="keyword">new</span> ConcurrentHashMap&lt;URL, ConcurrentMap&lt;NotifyListener, ChildListener&gt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Zookeeper 客户端</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ZookeeperClient zkClient;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> ZookeeperRegistry(URL url, ZookeeperTransporter zookeeperTransporter) &#123;</div><div class="line">        <span class="keyword">super</span>(url);   <span class="comment">// 调用父类FailbackRegistry的构造函数</span></div><div class="line">        <span class="keyword">if</span> (url.isAnyHost()) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"registry address == null"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 获得 Zookeeper 根节点, 未指定 "group" 参数时为 dubbo</span></div><div class="line">        String <span class="keyword">group</span> = url.getParameter(Constants.GROUP_KEY, DEFAULT_ROOT); <span class="comment">// `url.parameters.group` 参数值</span></div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">group</span>.startsWith(Constants.PATH_SEPARATOR)) &#123;</div><div class="line">            <span class="keyword">group</span> = Constants.PATH_SEPARATOR + <span class="keyword">group</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.root = <span class="keyword">group</span>;   <span class="comment">// root = "/dubbo"</span></div><div class="line">        <span class="comment">// 创建 Zookeeper Client</span></div><div class="line">        zkClient = zookeeperTransporter.connect(url);</div><div class="line">        <span class="comment">// 添加 StateListener 对象。该监听器，在重连时，调用恢复方法。</span></div><div class="line">        zkClient.addStateListener(<span class="keyword">new</span> StateListener() &#123;</div><div class="line">            @Override</div><div class="line">            <span class="keyword">public</span> <span class="keyword">void</span> stateChanged(<span class="keyword">int</span> state) &#123;</div><div class="line">                <span class="keyword">if</span> (state == RECONNECTED) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        recover();</div><div class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                        logger.error(e.getMessage(), e);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FailbackRegistry</span> <span class="keyword">extends</span> <span class="title">AbstractRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    ......</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 失败发起注册失败的 URL 集合</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;URL&gt; failedRegistered = <span class="keyword">new</span> ConcurrentHashSet&lt;URL&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 失败取消注册失败的 URL 集合</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;URL&gt; failedUnregistered = <span class="keyword">new</span> ConcurrentHashSet&lt;URL&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 失败发起订阅失败的监听器集合</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;URL, Set&lt;NotifyListener&gt;&gt; failedSubscribed = <span class="keyword">new</span> ConcurrentHashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 失败取消订阅失败的监听器集合</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;URL, Set&lt;NotifyListener&gt;&gt; failedUnsubscribed = <span class="keyword">new</span> ConcurrentHashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 失败通知通知的 URL 集合</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;URL, Map&lt;NotifyListener, List&lt;URL&gt;&gt;&gt; failedNotified = <span class="keyword">new</span> ConcurrentHashMap&lt;URL, Map&lt;NotifyListener, List&lt;URL&gt;&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">public</span> FailbackRegistry(URL url) &#123;</div><div class="line">        <span class="keyword">super</span>(url);</div><div class="line">        <span class="comment">// 重试频率，单位：毫秒 ，默认 5*1000</span></div><div class="line">        <span class="keyword">int</span> retryPeriod = url.getParameter(Constants.REGISTRY_RETRY_PERIOD_KEY, Constants.DEFAULT_REGISTRY_RETRY_PERIOD);</div><div class="line">        <span class="comment">// 创建失败重试定时器</span></div><div class="line">        <span class="keyword">this</span>.retryFuture = retryExecutor.scheduleWithFixedDelay(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="keyword">public</span> <span class="keyword">void</span> run() &#123;</div><div class="line">                <span class="comment">// Check and connect to the registry</span></div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    retry();</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123; <span class="comment">// Defensive fault tolerance</span></div><div class="line">                    logger.error(<span class="string">"Unexpected error occur at failed retry, cause: "</span> + t.getMessage(), t);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;, retryPeriod, retryPeriod, TimeUnit.MILLISECONDS);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 重试</div><div class="line">     */</div><div class="line">    <span class="comment">// Retry the failed actions</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> retry() &#123;</div><div class="line">        <span class="comment">// 重试执行注册</span></div><div class="line">        <span class="keyword">if</span> (!failedRegistered.isEmpty()) &#123;</div><div class="line">            ......</div><div class="line">            <span class="keyword">for</span> (URL url : failed) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="comment">// 执行注册</span></div><div class="line">                    doRegister(url);</div><div class="line">                    <span class="comment">// 移除出 `failedRegistered`</span></div><div class="line">                    failedRegistered.remove(url);</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123; <span class="comment">// Ignore all the exceptions and wait for the next retry</span></div><div class="line">                    logger.warn(<span class="string">"Failed to retry register "</span> + failed + <span class="string">", waiting for again, cause: "</span> + t.getMessage(), t);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 重试执行取消注册</span></div><div class="line">        <span class="keyword">if</span> (!failedUnregistered.isEmpty()) &#123;</div><div class="line">            ......</div><div class="line">            <span class="keyword">for</span> (URL url : failed) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="comment">// 执行取消注册</span></div><div class="line">                    doUnregister(url);</div><div class="line">                    <span class="comment">// 移除出 `failedUnregistered`</span></div><div class="line">                    failedUnregistered.remove(url);</div><div class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123; <span class="comment">// Ignore all the exceptions and wait for the next retry</span></div><div class="line">                    logger.warn(<span class="string">"Failed to retry unregister  "</span> + failed + <span class="string">", waiting for again, cause: "</span> + t.getMessage(), t);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 重试执行订阅</span></div><div class="line">        <span class="keyword">if</span> (!failedSubscribed.isEmpty()) &#123;</div><div class="line">            ......</div><div class="line">            <span class="keyword">for</span> (Map.Entry&lt;URL, Set&lt;NotifyListener&gt;&gt; entry : failed.entrySet()) &#123;</div><div class="line">                URL url = entry.getKey();</div><div class="line">                Set&lt;NotifyListener&gt; listeners = entry.getValue();</div><div class="line">                <span class="keyword">for</span> (NotifyListener listener : listeners) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="comment">// 执行订阅</span></div><div class="line">                        doSubscribe(url, listener);</div><div class="line">                        <span class="comment">// 移除监听器</span></div><div class="line">                        listeners.remove(listener);</div><div class="line">                    &#125; <span class="keyword">catch</span> (Throwable t) &#123; <span class="comment">// Ignore all the exceptions and wait for the next retry</span></div><div class="line">                        logger.warn(<span class="string">"Failed to retry subscribe "</span> + failed + <span class="string">", waiting for again, cause: "</span> + t.getMessage(), t);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 重试执行取消订阅</span></div><div class="line">        <span class="keyword">if</span> (!failedUnsubscribed.isEmpty()) &#123;</div><div class="line">            ......</div><div class="line">            <span class="keyword">for</span> (Map.Entry&lt;URL, Set&lt;NotifyListener&gt;&gt; entry : failed.entrySet()) &#123;</div><div class="line">                URL url = entry.getKey();</div><div class="line">                Set&lt;NotifyListener&gt; listeners = entry.getValue();</div><div class="line">                <span class="keyword">for</span> (NotifyListener listener : listeners) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="comment">// 执行取消订阅</span></div><div class="line">                        doUnsubscribe(url, listener);</div><div class="line">                        <span class="comment">// 移除监听器</span></div><div class="line">                        listeners.remove(listener);</div><div class="line">                    &#125; <span class="keyword">catch</span> (Throwable t) &#123; <span class="comment">// Ignore all the exceptions and wait for the next retry</span></div><div class="line">                        logger.warn(<span class="string">"Failed to retry unsubscribe "</span> + failed + <span class="string">", waiting for again, cause: "</span> + t.getMessage(), t);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ZookeeperRegistry 在实例化时，调用父类构造函数。在父类构造函数中，会创建一个定时任务，每隔5S执行retry( ) 方法。</p>
<p>在retry( ) 方法中，重试那些失败的动作。重试的动作包括：</p>
<ul>
<li>Provider向zookeeper注册自身的url，生成一个临时的znode</li>
<li>Provider从Dubbo容器中退出，停止提供RPC调用。也就是移除zookeeper内自身url对应的znode</li>
<li>Consumer订阅 ” /dubbo/..Service/providers” 目录的子节点，生成ChildListener</li>
<li>Consumer从Dubbo容器中退出，移除之前创建的ChildListener</li>
</ul>
<p>为什么如此设置？ 主要是和zookeeper的通信机制有关的。当zookeeper的Client和Server连接断开，或者心跳超时，那么Server会将相应Client注册的临时节点删除，当然注册的Listener也相应删除。</p>
<p>而Provider和Consumer注册的URL就属于临时节点，当连接断开时，Dubbo注册了zookeeper的StateListener，也就是状态监听器，当Dubbo里的zookeeper Client和Server重新连接上时，将之前注册的的URL添加入这几个失败集合中，然后重新注册和订阅。</p>
<p>看ZookeeperRegistry 的构造函数，其添加了一个StateListener：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ZookeeperRegistry</span> <span class="keyword">extends</span> <span class="title">FailbackRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    public <span class="type">ZookeeperRegistry</span>(<span class="type">URL</span> url, <span class="type">ZookeeperTransporter</span> zookeeperTransporter) &#123;</div><div class="line">        ......</div><div class="line">        <span class="comment">// 添加 StateListener 对象。该监听器，在重连时，调用恢复方法。</span></div><div class="line">        zkClient.addStateListener(<span class="keyword">new</span> <span class="type">StateListener</span>() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            public void stateChanged(int state) &#123;</div><div class="line">                <span class="keyword">if</span> (state == <span class="type">RECONNECTED</span>) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        recover();</div><div class="line">                    &#125; <span class="keyword">catch</span> (<span class="type">Exception</span> e) &#123;</div><div class="line">                        logger.error(e.getMessage(), e);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">FailbackRegistry</span> <span class="keyword">extends</span> <span class="title">AbstractRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> void recover() <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</div><div class="line">        <span class="comment">// register 恢复注册，添加到 `failedRegistered` ，定时重试</span></div><div class="line">        <span class="type">Set</span>&lt;<span class="type">URL</span>&gt; recoverRegistered = <span class="keyword">new</span> <span class="type">HashSet</span>&lt;<span class="type">URL</span>&gt;(getRegistered());</div><div class="line">        <span class="keyword">if</span> (!recoverRegistered.isEmpty()) &#123;</div><div class="line">            <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</div><div class="line">                logger.info(<span class="string">"Recover register url "</span> + recoverRegistered);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">for</span> (<span class="type">URL</span> url : recoverRegistered) &#123;</div><div class="line">                failedRegistered.add(url);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// subscribe 恢复订阅，添加到 `failedSubscribed` ，定时重试</span></div><div class="line">        <span class="type">Map</span>&lt;<span class="type">URL</span>, <span class="type">Set</span>&lt;<span class="type">NotifyListener</span>&gt;&gt; recoverSubscribed = <span class="keyword">new</span> <span class="type">HashMap</span>&lt;<span class="type">URL</span>, <span class="type">Set</span>&lt;<span class="type">NotifyListener</span>&gt;&gt;(getSubscribed());</div><div class="line">        <span class="keyword">if</span> (!recoverSubscribed.isEmpty()) &#123;</div><div class="line">            <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</div><div class="line">                logger.info(<span class="string">"Recover subscribe url "</span> + recoverSubscribed.keySet());</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">for</span> (<span class="type">Map</span>.<span class="type">Entry</span>&lt;<span class="type">URL</span>, <span class="type">Set</span>&lt;<span class="type">NotifyListener</span>&gt;&gt; entry : recoverSubscribed.entrySet()) &#123;</div><div class="line">                <span class="type">URL</span> url = entry.getKey();</div><div class="line">                <span class="keyword">for</span> (<span class="type">NotifyListener</span> listener : entry.getValue()) &#123;</div><div class="line">                    addFailedSubscribed(url, listener);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ZookeeperRegistry 构造函数中为zookeeper的操作客户端添加了一个状态监听器 StateListener，当重新连接时( 重新连接意味着之前连接断开了 )，将已经注册和订阅的URL添加到失败集合中，定时重试，也就是重新注册和订阅。</p>
<p>zookeeper Client与Server断开连接后，会定时的不断尝试重新连接，当连接成功后就会触发一个Event，Dubbo注册了CONNECTED状态的监听器，当连接成功后重新注册和订阅。</p>
<p>zookeeper Server宕机了，Dubbo里的Client并没有对此事件做什么响应，当然其内部的zkClient会不停地尝试连接Server。当Zookeeper Server宕机了不影响Dubbo里已注册的组件的RPC调用，因为已经通过URL生成了Invoker对象，这些对象还在Dubbo容器内。当然因为注册中心宕机了，肯定不能感知到新的Provider。同时因为在之前订阅获得的Provider信息已经持久化到本地文件，当Dubbo应用重启时，如果zookeeper注册中心不可用，会加载缓存在文件内的Provider信息，还是能保证服务的高可用。</p>
<p>Consumer会一直维持着对Provider的ChildListener，监听Provider的实时数据信息。当Providers节点的子节点发生变化时，实时通知Dubbo，更新URL，同时更新Dubbo容器内的Consumer Invoker对象，只要是订阅成功均会实时同步Provider，更新Invoker对象，无论是第一次订阅还是断线重连后的订阅：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ZookeeperRegistry</span> <span class="keyword">extends</span> <span class="title">FailbackRegistry</span> </span>&#123;</div><div class="line"></div><div class="line">    protected <span class="keyword">void</span> doSubscribe(<span class="keyword">final</span> URL url, <span class="keyword">final</span> NotifyListener listener) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 处理所有 Service 层的发起订阅，例如监控中心的订阅</span></div><div class="line">            <span class="keyword">if</span> (Constants.ANY_VALUE.equals(url.getServiceInterface())) &#123;</div><div class="line">                ......</div><div class="line">                <span class="comment">// 处理指定 Service 层的发起订阅，例如服务消费者的订阅</span></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// 子节点数据数组</span></div><div class="line">                <span class="built_in">List</span>&lt;URL&gt; urls = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</div><div class="line">                <span class="comment">// 循环分类数组 , router, configurator, provider</span></div><div class="line">                <span class="keyword">for</span> (<span class="built_in">String</span> path : toCategoriesPath(url)) &#123;</div><div class="line">                    <span class="comment">// 获得 url 对应的监听器集合</span></div><div class="line">                    ConcurrentMap&lt;NotifyListener, ChildListener&gt; listeners = zkListeners.<span class="keyword">get</span>(url);</div><div class="line">                    <span class="keyword">if</span> (listeners == <span class="keyword">null</span>) &#123; <span class="comment">// 不存在，进行创建</span></div><div class="line">                        zkListeners.putIfAbsent(url, <span class="keyword">new</span> ConcurrentHashMap&lt;NotifyListener, ChildListener&gt;());</div><div class="line">                        listeners = zkListeners.<span class="keyword">get</span>(url);</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// 获得 ChildListener 对象</span></div><div class="line">                    ChildListener zkListener = listeners.<span class="keyword">get</span>(listener);</div><div class="line">                    <span class="keyword">if</span> (zkListener == <span class="keyword">null</span>) &#123; <span class="comment">//  不存在子目录的监听器，进行创建 ChildListener 对象</span></div><div class="line">                        <span class="comment">// 订阅父级目录, 当有子节点发生变化时，触发此回调函数</span></div><div class="line">                        listeners.putIfAbsent(listener, <span class="keyword">new</span> ChildListener() &#123;</div><div class="line">                            <span class="meta">@Override</span></div><div class="line">                            public <span class="keyword">void</span> childChanged(<span class="built_in">String</span> parentPath, <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; currentChilds) &#123;</div><div class="line">                                <span class="comment">// 变更时，调用 `#notify(...)` 方法，回调 NotifyListener</span></div><div class="line">                                ZookeeperRegistry.<span class="keyword">this</span>.notify(url, listener, toUrlsWithEmpty(url, parentPath, currentChilds));</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                        zkListener = listeners.<span class="keyword">get</span>(listener);</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// 创建 Type 节点。该节点为持久节点。</span></div><div class="line">                    zkClient.create(path, <span class="keyword">false</span>);</div><div class="line">                    <span class="comment">// 向 Zookeeper ，PATH 节点，发起订阅,返回此节点下的所有子元素 path : /根节点/接口全名/providers, 比如 ： /dubbo/com.bob.service.CityService/providers</span></div><div class="line">                    <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; children = zkClient.addChildListener(path, zkListener);</div><div class="line">                    <span class="comment">// 添加到 `urls` 中</span></div><div class="line">                    <span class="keyword">if</span> (children != <span class="keyword">null</span>) &#123;</div><div class="line">                        urls.addAll(toUrlsWithEmpty(url, path, children));</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// 首次全量数据获取完成时，调用 `#notify(...)` 方法，回调 NotifyListener, 在这一步从连接Provider,实例化Invoker</span></div><div class="line">                notify(url, listener, urls);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Failed to subscribe "</span> + url + <span class="string">" to zookeeper "</span> + getUrl() + <span class="string">", cause: "</span> + e.getMessage(), e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>订阅获取Providers的最新URL字符串，调用notify(…)方法，通知监听器，最终会执行如下代码：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistryDirectory</span>&lt;<span class="title">T</span>&gt; <span class="keyword"><span class="keyword">extends</span> <span class="type">AbstractDirectory</span></span>&lt;<span class="title">T</span>&gt; <span class="keyword"><span class="keyword">implements</span> <span class="type">NotifyListener</span></span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> volatile List&lt;Configurator&gt; configurators;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> volatile Map&lt;<span class="keyword">String</span>, Invoker&lt;T&gt;&gt; urlInvokerMap;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> volatile Map&lt;<span class="keyword">String</span>, List&lt;Invoker&lt;T&gt;&gt;&gt; methodInvokerMap;  </div><div class="line"></div><div class="line">    <span class="keyword">private</span> volatile Set&lt;URL&gt; cachedInvokerUrls; </div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">private</span> void refreshInvoker(List&lt;URL&gt; invokerUrls) &#123;</div><div class="line">        <span class="comment">// 从zookeeper获取到的url已经没有合适的了,在订阅返回为空时,会手动生成一个 EMPTY_PROTOCOL 的 url</span></div><div class="line">        <span class="keyword">if</span> (invokerUrls != <span class="literal">null</span> &amp;&amp; invokerUrls.size() == <span class="number">1</span> &amp;&amp; invokerUrls.<span class="keyword">get</span>(<span class="number">0</span>) != <span class="literal">null</span></div><div class="line">            &amp;&amp; Constants.EMPTY_PROTOCOL.equals(invokerUrls.<span class="keyword">get</span>(<span class="number">0</span>).getProtocol())) &#123;</div><div class="line">            <span class="built_in">this</span>.forbidden = <span class="literal">true</span>; <span class="comment">// Forbid to access</span></div><div class="line">            <span class="built_in">this</span>.methodInvokerMap = <span class="literal">null</span>; <span class="comment">// Set the method invoker map to null</span></div><div class="line">            destroyAllInvokers(); <span class="comment">// Close all invokers</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="built_in">this</span>.forbidden = <span class="literal">false</span>; <span class="comment">// Allow to access</span></div><div class="line">            Map&lt;<span class="keyword">String</span>, Invoker&lt;T&gt;&gt; oldUrlInvokerMap = <span class="built_in">this</span>.urlInvokerMap; <span class="comment">// local reference</span></div><div class="line">            <span class="keyword">if</span> (invokerUrls.isEmpty() &amp;&amp; <span class="built_in">this</span>.cachedInvokerUrls != <span class="literal">null</span>) &#123;</div><div class="line">                invokerUrls.addAll(<span class="built_in">this</span>.cachedInvokerUrls);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="built_in">this</span>.cachedInvokerUrls = <span class="keyword">new</span> <span class="type">HashSet</span>&lt;URL&gt;();</div><div class="line">                <span class="built_in">this</span>.cachedInvokerUrls.addAll(invokerUrls);<span class="comment">//Cached invoker urls, convenient for comparison</span></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (invokerUrls.isEmpty()) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            Map&lt;<span class="keyword">String</span>, Invoker&lt;T&gt;&gt; <span class="keyword">new</span><span class="type">UrlInvokerMap</span> = toInvokers(invokerUrls);<span class="comment">// Translate url list to Invoker map</span></div><div class="line">            Map&lt;<span class="keyword">String</span>, List&lt;Invoker&lt;T&gt;&gt;&gt; <span class="keyword">new</span><span class="type">MethodInvokerMap</span> = toMethodInvokers(<span class="keyword">new</span><span class="type">UrlInvokerMap</span>); <span class="comment">// Change method name to map Invoker Map</span></div><div class="line">            <span class="comment">// state change</span></div><div class="line">            <span class="comment">// If the calculation is wrong, it is not processed.</span></div><div class="line">            <span class="keyword">if</span> (<span class="keyword">new</span><span class="type">UrlInvokerMap</span> == <span class="literal">null</span> || <span class="keyword">new</span><span class="type">UrlInvokerMap</span>.size() == <span class="number">0</span>) &#123;</div><div class="line">                logger.error(<span class="keyword">new</span> <span class="type">IllegalStateException</span>(</div><div class="line">                    <span class="string">"urls to invokers error .invokerUrls.size :"</span> + invokerUrls.size() + <span class="string">", invoker.size :0. urls :"</span> + invokerUrls.toString()));</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="built_in">this</span>.methodInvokerMap = multiGroup ? toMergeMethodInvokerMap(<span class="keyword">new</span><span class="type">MethodInvokerMap</span>) : <span class="type">newMethodInvokerMap</span>;</div><div class="line">            <span class="built_in">this</span>.urlInvokerMap = <span class="keyword">new</span><span class="type">UrlInvokerMap</span>;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                destroyUnusedInvokers(oldUrlInvokerMap, <span class="keyword">new</span><span class="type">UrlInvokerMap</span>); <span class="comment">// Close the unused Invoker</span></div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                logger.warn(<span class="string">"destroyUnusedInvokers error. "</span>, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>更新Dubbo内的Invoker相关数据，保证Consumer能实时感知到Provider的信息，保证PRC调用不会出错。</p>
<p>以上就是Dubbo内Zookeeper注册中心的实现过程。</p>
<h2 id="Zookeeper的优势"><a href="#Zookeeper的优势" class="headerlink" title="Zookeeper的优势"></a>Zookeeper的优势</h2><p>1.源代码开放<br>2.已经被证实是高性能，易用稳定的工业级产品<br>3.有着广泛的应用：Hadoop、HBase、kafaka、Storm、Solr</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>「真诚赞赏，手留余香」</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/weixin.jpg" alt="杨辉 WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/zhifubao.jpg" alt="杨辉 Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/编程/" rel="tag"># 编程</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/09/20/集合框架/" rel="next" title="集合框架">
                <i class="fa fa-chevron-left"></i> 集合框架
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/01/01/留言板/" rel="prev" title="留言板">
                留言板 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/author.jpg"
               alt="杨辉" />
          <p class="site-author-name" itemprop="name">杨辉</p>
           
              <p class="site-description motion-element" itemprop="description">淡泊以明志，宁静而致远</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">52</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">24</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/hdyang12" target="_blank" title="github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  github
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://blog.csdn.net/qq619771478" title="CSDN" target="_blank">CSDN</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Zookeeper概述"><span class="nav-number">1.</span> <span class="nav-text">Zookeeper概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#背景"><span class="nav-number">1.1.</span> <span class="nav-text">背景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zookeeper是什么？"><span class="nav-number">2.</span> <span class="nav-text">Zookeeper是什么？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zookeeper的基本概念"><span class="nav-number">3.</span> <span class="nav-text">Zookeeper的基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群角色"><span class="nav-number">3.1.</span> <span class="nav-text">集群角色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#心跳检测"><span class="nav-number">3.2.</span> <span class="nav-text">心跳检测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#会话"><span class="nav-number">3.3.</span> <span class="nav-text">会话</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zookeeper安装"><span class="nav-number">4.</span> <span class="nav-text">Zookeeper安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#zookeeper结构"><span class="nav-number">5.</span> <span class="nav-text">zookeeper结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#文件系统"><span class="nav-number">5.1.</span> <span class="nav-text">文件系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通知机制"><span class="nav-number">5.2.</span> <span class="nav-text">通知机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#zookeeper-shell客户端命令简介"><span class="nav-number">6.</span> <span class="nav-text">zookeeper shell客户端命令简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ls-查看"><span class="nav-number">6.1.</span> <span class="nav-text">ls 查看</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#create-创建节点并存储数据"><span class="nav-number">6.2.</span> <span class="nav-text">create 创建节点并存储数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#get-获取内容"><span class="nav-number">6.3.</span> <span class="nav-text">get 获取内容</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#set-重新设置"><span class="nav-number">6.4.</span> <span class="nav-text">set 重新设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#delete-删除节点"><span class="nav-number">6.5.</span> <span class="nav-text">delete 删除节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其他命令"><span class="nav-number">6.6.</span> <span class="nav-text">其他命令</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Java客户端API使用"><span class="nav-number">7.</span> <span class="nav-text">Java客户端API使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zookeeper选举机制"><span class="nav-number">8.</span> <span class="nav-text">Zookeeper选举机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务器启动时期的Leader选举"><span class="nav-number">8.1.</span> <span class="nav-text">服务器启动时期的Leader选举</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#服务器运行时期的Leader选举"><span class="nav-number">8.2.</span> <span class="nav-text">服务器运行时期的Leader选举</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Leader选举算法分析"><span class="nav-number">8.3.</span> <span class="nav-text">Leader选举算法分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Leader选举实现细节"><span class="nav-number">8.4.</span> <span class="nav-text">Leader选举实现细节</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#服务器状态"><span class="nav-number">8.4.1.</span> <span class="nav-text">服务器状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#投票数据结构"><span class="nav-number">8.4.2.</span> <span class="nav-text">投票数据结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#QuorumCnxManager：网络I-O"><span class="nav-number">8.4.3.</span> <span class="nav-text">QuorumCnxManager：网络I/O</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FastLeaderElection：选举算法核心"><span class="nav-number">8.4.4.</span> <span class="nav-text">FastLeaderElection：选举算法核心</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#选票管理"><span class="nav-number">8.4.4.1.</span> <span class="nav-text">选票管理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#算法核心"><span class="nav-number">8.4.4.2.</span> <span class="nav-text">算法核心</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FastLeaderElection源码分析"><span class="nav-number">8.4.5.</span> <span class="nav-text">FastLeaderElection源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#类的继承关系"><span class="nav-number">8.4.5.1.</span> <span class="nav-text">类的继承关系</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#FastLeaderElection类的内部类"><span class="nav-number">8.4.5.2.</span> <span class="nav-text">FastLeaderElection类的内部类</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Notification类"><span class="nav-number">8.4.5.2.1.</span> <span class="nav-text">Notification类　</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ToSend类"><span class="nav-number">8.4.5.2.2.</span> <span class="nav-text">ToSend类　</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Messenger类"><span class="nav-number">8.4.5.2.3.</span> <span class="nav-text">Messenger类</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#FastLeaderElection类的属性"><span class="nav-number">8.4.5.3.</span> <span class="nav-text">FastLeaderElection类的属性</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#FastLeaderElection类的构造函数"><span class="nav-number">8.4.5.4.</span> <span class="nav-text">FastLeaderElection类的构造函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#FastLeaderElection类的核心函数分析"><span class="nav-number">8.4.5.5.</span> <span class="nav-text">FastLeaderElection类的核心函数分析</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#sendNotifications函数"><span class="nav-number">8.4.5.5.1.</span> <span class="nav-text">sendNotifications函数　</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#totalOrderPredicate函数"><span class="nav-number">8.4.5.5.2.</span> <span class="nav-text">totalOrderPredicate函数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#termPredicate函数"><span class="nav-number">8.4.5.5.3.</span> <span class="nav-text">termPredicate函数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#checkLeader函数"><span class="nav-number">8.4.5.5.4.</span> <span class="nav-text">checkLeader函数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#lookForLeader函数"><span class="nav-number">8.4.5.5.5.</span> <span class="nav-text">lookForLeader函数　　</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zookeeper的典型应用场景："><span class="nav-number">9.</span> <span class="nav-text">Zookeeper的典型应用场景：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#统一命名服务"><span class="nav-number">9.1.</span> <span class="nav-text">统一命名服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置管理"><span class="nav-number">9.2.</span> <span class="nav-text">配置管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群管理"><span class="nav-number">9.3.</span> <span class="nav-text">集群管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#共享锁"><span class="nav-number">9.4.</span> <span class="nav-text">共享锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#负载均衡"><span class="nav-number">9.5.</span> <span class="nav-text">负载均衡</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式通知-协调"><span class="nav-number">9.6.</span> <span class="nav-text">分布式通知/协调</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实际应用"><span class="nav-number">9.7.</span> <span class="nav-text">实际应用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Zookeeper实现Dubbo注册中心"><span class="nav-number">9.7.1.</span> <span class="nav-text">Zookeeper实现Dubbo注册中心</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Zookeeper的优势"><span class="nav-number">10.</span> <span class="nav-text">Zookeeper的优势</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">杨辉</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

<br/>
<div class="powered-by">
<span id="busuanzi_container_site_uv"> 
  本站访客数 <span id="busuanzi_value_site_uv"></span> 人
</span>
</div>
<span id="busuanzi_container_site_pv"> 
  本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
</span>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "4e23027f183547059b04893d59788da5",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  










  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("WVkl2iB2BaJcwxurjLC9hGFS-gzGzoHsz", "MAp4EhLfpT7JJAODisjq2rSh");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  

  

  

  <script type="text/javascript">  
	function IsPC() {
		var userAgentInfo = navigator.userAgent;
		var Agents = ["Android", "iPhone",
					"SymbianOS", "Windows Phone",
					"iPad", "iPod"];
		var flag = true;
		for (var v = 0; v < Agents.length; v++) {
			if (userAgentInfo.indexOf(Agents[v]) > 0) {
				flag = false;
				break;
			}
		}
		return flag;
	} 
  
var scriptNode = document.createElement("script"); 
scriptNode.setAttribute("type", "text/javascript");  
<!-- 背景动画  
if(IsPC()){  
	 
    scriptNode.setAttribute("src", "/js/src/particle.js");  
} -->
 
document.head.appendChild(scriptNode); 
</script>
</body>
<!-- 背景动画
<script type="text/javascript" src="/js/src/particle.js"></script> -->
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>
</html>
